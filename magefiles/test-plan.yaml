id: test-mage-reset-lifecycle
title: Mage init/reset target isolation and orchestration
traces:
  - eng02-generation-workflow

preconditions:
  - On main branch with clean working tree
  - bd CLI available on PATH
  - mage available (go/bin/mage or PATH)
  - podman available on PATH with configured image
  - configuration.yaml present at repository root

test_cases:

  # ── 1. Individual reset targets (independence) ──

  - name: cobbler:reset only removes .cobbler/
    inputs:
      setup:
        - mkdir -p .cobbler && echo test > .cobbler/dummy.json
        - mage beads:init
      command: mage cobbler:reset
    expected:
      exit_code: 0
      state:
        cobbler_dir_exists: false
        beads_dir_exists: true
        generation_branches: unchanged

  - name: beads:reset only touches .beads/
    inputs:
      setup:
        - mage beads:init
        - mkdir -p .cobbler && echo test > .cobbler/dummy.json
      command: mage beads:reset
    expected:
      exit_code: 0
      state:
        beads_dir_exists: true
        beads_issues_empty: true
        cobbler_file_exists: true

  - name: beads:reset does not resurrect issues
    inputs:
      setup:
        - mage beads:init
        - bd create --type task --json "Dummy task" --description "Should not survive reset"
        - bd list --json
      command: mage beads:reset
    expected:
      exit_code: 0
      state:
        beads_issues_empty: true
      stdout_not_contains: "Dummy task"

  - name: generator:reset only touches branches and Go sources
    inputs:
      setup:
        - mage generator:start
        - mkdir -p .cobbler && echo test > .cobbler/dummy.json
      command: mage generator:reset
    expected:
      exit_code: 0
      state:
        current_branch: main
        generation_branches: none
        go_sources_seeded: true
        cobbler_file_exists: true

  # ── 2. Top-level orchestrators ──

  - name: init is idempotent
    inputs:
      setup:
        - rm -rf .beads/
      commands:
        - mage init
        - mage init
    expected:
      exit_code: 0
      state:
        beads_dir_exists: true
      stdout_contains: "already initialized"

  - name: init creates beads from scratch
    inputs:
      setup:
        - rm -rf .beads/
      command: mage init
    expected:
      exit_code: 0
      state:
        beads_dir_exists: true

  - name: reset wipes all artifact types
    inputs:
      setup:
        - mage generator:start
        - mkdir -p .cobbler && echo test > .cobbler/dummy.json
      command: mage reset
    expected:
      exit_code: 0
      state:
        cobbler_dir_exists: false
        current_branch: main
        generation_branches: none
        go_sources_seeded: true
        beads_dir_exists: true
        beads_issues_empty: true

  - name: reset calls cobbler, generator, beads in order
    description: >
      FullReset calls CobblerReset, GeneratorReset, and BeadsReset
      sequentially. Verify the git log shows the generator commit
      before the beads commit.
    inputs:
      setup:
        - mage generator:start
      command: mage reset
    expected:
      exit_code: 0
      git_log_order:
        - "Reset beads"
        - "Generator reset"

  # ── 3. Edge cases ──

  - name: cobbler:reset when .cobbler/ does not exist
    inputs:
      setup:
        - rm -rf .cobbler/
      command: mage cobbler:reset
    expected:
      exit_code: 0

  - name: beads:reset when .beads/ does not exist
    inputs:
      setup:
        - rm -rf .beads/
      command: mage beads:reset
    expected:
      exit_code: 0

  - name: generator:reset when already on main with no branches
    inputs:
      setup: []
      command: mage generator:reset
    expected:
      exit_code: 0
      state:
        current_branch: main
        go_sources_seeded: true

  - name: reset from fully clean state
    inputs:
      setup:
        - rm -rf .cobbler/ .beads/
      command: mage reset
    expected:
      exit_code: 0

  # ── 4. Build and test targets ──

  - name: build compiles binary
    inputs:
      command: mage build
    expected:
      exit_code: 0
      state:
        binary_exists: bin/cupboard

  - name: lint passes on clean codebase
    inputs:
      command: mage lint
    expected:
      exit_code: 0

  - name: test:unit runs without test files
    inputs:
      command: mage test:unit
    expected:
      exit_code: 0
      stdout_contains: "no test files"

  - name: test:integration skips when tests/ directory is missing
    inputs:
      setup:
        - rm -rf tests/
      command: mage test:integration
    expected:
      exit_code: 0
      stdout_contains: "No integration test directory found"

  - name: test:all succeeds with no test files
    inputs:
      command: mage test:all
    expected:
      exit_code: 0

  - name: install copies binary to GOPATH/bin
    inputs:
      command: mage install
    expected:
      exit_code: 0

  - name: clean removes build artifacts
    inputs:
      setup:
        - mage build
      command: mage clean
    expected:
      exit_code: 0
      state:
        binary_exists: false

  - name: stats outputs JSON with expected fields
    description: >
      The library StatsRecord uses spec_words as a map keyed by the
      labels defined in configuration.yaml spec_globs.
    inputs:
      command: mage stats
    expected:
      exit_code: 0
      stdout_json:
        go_loc: integer
        go_loc_prod: integer
        go_loc_test: integer
        spec_words:
          prd: integer
          use_case: integer
          test_suite: integer

  # ── 5. Cobbler integration (requires Claude + podman) ──

  - name: cobbler:measure creates issues and reset clears them
    description: >
      End-to-end: measure proposes issues (max_issues from config),
      verify they exist in beads, then reset beads and verify they
      are gone. Confirms the full measure-to-reset lifecycle.
      Set max_issues=1 in configuration.yaml before running.
    inputs:
      setup:
        - mage beads:init
        - "Set max_issues: 1 in configuration.yaml"
      commands:
        - mage cobbler:measure
        - bd list --json
      command: mage beads:reset
    expected:
      after_measure:
        bd_list_json_length: ">= 1"
      after_reset:
        exit_code: 0
        bd_list_json_length: 0
        state:
          beads_issues_empty: true

  - name: test:cobbler runs the full cobbler regression suite
    description: >
      The mage test:cobbler target creates an orchestrator with
      config overrides (max_issues=3, silence=true), measures 3
      issues, stitches them, and verifies all are closed with no
      stale branches. This replaces the manual cobbler integration
      test.
    inputs:
      command: mage test:cobbler
    expected:
      exit_code: 0
      stdout_contains: "Cobbler regression test PASSED"

  # ── 6. Generator lifecycle (no Claude) ──

  - name: "start/stop: creates tags and returns to main"
    description: >
      Simplest generator lifecycle. Start creates a generation branch
      and a -start tag. Stop tags -finished, merges into main, tags
      -merged, and deletes the generation branch. No run in between.
    inputs:
      setup:
        - mage reset
      commands:
        - mage generator:start
        - "BRANCH=$(git rev-parse --abbrev-ref HEAD)"
        - mage generator:stop
    expected:
      after_start:
        current_branch: "generation-*"
        tag_exists: "<branch>-start"
      after_stop:
        exit_code: 0
        current_branch: main
        generation_branches: none
        tags_exist:
          - "<branch>-finished"
          - "<branch>-merged"

  - name: "start/stop: generator:list shows merged generation"
    inputs:
      setup:
        - mage reset
      commands:
        - mage generator:start
        - mage generator:stop
        - mage generator:list
    expected:
      exit_code: 0
      stdout_contains: "tags: start, finished, merged"

  # ── 7. Generator run (requires Claude + podman) ──

  - name: test:generator runs the full generator lifecycle suite
    description: >
      The mage test:generator target runs three progressive tests:
      (1) start/stop with no Claude, (2) start/run(1 cycle, 1 issue)/stop,
      and (3) stitch respects max-issues limit. Config overrides are
      applied in Go code (silence=true, max_issues=1-2, cycles=1).
      This replaces the manual generator run tests.
    inputs:
      command: mage test:generator
    expected:
      exit_code: 0
      stdout_contains: "Generator lifecycle tests PASSED"

  # ── 8. Generator resume (requires Claude + podman) ──

  - name: test:resume runs the resume recovery test
    description: >
      The mage test:resume target creates a generation, measures 1 issue,
      switches to main (simulating an interruption), then calls resume.
      Resume should switch back, clean up, and stitch the pending issue.
      Config overrides are applied in Go code.
    inputs:
      command: mage test:resume
    expected:
      exit_code: 0
      stdout_contains: "Generator resume test PASSED"

  - name: "resume auto-detects generation branch"
    description: >
      When only one generation branch exists and the user is on main,
      resume should auto-detect it without requiring generation_branch
      in configuration.yaml. Set max_issues=1 and cycles=1 in
      configuration.yaml before running.
    inputs:
      setup:
        - mage reset
        - mage generator:start
        - "Set max_issues: 1 and cycles: 1 in configuration.yaml"
        - mage generator:switch
    expected:
      exit_code: 0
      current_branch: "generation-*"

cleanup:
  - mage reset
