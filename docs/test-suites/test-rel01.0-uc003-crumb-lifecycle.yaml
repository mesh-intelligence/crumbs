id: test-rel01.0-uc003-crumb-lifecycle
title: Crumb entity state machine and archival
description: >
  Validates the crumb state machine (draft→pending→ready→taken→pebble and any→dust),
  timestamp behavior on state transitions, state-based filtering, and crumb archival.
  Covers Crumb entity methods SetState, Pebble, Dust.
traces:
  - rel01.0-uc003-crumb-lifecycle
tags:
  - cli
  - integration
  - state-machine

preconditions:
  - Cupboard binary built from cmd/cupboard
  - Fresh temp directory for config and data
  - Config file points SQLite backend at the temp data directory
  - No existing crumbs

test_cases:

  # --- S1: New crumb starts in draft state with timestamps ---

  - name: Create crumb with draft state and initialized timestamps
    description: New crumb defaults to draft state with CreatedAt, UpdatedAt, and Properties initialized.
    inputs:
      command: cupboard set crumbs "" '{"Name":"New crumb"}'
    expected:
      exit_code: 0
      stdout_contains: "CrumbID"
      state:
        crumb_state: draft
        created_at_set: true
        updated_at_set: true

  - name: New crumb has Properties map initialized
    description: Verify the Properties map is not null on a new crumb.
    inputs:
      command: cupboard set crumbs "" '{"Name":"Crumb with props"}'
    expected:
      exit_code: 0
      state:
        crumb_state: draft
        properties_initialized: true

  # --- S2: SetState(pending) transitions draft to pending ---

  - name: Transition crumb from draft to pending
    description: Create a crumb in draft, then update to pending state.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Pending crumb"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Pending crumb","State":"pending"}'
    expected:
      exit_code: 0
      state:
        crumb_state: pending

  # --- S3: SetState(ready) transitions pending to ready ---

  - name: Transition crumb from pending to ready
    description: Create a crumb, move to pending, then to ready state.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Ready crumb","State":"pending"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Ready crumb","State":"ready"}'
    expected:
      exit_code: 0
      state:
        crumb_state: ready

  - name: Transition crumb from draft to ready
    description: Create a crumb in draft, then update to ready state.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Ready crumb","State":"draft"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Ready crumb","State":"ready"}'
    expected:
      exit_code: 0
      state:
        crumb_state: ready

  # --- S4: SetState(taken) transitions ready to taken ---

  - name: Transition crumb from ready to taken
    description: Create a crumb, move to ready, then claim it (taken).
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Taken crumb","State":"ready"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Taken crumb","State":"taken"}'
    expected:
      exit_code: 0
      state:
        crumb_state: taken

  # --- S5: Pebble() transitions taken to pebble (terminal) ---

  - name: Transition crumb to pebble (completed successfully)
    description: Move a crumb from taken to terminal pebble state (completed).
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Pebble crumb","State":"taken"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Pebble crumb","State":"pebble"}'
    expected:
      exit_code: 0
      state:
        crumb_state: pebble

  # --- S6: Dust() transitions draft to dust (terminal) ---

  - name: Transition crumb from draft to dust
    description: Move a crumb from draft to terminal dust state (failed/abandoned).
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Dust crumb","State":"draft"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Dust crumb","State":"dust"}'
    expected:
      exit_code: 0
      state:
        crumb_state: dust

  # --- S7: Dust() works from any non-terminal state ---

  - name: Transition crumb from pending to dust
    description: Verify dust transition works from pending state.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Dust from pending","State":"pending"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Dust from pending","State":"dust"}'
    expected:
      exit_code: 0
      state:
        crumb_state: dust

  - name: Transition crumb from ready to dust
    description: Verify dust transition works from ready state.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Dust from ready","State":"ready"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Dust from ready","State":"dust"}'
    expected:
      exit_code: 0
      state:
        crumb_state: dust

  - name: Transition crumb from taken to dust
    description: Verify dust transition works from taken state.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Dust from taken","State":"taken"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Dust from taken","State":"dust"}'
    expected:
      exit_code: 0
      state:
        crumb_state: dust

  # --- S8: UpdatedAt advances on each transition; CreatedAt stays constant ---

  - name: UpdatedAt advances on state transition
    description: Verify UpdatedAt changes when state transitions; CreatedAt remains constant.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Timestamp crumb"}'
      steps:
        - cupboard get crumbs ${crumb_id}
        - sleep 0.01
        - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Timestamp crumb","State":"ready"}'
        - cupboard get crumbs ${crumb_id}
    expected:
      exit_code: 0
      state:
        created_at_unchanged: true
        updated_at_advanced: true

  - name: Multiple state transitions track UpdatedAt
    description: Each state transition should advance UpdatedAt while CreatedAt remains constant.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Multi transition crumb"}'
      steps:
        - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Multi transition crumb","State":"pending"}'
        - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Multi transition crumb","State":"ready"}'
        - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Multi transition crumb","State":"taken"}'
        - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Multi transition crumb","State":"pebble"}'
    expected:
      exit_code: 0
      state:
        crumb_state: pebble
        created_at_unchanged: true
        updated_at_advanced: true

  # --- S9: Fetch by state returns only crumbs in the requested state ---

  - name: Fetch by state returns matching crumbs only
    description: Listing by a specific state returns only crumbs in that state.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Draft crumb","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Ready crumb","State":"ready"}'
        - cupboard set crumbs "" '{"Name":"Taken crumb","State":"taken"}'
      command: cupboard list crumbs State=ready
    expected:
      exit_code: 0
      stdout_json:
        length: 1
        contains_name: "Ready crumb"

  - name: Fetch by multiple states
    description: Listing by multiple states returns crumbs in any of those states.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Draft crumb","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Ready crumb","State":"ready"}'
        - cupboard set crumbs "" '{"Name":"Taken crumb","State":"taken"}'
      command: cupboard list crumbs State=draft,ready
    expected:
      exit_code: 0
      stdout_json:
        length: 2

  # --- S10: Fetch excludes pebble and dust when filtering for non-terminal states ---

  - name: Filter excludes pebble crumbs from non-terminal state list
    description: Listing by state=draft excludes pebble crumbs.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Active crumb","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Completed crumb","State":"pebble"}'
      command: cupboard list crumbs State=draft
    expected:
      exit_code: 0
      stdout_json:
        length: 1
        contains_name: "Active crumb"

  - name: Filter excludes dust crumbs from non-terminal state list
    description: Listing by state=draft excludes dust crumbs.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Active crumb","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Archived crumb","State":"dust"}'
      command: cupboard list crumbs State=draft
    expected:
      exit_code: 0
      stdout_json:
        length: 1
        contains_name: "Active crumb"

  - name: Filter for pebble state returns only pebble crumbs
    description: Listing by state=pebble returns only completed crumbs.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Draft crumb","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Pebble crumb","State":"pebble"}'
        - cupboard set crumbs "" '{"Name":"Dust crumb","State":"dust"}'
      command: cupboard list crumbs State=pebble
    expected:
      exit_code: 0
      stdout_json:
        length: 1
        contains_name: "Pebble crumb"

  - name: Filter for dust state returns only dust crumbs
    description: Listing by state=dust returns only archived crumbs.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Draft crumb","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Pebble crumb","State":"pebble"}'
        - cupboard set crumbs "" '{"Name":"Dust crumb","State":"dust"}'
      command: cupboard list crumbs State=dust
    expected:
      exit_code: 0
      stdout_json:
        length: 1
        contains_name: "Dust crumb"

  # --- S11: Properties map is initialized on creation (covered above) ---

  # --- full state machine workflow ---

  - name: Full success path draft to pebble
    description: >
      Exercise the complete success path: draft → pending → ready → taken → pebble.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Success path crumb"}'
      steps:
        - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Success path crumb","State":"pending"}'
        - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Success path crumb","State":"ready"}'
        - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Success path crumb","State":"taken"}'
        - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Success path crumb","State":"pebble"}'
    expected:
      exit_code: 0
      state:
        crumb_state: pebble

  - name: Full failure path draft to dust
    description: >
      Exercise the failure path: draft → dust.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Failure path crumb"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Failure path crumb","State":"dust"}'
    expected:
      exit_code: 0
      state:
        crumb_state: dust

  - name: Mixed terminal states in same table
    description: >
      Create multiple crumbs with different terminal states and verify correct filtering.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Draft crumb","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Pebble crumb","State":"pebble"}'
        - cupboard set crumbs "" '{"Name":"Dust crumb","State":"dust"}'
    expected:
      exit_code: 0
      state:
        total_crumb_count: 3
        draft_count: 1
        pebble_count: 1
        dust_count: 1

cleanup:
  - Remove temp config and data directories
