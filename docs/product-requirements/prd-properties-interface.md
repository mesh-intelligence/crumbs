# PRD: Properties Interface

## Problem

Applications need extensible attributes on crumbs beyond the core fields (name, state, timestamps). A task tracker might need priority, labels, and owner; a bug tracker might need severity and component. Hardcoding these fields into the Crumb struct creates rigid schemas that require code changes and migrations for every new attribute.

We need a property system where applications can define custom attributes at runtime. Properties are metadata definitions (name, type, description) that can then be assigned values on individual crumbs. This separates schema (what properties exist) from data (what values crumbs have), enabling flexibility without migrations.

This PRD defines the PropertyTable interface: the Property and Category structs, definition operations, and built-in properties. Setting and getting property values on crumbs is handled by CrumbTable (see prd-crumbs-interface); this PRD covers only the property definitions themselves.

## Goals

1. Define the Property struct with all required fields
2. Define the Category struct for categorical properties
3. Define value types and their meaning
4. Specify Define operation for creating property definitions
5. Specify Get and List operations for retrieving definitions
6. Specify DefineCategory operation for categorical property options
7. Document built-in properties seeded on first startup
8. Document error conditions for all operations

## Requirements

### R1: Property Struct

1.1. The Property struct must include these fields:

| Field | Type | Description |
|-------|------|-------------|
| PropertyID | string | UUID v7, generated on creation |
| Name | string | Unique human-readable name (e.g., "priority", "labels") |
| Description | string | Optional explanation of the property's purpose |
| ValueType | string | Type of values this property accepts (see R3) |
| CreatedAt | time.Time | Timestamp of creation |

1.2. PropertyID must be a UUID v7 (time-ordered) generated by the backend on Define.

1.3. Name must be unique across all properties. Define must reject duplicate names with ErrDuplicateName.

1.4. Name must be non-empty. Define must reject empty names with ErrInvalidName.

1.5. Description may be empty.

### R2: Category Struct

2.1. The Category struct must include these fields:

| Field | Type | Description |
|-------|------|-------------|
| CategoryID | string | UUID v7, generated on creation |
| PropertyID | string | The categorical property this category belongs to |
| Name | string | Display name for this category (e.g., "high", "medium") |
| Ordinal | int | Sort order; lower ordinals sort first |

2.2. CategoryID must be a UUID v7 (time-ordered) generated by the backend on DefineCategory.

2.3. Categories enable ordered enumeration for categorical properties. When a crumb has a categorical property value, the value is a CategoryID.

2.4. Name must be unique within a property. DefineCategory must reject duplicate names for the same property with ErrDuplicateName.

2.5. Ordinal determines display order. Categories with lower ordinals appear first. Multiple categories may share the same ordinal (ties broken by name).

### R3: Value Types

3.1. A property must have exactly one of these value types:

| ValueType | Go Type | JSON Type | Description |
|-----------|---------|-----------|-------------|
| categorical | string | string | CategoryID from the property's categories |
| text | string | string | Free-form text |
| integer | int64 | number | Whole number |
| boolean | bool | boolean | True or false |
| timestamp | time.Time | string | RFC 3339 timestamp |
| list | []string | array | List of strings (e.g., labels, tags) |

3.2. ValueType is stored as a string, not an enum, for JSON compatibility.

3.3. CrumbTable.SetProperty validates that values match the property's ValueType (see prd-crumbs-interface R9).

3.4. For categorical properties, values must be valid CategoryIDs defined for that property.

### R4: Define Operation

4.1. Define creates a new property definition:

```go
func (t PropertyTable) Define(name, description, valueType string) (*Property, error)
```

4.2. Define must generate a UUID v7 for PropertyID.

4.3. Define must set CreatedAt to the current time.

4.4. Define must validate that name is non-empty (ErrInvalidName if empty).

4.5. Define must validate that name is unique (ErrDuplicateName if exists).

4.6. Define must validate that valueType is one of the valid types in R3.1 (ErrInvalidValueType if not).

4.7. Define must persist the property before returning.

4.8. Define must return the created Property with all fields populated.

### R5: Get Operation

5.1. Get retrieves a property definition by ID:

```go
func (t PropertyTable) Get(id string) (*Property, error)
```

5.2. Get must return the Property if found.

5.3. Get must return ErrNotFound if no property exists with the given ID.

5.4. Get must return ErrInvalidID if id is empty.

### R6: List Operation

6.1. List retrieves all property definitions:

```go
func (t PropertyTable) List() ([]*Property, error)
```

6.2. List must return all properties, including built-in properties.

6.3. List must return an empty slice (not nil) if no properties exist.

6.4. Results are ordered by CreatedAt ascending (oldest first, built-ins first).

### R7: DefineCategory Operation

7.1. DefineCategory creates a category for a categorical property:

```go
func (t PropertyTable) DefineCategory(propertyID, name string, ordinal int) (*Category, error)
```

7.2. DefineCategory must generate a UUID v7 for CategoryID.

7.3. DefineCategory must validate that the property exists (ErrNotFound if not).

7.4. DefineCategory must validate that the property's ValueType is "categorical" (ErrInvalidValueType if not).

7.5. DefineCategory must validate that name is non-empty (ErrInvalidName if empty).

7.6. DefineCategory must validate that name is unique within the property (ErrDuplicateName if exists).

7.7. DefineCategory must persist the category before returning.

7.8. DefineCategory must return the created Category with all fields populated.

7.9. Ordinal may be any integer. Negative ordinals are allowed.

### R8: Built-in Properties

8.1. On first startup (when properties storage is empty), the backend must seed these built-in properties:

| Name | ValueType | Description |
|------|-----------|-------------|
| priority | categorical | Task priority level |
| type | categorical | Crumb type classification |
| description | text | Detailed description |
| owner | text | Assigned worker or user ID |
| labels | list | Capability tags or labels |
| dependencies | list | Crumb IDs that must complete first |

8.2. Built-in categories for "priority" property:

| Name | Ordinal |
|------|---------|
| highest | 0 |
| high | 1 |
| medium | 2 |
| low | 3 |
| lowest | 4 |

8.3. Built-in categories for "type" property:

| Name | Ordinal |
|------|---------|
| task | 0 |
| epic | 1 |
| bug | 2 |
| chore | 3 |

8.4. Seeding only occurs when the properties storage is empty (first run). Existing data is never modified by seeding.

8.5. Built-in properties can be extended (new categories added) but not deleted or renamed.

8.6. Applications may define additional properties beyond the built-ins.

### R9: Error Types

9.1. PropertyTable operations must return these sentinel errors:

| Error | When |
|-------|------|
| ErrNotFound | Property or category ID does not exist |
| ErrInvalidID | ID is empty |
| ErrInvalidName | Name is empty |
| ErrDuplicateName | Name already exists (property or category within property) |
| ErrInvalidValueType | ValueType is not recognized or operation invalid for type |
| ErrCupboardClosed | Cupboard has been closed |

9.2. All errors must be checkable with errors.Is.

### R10: Category Queries

10.1. Retrieving categories for a property is done via the property ID. The backend must provide a way to list categories for a given property.

10.2. Categories are ordered by ordinal ascending, then name ascending for ties.

10.3. Implementation note: The PropertyTable interface in prd-cupboard-core does not include a ListCategories operation. Backends may expose this via direct query or extend the interface. For now, categories can be queried via the links table or a backend-specific method.

## Non-Goals

1. This PRD does not define setting or getting property values on crumbs. See prd-crumbs-interface for SetProperty, GetProperty, GetProperties, and ClearProperty.

2. This PRD does not define property deletion. Properties are permanent once defined. Applications can stop using a property but cannot remove its definition.

3. This PRD does not define property modification (renaming, changing type). Properties are immutable after creation.

4. This PRD does not define property inheritance or computed properties.

5. This PRD does not define validation rules beyond type checking (e.g., regex patterns, min/max values).

## Acceptance Criteria

- [ ] Property struct defined with PropertyID, Name, Description, ValueType, CreatedAt
- [ ] Category struct defined with CategoryID, PropertyID, Name, Ordinal
- [ ] Value types documented (categorical, text, integer, boolean, timestamp, list)
- [ ] Define operation specified (create property, validate name/type)
- [ ] Get operation specified (retrieve by ID, error handling)
- [ ] List operation specified (retrieve all properties)
- [ ] DefineCategory operation specified (create category for categorical property)
- [ ] Built-in properties listed (priority, type, description, owner, labels, dependencies)
- [ ] Built-in categories listed for priority and type
- [ ] Error types documented
- [ ] All requirements numbered and specific
- [ ] File saved at docs/product-requirements/prd-properties-interface.md

## Constraints

- PropertyID and CategoryID use UUID v7 for time-ordering and uniqueness
- ValueType is a string for JSON serialization (not a Go enum)
- All timestamps use time.Time (RFC 3339 in JSON)
- Property names must be unique across the entire cupboard
- Category names must be unique within their property
- Properties and categories are immutable after creation

## References

- prd-cupboard-core (Cupboard interface, PropertyTable accessor)
- prd-sqlite-backend (JSON format, SQLite schema, built-in property seeding)
- prd-crumbs-interface (SetProperty, GetProperty, GetProperties, ClearProperty)
