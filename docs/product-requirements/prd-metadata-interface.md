# PRD: Metadata Interface

## Problem

Applications need to attach supplementary information to crumbs beyond structured properties. A developer might add comments during work, attach log files for debugging, or link to external resources. Properties handle typed, single-value attributes; metadata handles unstructured, multi-value content like comments, attachments, and activity logs.

Hardcoding metadata types (comments table, attachments table) creates rigid schemas. Applications should be able to define new metadata types at runtime without code changes. A plugin might add "reviews" or "time_entries" as new metadata types.

We need a metadata system that stores arbitrary content associated with crumbs, supports multiple entries per crumb, and allows applications to define new metadata types dynamically. This PRD defines the MetadataTable interface: the Metadata and Schema structs, registration, storage, and search operations.

## Goals

1. Define the Metadata struct with all required fields
2. Define the Schema struct for custom metadata table definitions
3. Specify Register operation for defining new metadata types
4. Specify Add operation for creating metadata entries
5. Specify Get operation for retrieving metadata by crumb
6. Specify Search operation with filtering capabilities
7. Document built-in metadata tables (comments, attachments)
8. Document error conditions for all operations

## Requirements

### R1: Metadata Struct

1.1. The Metadata struct must include these fields:

| Field | Type | Description |
|-------|------|-------------|
| MetadataID | string | UUID v7, generated on creation |
| TableName | string | The metadata table this entry belongs to (e.g., "comments") |
| CrumbID | string | The crumb this metadata is attached to |
| PropertyID | *string | Optional property ID for property-specific metadata |
| Content | string | The metadata content (text or JSON) |
| CreatedAt | time.Time | Timestamp of creation |

1.2. MetadataID must be a UUID v7 (time-ordered) generated by the backend on Add.

1.3. TableName identifies which metadata table the entry belongs to. Only registered table names are valid.

1.4. CrumbID links the metadata to a specific crumb. The crumb must exist.

1.5. PropertyID is optional. When set, the metadata is associated with a specific property on the crumb (e.g., a comment about the priority value).

1.6. Content stores the actual metadata. For simple metadata like comments, this is plain text. For structured metadata, this may be JSON.

### R2: Schema Struct

2.1. The Schema struct defines the structure of a custom metadata table:

| Field | Type | Description |
|-------|------|-------------|
| TableName | string | Unique name for this metadata table |
| Description | string | Optional explanation of the table's purpose |
| ContentType | string | Expected content format: "text" or "json" |

2.2. TableName must be unique across all metadata tables. Register rejects duplicates with ErrDuplicateName.

2.3. TableName must be non-empty and contain only lowercase letters, numbers, and underscores. Register rejects invalid names with ErrInvalidName.

2.4. ContentType hints at how Content should be interpreted. "text" means plain text; "json" means JSON-formatted content. The backend does not validate content against this type; it is advisory.

2.5. Schema is intentionally minimal. The metadata system stores flexible content; schema describes intent, not strict structure.

### R3: MetadataFilter Struct

3.1. The MetadataFilter struct specifies search criteria:

| Field | Type | Description |
|-------|------|-------------|
| CrumbID | *string | Filter by crumb (nil for all crumbs) |
| PropertyID | *string | Filter by property (nil for all properties) |
| ContentContains | *string | Filter by text content (substring match) |
| Limit | int | Maximum results (0 for no limit) |
| Offset | int | Skip this many results |

3.2. All filter fields are optional (nil or zero value means no filter on that field).

3.3. Multiple filter fields are ANDed: entries must match all specified criteria.

3.4. ContentContains performs case-insensitive substring matching on the Content field.

### R4: Register Operation

4.1. Register defines a new metadata table type:

```go
func (t MetadataTable) Register(tableName string, schema Schema) error
```

4.2. Register must validate that tableName matches schema.TableName (ErrInvalidName if mismatch).

4.3. Register must validate that tableName is non-empty and valid format (ErrInvalidName if not).

4.4. Register must validate that tableName is unique (ErrDuplicateName if exists).

4.5. Register must persist the schema before returning.

4.6. Register does not return the schema; it returns only an error or nil.

4.7. Built-in tables (comments, attachments) are pre-registered and cannot be re-registered.

### R5: Add Operation

5.1. Add creates a new metadata entry:

```go
func (t MetadataTable) Add(tableName, crumbID string, content string, propertyID *string) (*Metadata, error)
```

5.2. Add must generate a UUID v7 for MetadataID.

5.3. Add must set CreatedAt to the current time.

5.4. Add must validate that tableName is registered (ErrTableNotFound if not).

5.5. Add must validate that crumbID references an existing crumb (ErrNotFound if not).

5.6. If propertyID is provided, Add must validate that the property exists (ErrPropertyNotFound if not).

5.7. Add must validate that content is non-empty (ErrInvalidContent if empty).

5.8. Add must persist the metadata entry before returning.

5.9. Add must return the created Metadata with all fields populated.

5.10. Multiple metadata entries can be added to the same crumb for the same table. Comments are additive, not replacements.

### R6: Get Operation

6.1. Get retrieves all metadata entries for a crumb from a specific table:

```go
func (t MetadataTable) Get(tableName, crumbID string) ([]*Metadata, error)
```

6.2. Get must return all metadata entries matching the table and crumb.

6.3. Get must return an empty slice (not nil) if no entries exist.

6.4. Get must return ErrTableNotFound if tableName is not registered.

6.5. Get must return ErrNotFound if crumbID does not reference an existing crumb.

6.6. Get must return ErrInvalidID if crumbID is empty.

6.7. Results are ordered by CreatedAt ascending (oldest first).

### R7: Search Operation

7.1. Search queries metadata entries with filtering:

```go
func (t MetadataTable) Search(tableName string, filter MetadataFilter) ([]*Metadata, error)
```

7.2. Search must return all entries in the table matching the filter criteria.

7.3. Search must return an empty slice (not nil) if no entries match.

7.4. Search must return ErrTableNotFound if tableName is not registered.

7.5. Search must apply Limit and Offset after filtering and ordering.

7.6. Results are ordered by CreatedAt descending (newest first) for search results.

7.7. An empty filter (all nil/zero fields) returns all entries in the table (subject to Limit).

### R8: Built-in Tables

8.1. The backend must pre-register these built-in metadata tables on startup:

| TableName | ContentType | Description |
|-----------|-------------|-------------|
| comments | text | User comments and notes on crumbs |
| attachments | json | File attachments with name, path, and mime type |

8.2. Built-in tables are always available; applications do not need to register them.

8.3. Built-in tables cannot be unregistered or modified.

8.4. Comments table stores plain text comments. Each Add creates a new comment entry.

8.5. Attachments table stores JSON objects describing file attachments:

```json
{
  "name": "screenshot.png",
  "path": "/attachments/01945a3f.png",
  "mime_type": "image/png",
  "size_bytes": 102400
}
```

8.6. The attachments schema is advisory; the backend stores the JSON as-is without validation.

### R9: Error Types

9.1. MetadataTable operations must return these sentinel errors:

| Error | When |
|-------|------|
| ErrNotFound | Crumb ID does not exist |
| ErrInvalidID | Crumb ID is empty |
| ErrTableNotFound | Metadata table is not registered |
| ErrDuplicateName | Table name already exists (on Register) |
| ErrInvalidName | Table name is empty or invalid format |
| ErrInvalidContent | Content is empty |
| ErrPropertyNotFound | Property ID does not exist |
| ErrCupboardClosed | Cupboard has been closed |

9.2. All errors must be checkable with errors.Is.

### R10: Metadata Lifecycle

10.1. Metadata entries are permanent once created. There is no Update or Delete operation.

10.2. When a crumb is purged (hard delete), all its metadata entries are also deleted.

10.3. Metadata entries cannot be moved between crumbs.

10.4. Metadata tables cannot be unregistered once registered.

## Non-Goals

1. This PRD does not define crumb operations. See prd-crumbs-interface.

2. This PRD does not define property definitions. See prd-properties-interface.

3. This PRD does not define metadata deletion or updates. Metadata entries are append-only.

4. This PRD does not define file storage for attachments. The attachments table stores references; actual file handling is outside this scope.

5. This PRD does not define full-text search indexing. ContentContains is substring matching, not ranked search.

6. This PRD does not define schema enforcement. ContentType is advisory; content is stored as-is.

## Acceptance Criteria

- [ ] Metadata struct defined with MetadataID, TableName, CrumbID, PropertyID, Content, CreatedAt
- [ ] Schema struct defined with TableName, Description, ContentType
- [ ] MetadataFilter struct defined with CrumbID, PropertyID, ContentContains, Limit, Offset
- [ ] Register operation specified (create metadata table type)
- [ ] Add operation specified (create metadata entry)
- [ ] Get operation specified (retrieve by table and crumb)
- [ ] Search operation specified (query with filter)
- [ ] Built-in tables documented (comments, attachments)
- [ ] Error types documented
- [ ] All requirements numbered and specific
- [ ] File saved at docs/product-requirements/prd-metadata-interface.md

## Constraints

- MetadataID uses UUID v7 for time-ordering and uniqueness
- TableName must be lowercase with underscores only
- Content is stored as text; JSON content is not parsed or validated
- All timestamps use time.Time (RFC 3339 in JSON)
- Metadata entries are append-only (no update or delete)

## References

- prd-cupboard-core (Cupboard interface, MetadataTable accessor)
- prd-sqlite-backend (JSON format, SQLite schema for metadata)
- prd-crumbs-interface (Crumb struct, Purge operation that deletes metadata)
- prd-properties-interface (Property definitions for property-linked metadata)
