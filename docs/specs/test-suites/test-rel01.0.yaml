id: test-rel01.0
title: Core Storage with SQLite Backend
release: '01.0'
traces:
- rel01.0-uc001-cupboard-lifecycle
- rel01.0-uc002-table-crud
- rel01.0-uc003-crumb-lifecycle
- rel01.0-uc004-scaffolding-validation
- prd001-cupboard-core R2
- prd001-cupboard-core R2.5
- rel01.0-uc005-crumbs-table-benchmarks
preconditions: |-
  Cupboard binary built from cmd/cupboard
  Fresh temp directory for config and data
  Config file points SQLite backend at the temp data directory
  No existing crumbs, trails, or links
  No existing entities in any standard table
  No existing crumbs
  Go toolchain installed (go build works)
  Source tree is checked out and module dependencies resolved
  Go test infrastructure available (go test command)
  tests/integration package contains benchmark test files
  Cupboard initialized with SQLite backend in a temp directory
test_cases:
- name: Initialize cupboard for lifecycle tests
  description: Validates cupboard init creates required JSONL files.
  inputs:
    args:
    - cupboard init
  expected:
    exit_code: 0
    stdout: output message
- name: Create single trail
  description: Create one trail and verify ID generation and active state.
  inputs:
    args:
    - cupboard set trails "" '{"State":"active"}'
  expected:
    exit_code: 0
    stdout_structure: '{"TrailID": "non-empty", "State": "active"}'
- name: Create multiple trails
  description: Create three trails and verify unique IDs and count.
  inputs: {}
  expected:
    exit_code: 0
- name: Complete trail
  description: Create an active trail, then transition to completed state.
  inputs:
    args:
    - cupboard set trails ${trail_id} '{"TrailID":"${trail_id}","State":"completed"}'
  expected:
    exit_code: 0
- name: Abandon trail
  description: Create an active trail, then transition to abandoned state.
  inputs:
    args:
    - cupboard set trails ${trail_id} '{"TrailID":"${trail_id}","State":"abandoned"}'
  expected:
    exit_code: 0
- name: Link single crumb to trail
  description: Create one crumb and one trail, link them via belongs_to.
  inputs:
    args:
    - cupboard set links "" '{"LinkType":"belongs_to","FromID":"${crumb_id}","ToID":"${trail_id}"}'
  expected:
    exit_code: 0
    stdout_structure: '{"LinkID": "non-empty", "LinkType": "belongs_to"}'
- name: Link multiple crumbs to different trails
  description: Create two crumbs and two trails, link each crumb to a different trail.
  inputs: {}
  expected:
    exit_code: 0
- name: Trails persisted to JSONL
  description: Create trails, transition states, verify JSONL file contains correct
    state values.
  inputs: {}
  expected:
    exit_code: 0
- name: Full lifecycle with crumbs and trails
  description: 'Create 3 crumbs, transition crumb1 to pebble, create 2 trails, link
    crumb2 to trail1 and crumb3 to trail2, complete trail1, abandon trail2. Per prd006-trails-interface
    R5.6/R6.6: completing trail1 removes belongs_to links (crumb2 becomes permanent),
    abandoning trail2 deletes crumb3. '
  inputs: {}
  expected:
    exit_code: 0
- name: Create crumb with empty ID generates UUID v7
  description: Calling Set with empty ID generates a UUID v7 identifier.
  inputs:
    args:
    - cupboard set crumbs "" '{"Name":"Test crumb","State":"draft"}'
  expected:
    exit_code: 0
- name: Created crumb persists to JSONL file
  description: After Set, the entity appears in crumbs.jsonl.
  inputs:
    args:
    - cupboard set crumbs "" '{"Name":"Persisted crumb","State":"draft"}'
  expected:
    exit_code: 0
- name: Two creates generate unique UUIDs
  description: Each Set with empty ID generates a unique UUID v7.
  inputs:
    args:
    - cupboard set crumbs "" '{"Name":"Second crumb","State":"draft"}'
  expected:
    exit_code: 0
- name: Get retrieves entity with matching fields
  description: Get returns the crumb with all fields matching what was created.
  inputs:
    args:
    - cupboard get crumbs ${crumb_id}
  expected:
    exit_code: 0
- name: Round-trip fidelity for crumb fields
  description: Create and retrieve a crumb; all fields must match exactly.
  inputs:
    args:
    - cupboard get crumbs ${crumb_id}
  expected:
    exit_code: 0
- name: Update entity via Set with existing ID
  description: Set with existing ID updates the entity in SQLite and JSONL.
  inputs:
    args:
    - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Updated name","State":"draft"}'
  expected:
    exit_code: 0
- name: Updated entity confirmed via Get
  description: After update, Get returns the modified field values.
  inputs:
    args:
    - cupboard get crumbs ${crumb_id}
  expected:
    exit_code: 0
- name: Update persists to JSONL
  description: After update, the JSONL file reflects the new values.
  inputs:
    args:
    - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"JSONL updated","State":"taken"}'
  expected:
    exit_code: 0
- name: UpdatedAt changes on update
  description: UpdatedAt timestamp is later than the original after update.
  inputs:
    args:
    - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Timestamp
      updated","State":"draft"}'
  expected:
    exit_code: 0
- name: Fetch with empty filter returns all crumbs
  description: Fetch with empty filter returns every crumb in the table.
  inputs:
    args:
    - cupboard list crumbs
  expected:
    exit_code: 0
- name: Fetch empty table returns empty list
  description: Fetch on a table with no entities returns an empty result.
  inputs:
    args:
    - cupboard list crumbs
  expected:
    exit_code: 0
- name: Fetch with state filter returns matching crumbs
  description: Fetch with state=ready returns only crumbs in ready state.
  inputs:
    args:
    - cupboard list crumbs State=ready
  expected:
    exit_code: 0
- name: Fetch with filter returns no matches
  description: Fetch with filter matching no entities returns empty list.
  inputs:
    args:
    - cupboard list crumbs State=pebble
  expected:
    exit_code: 0
- name: Delete removes entity from SQLite
  description: Delete removes the crumb from SQLite; subsequent Get fails.
  inputs:
    args:
    - cupboard delete crumbs ${crumb_id}
  expected:
    exit_code: 0
- name: Delete removes entity from JSONL
  description: After Delete, the entity is no longer in the JSONL file.
  inputs:
    args:
    - cupboard delete crumbs ${crumb_id}
  expected:
    exit_code: 0
- name: Fetch after delete excludes deleted entity
  description: After Delete, Fetch no longer returns the deleted entity.
  inputs:
    args:
    - cupboard list crumbs
  expected:
    exit_code: 0
- name: Get nonexistent crumb returns error
  description: Get with a nonexistent ID returns an error.
  inputs:
    args:
    - cupboard get crumbs nonexistent-uuid-12345
  expected:
    exit_code: 1
    stderr_contains: not found
- name: Delete nonexistent crumb returns error
  description: Delete with a nonexistent ID returns an error.
  inputs:
    args:
    - cupboard delete crumbs nonexistent-uuid-12345
  expected:
    exit_code: 1
    stderr_contains: not found
- name: Get nonexistent trail returns error
  inputs:
    args:
    - cupboard get trails nonexistent-uuid-12345
  expected:
    exit_code: 1
    stderr_contains: not found
- name: Delete nonexistent trail returns error
  inputs:
    args:
    - cupboard delete trails nonexistent-uuid-12345
  expected:
    exit_code: 1
    stderr_contains: not found
- name: Create trail with empty ID generates UUID v7
  description: Set on trails table with empty ID generates a UUID v7.
  inputs:
    args:
    - cupboard set trails "" '{"State":"active"}'
  expected:
    exit_code: 0
- name: Get trail returns entity with matching fields
  inputs:
    args:
    - cupboard get trails ${trail_id}
  expected:
    exit_code: 0
- name: Update trail via Set with existing ID
  inputs:
    args:
    - cupboard set trails ${trail_id} '{"TrailID":"${trail_id}","State":"active"}'
  expected:
    exit_code: 0
- name: Fetch trails with empty filter returns all trails
  inputs:
    args:
    - cupboard list trails
  expected:
    exit_code: 0
- name: Fetch trails with filter returns matching trails
  inputs:
    args:
    - cupboard list trails State=active
  expected:
    exit_code: 0
- name: Delete trail removes from storage
  inputs:
    args:
    - cupboard delete trails ${trail_id}
  expected:
    exit_code: 0
- name: Trail persists to JSONL file
  inputs:
    args:
    - cupboard set trails "" '{"State":"pending"}'
  expected:
    exit_code: 0
- name: JSONL reflects create operation
  inputs:
    args:
    - cupboard set crumbs "" '{"Name":"Create JSONL test","State":"draft"}'
  expected:
    exit_code: 0
- name: JSONL reflects update operation
  inputs:
    args:
    - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"After JSONL
      update","State":"ready"}'
  expected:
    exit_code: 0
- name: JSONL reflects delete operation
  inputs:
    args:
    - cupboard delete crumbs ${crumb1_id}
  expected:
    exit_code: 0
- name: Multiple operations reflected in JSONL
  description: Sequence of create, update, delete operations correctly reflected in
    JSONL.
  inputs: {}
  expected: {}
- name: JSONL lines are valid JSON
  description: Each line in the JSONL file is valid JSON.
  inputs: {}
  expected: {}
- name: Operations after detach return error
  description: After Detach, Table operations return ErrCupboardDetached. SKIPPED
    pending CLI implementation.
  inputs:
    args:
    - cupboard get crumbs ${crumb_id}
  expected:
    exit_code: 1
    stderr_contains: detach
- name: Set after detach returns error
  description: SKIPPED pending CLI implementation.
  inputs:
    args:
    - cupboard set crumbs "" '{"Name":"After detach","State":"draft"}'
  expected:
    exit_code: 1
    stderr_contains: detach
- name: Fetch after detach returns error
  description: SKIPPED pending CLI implementation.
  inputs:
    args:
    - cupboard list crumbs
  expected:
    exit_code: 1
    stderr_contains: detach
- name: Delete after detach returns error
  description: SKIPPED pending CLI implementation.
  inputs:
    args:
    - cupboard delete crumbs ${crumb_id}
  expected:
    exit_code: 1
    stderr_contains: detach
- name: GetTable after detach returns error
  description: SKIPPED pending CLI implementation.
  inputs:
    args:
    - cupboard get crumbs some-id
  expected:
    exit_code: 1
    stderr_contains: detach
- name: Create crumb with draft state and initialized timestamps
  description: 'New crumb with explicit draft state has CreatedAt and UpdatedAt set.
    Note: CLI requires explicit State in JSON input. '
  inputs:
    args:
    - cupboard set crumbs "" '{"Name":"New crumb","State":"draft"}'
  expected:
    exit_code: 0
- name: Create crumb with explicit state
  description: 'Crumb created with explicit ready state is stored with that state. '
  inputs:
    args:
    - cupboard set crumbs "" '{"Name":"Ready crumb","State":"ready"}'
  expected:
    exit_code: 0
- name: Transition draft to pending
  description: Create a crumb in draft, then update to pending state.
  inputs:
    args:
    - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Test crumb","State":"pending"}'
  expected:
    exit_code: 0
- name: Transition pending to ready
  description: Create a crumb in pending, then update to ready state.
  inputs:
    args:
    - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Test crumb","State":"ready"}'
  expected:
    exit_code: 0
- name: Transition draft to ready
  description: Create a crumb in draft, then update directly to ready state.
  inputs:
    args:
    - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Test crumb","State":"ready"}'
  expected:
    exit_code: 0
- name: Transition ready to taken
  description: Create a crumb in ready, then update to taken state.
  inputs:
    args:
    - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Test crumb","State":"taken"}'
  expected:
    exit_code: 0
- name: Transition taken to pebble
  description: Create a crumb in taken, then update to pebble (terminal success).
  inputs:
    args:
    - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Test crumb","State":"pebble"}'
  expected:
    exit_code: 0
- name: Transition draft to dust
  description: Move a crumb from draft to terminal dust state.
  inputs:
    args:
    - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Dust crumb","State":"dust"}'
  expected:
    exit_code: 0
- name: Transition pending to dust
  description: Verify dust transition works from pending state.
  inputs:
    args:
    - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Dust crumb","State":"dust"}'
  expected:
    exit_code: 0
- name: Transition ready to dust
  description: Verify dust transition works from ready state.
  inputs:
    args:
    - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Dust crumb","State":"dust"}'
  expected:
    exit_code: 0
- name: Transition taken to dust
  description: Verify dust transition works from taken state.
  inputs:
    args:
    - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Dust crumb","State":"dust"}'
  expected:
    exit_code: 0
- name: UpdatedAt advances on state transition
  description: 'Verify UpdatedAt changes when state transitions and is later than
    previous value. CreatedAt must remain constant. '
  inputs: {}
  expected:
    exit_code: 0
- name: Fetch by single state returns matching crumbs only
  description: Listing by a specific state returns only crumbs in that state.
  inputs:
    args:
    - cupboard list crumbs State=ready
  expected:
    exit_code: 0
- name: Filter excludes pebble crumbs from non-terminal state list
  description: Listing by state=draft excludes pebble crumbs.
  inputs:
    args:
    - cupboard list crumbs State=draft
  expected:
    exit_code: 0
- name: Filter excludes dust crumbs from non-terminal state list
  description: Listing by state=draft excludes dust crumbs.
  inputs:
    args:
    - cupboard list crumbs State=draft
  expected:
    exit_code: 0
- name: Filter for pebble state returns only pebble crumbs
  description: Listing by state=pebble returns only completed crumbs.
  inputs:
    args:
    - cupboard list crumbs State=pebble
  expected:
    exit_code: 0
- name: Filter for dust state returns only dust crumbs
  description: Listing by state=dust returns only archived crumbs.
  inputs:
    args:
    - cupboard list crumbs State=dust
  expected:
    exit_code: 0
- name: List without filter returns all crumbs
  description: Listing crumbs without state filter returns all crumbs regardless of
    state.
  inputs:
    args:
    - cupboard list crumbs
  expected:
    exit_code: 0
- name: Full success path draft to pebble
  description: 'Exercise the complete success path: draft → pending → ready → taken
    → pebble. '
  inputs: {}
  expected:
    exit_code: 0
- name: Full failure path draft to dust
  description: 'Exercise the failure path: draft → dust. '
  inputs: {}
  expected:
    exit_code: 0
- name: Mixed terminal states in same table
  description: 'Create multiple crumbs with different terminal states and verify correct
    filtering. '
  inputs: {}
  expected:
    exit_code: 0
- name: Module path uses mesh-intelligence
  description: 'go.mod declares module github.com/mesh-intelligence/crumbs. '
  inputs: {}
  expected: {}
- name: Replace directive points to local directory
  description: 'go.mod contains a replace directive pointing to ./ for local development. '
  inputs: {}
  expected: {}
- name: Cupboard CLI compiles without errors
  description: 'Build must succeed through the mesh-intelligence module path with
    the local replace directive. Validated by TestMain building the binary before
    tests run. '
  inputs:
    args:
    - go build -o cupboard ./cmd/cupboard
  expected:
    exit_code: 0
- name: Version command prints version and exits 0
  inputs:
    args:
    - cupboard version
  expected:
    exit_code: 0
    stdout: cupboard
- name: Version command lists implemented use cases
  description: 'The version output must include a list of implemented use cases. For
    this first use case, the output includes at minimum rel01.0-uc004-scaffolding-validation. '
  inputs:
    args:
    - cupboard version
  expected:
    exit_code: 0
    stdout: rel01.0-uc004
- name: Version command works without backend connection
  description: 'The version command must not require an initialized backend. Running
    it without init must succeed. '
  inputs:
    args:
    - cupboard version
  expected:
    exit_code: 0
    stdout: cupboard
- name: Crumb struct has required fields
  description: 'Compile-time test. Instantiate a Crumb with all documented fields
    to verify the struct definition matches prd003-crumbs-interface. '
  inputs: {}
  expected: {}
- name: Trail struct has required fields
  inputs: {}
  expected: {}
- name: Property struct has required fields
  inputs: {}
  expected: {}
- name: Category struct has required fields
  inputs: {}
  expected: {}
- name: Stash struct has required fields
  inputs: {}
  expected: {}
- name: Metadata struct has required fields
  inputs: {}
  expected: {}
- name: Link struct has required fields
  inputs: {}
  expected: {}
- name: SQLite backend satisfies Cupboard interface
  description: 'Compile-time assertion that sqlite.Backend implements types.Cupboard. '
  inputs: {}
  expected: {}
- name: Table interface defines Get, Set, Delete, Fetch
  description: 'Compile-time assertion that the Table interface has all four methods. '
  inputs: {}
  expected: {}
- name: Cupboard interface defines GetTable, Attach, Detach
  description: 'Compile-time assertion that the Cupboard interface has all three methods. '
  inputs: {}
  expected: {}
- name: Standard table name constants are defined
  description: 'All six standard table name constants must be defined with correct
    values. '
  inputs: {}
  expected: {}
- name: GetTable succeeds for crumbs table
  description: 'We probe the crumbs table by requesting a nonexistent ID. Exit code
    0 or 1 confirms the table exists. We must NOT get "table not found" or "unknown
    table" errors. '
  inputs:
    args:
    - cupboard get crumbs nonexistent-probe-id
  expected: {}
- name: GetTable succeeds for trails table
  inputs:
    args:
    - cupboard get trails nonexistent-probe-id
  expected: {}
- name: GetTable succeeds for properties table
  inputs:
    args:
    - cupboard get properties nonexistent-probe-id
  expected: {}
- name: GetTable succeeds for metadata table
  inputs:
    args:
    - cupboard get metadata nonexistent-probe-id
  expected: {}
- name: GetTable succeeds for links table
  inputs:
    args:
    - cupboard get links nonexistent-probe-id
  expected: {}
- name: GetTable succeeds for stashes table
  inputs:
    args:
    - cupboard get stashes nonexistent-probe-id
  expected: {}
- name: GetTable fails for unknown table name
  description: 'Requesting a table that does not exist via CLI must return a non-zero
    exit code. '
  inputs:
    args:
    - cupboard get nonexistent nonexistent-id
  expected:
    exit_code: 1
- name: Backend GetTable succeeds for crumbs table
  description: 'Direct backend API test. GetTable returns a non-nil Table for crumbs. '
  inputs: {}
  expected: {}
- name: Backend GetTable succeeds for trails table
  inputs: {}
  expected: {}
- name: Backend GetTable succeeds for properties table
  inputs: {}
  expected: {}
- name: Backend GetTable succeeds for metadata table
  inputs: {}
  expected: {}
- name: Backend GetTable succeeds for links table
  inputs: {}
  expected: {}
- name: Backend GetTable succeeds for stashes table
  inputs: {}
  expected: {}
- name: Backend GetTable returns ErrTableNotFound for unknown table
  description: 'Direct backend API test. GetTable for an unknown table name returns
    ErrTableNotFound. '
  inputs: {}
  expected: {}
- name: Get benchmark with 10 crumbs
  description: 'Measure Table.Get latency with 10 seeded crumbs. Benchmark uses random
    ID selection to measure average lookup time. '
  inputs:
    args:
    - go test -bench=BenchmarkCrumbsGet10_UC005 -benchmem ./tests/integration/...
  expected:
    exit_code: 0
    stdout: BenchmarkCrumbsGet10_UC005
- name: Get benchmark with 100 crumbs
  inputs:
    args:
    - go test -bench=BenchmarkCrumbsGet100_UC005 -benchmem ./tests/integration/...
  expected:
    exit_code: 0
    stdout: BenchmarkCrumbsGet100_UC005
- name: Get benchmark with 1000 crumbs
  inputs:
    args:
    - go test -bench=BenchmarkCrumbsGet1000_UC005 -benchmem ./tests/integration/...
  expected:
    exit_code: 0
    stdout: BenchmarkCrumbsGet1000_UC005
- name: Get benchmark with 10000 crumbs
  inputs:
    args:
    - go test -bench=BenchmarkCrumbsGet10000_UC005 -benchmem ./tests/integration/...
  expected:
    exit_code: 0
    stdout: BenchmarkCrumbsGet10000_UC005
- name: Set create benchmark with 10 existing crumbs
  description: 'Measure Table.Set latency for creating new crumbs (empty ID triggers
    UUID v7 generation). Seeds 10 existing crumbs before measuring create operations
    per prd002-sqlite-backend R5.3. '
  inputs:
    args:
    - go test -bench=BenchmarkCrumbsSetCreate10_UC005 -benchmem ./tests/integration/...
  expected:
    exit_code: 0
    stdout: BenchmarkCrumbsSetCreate10_UC005
- name: Set create benchmark with 1000 existing crumbs
  inputs:
    args:
    - go test -bench=BenchmarkCrumbsSetCreate1000_UC005 -benchmem ./tests/integration/...
  expected:
    exit_code: 0
    stdout: BenchmarkCrumbsSetCreate1000_UC005
- name: Set update benchmark with 10 crumbs
  description: 'Measure Table.Set latency for updating existing crumbs. Uses random
    ID selection and updates the Name field. '
  inputs:
    args:
    - go test -bench=BenchmarkCrumbsSetUpdate10_UC005 -benchmem ./tests/integration/...
  expected:
    exit_code: 0
    stdout: BenchmarkCrumbsSetUpdate10_UC005
- name: Set update benchmark with 1000 crumbs
  inputs:
    args:
    - go test -bench=BenchmarkCrumbsSetUpdate1000_UC005 -benchmem ./tests/integration/...
  expected:
    exit_code: 0
    stdout: BenchmarkCrumbsSetUpdate1000_UC005
- name: Delete benchmark with 10 crumbs
  description: 'Measure Table.Delete latency. Seeds 10 crumbs, then each iteration
    creates and deletes a crumb. Uses StopTimer/StartTimer to exclude create cost
    from measurement. '
  inputs:
    args:
    - go test -bench=BenchmarkCrumbsDelete10_UC005 -benchmem ./tests/integration/...
  expected:
    exit_code: 0
    stdout: BenchmarkCrumbsDelete10_UC005
- name: Delete benchmark with 1000 crumbs
  inputs:
    args:
    - go test -bench=BenchmarkCrumbsDelete1000_UC005 -benchmem ./tests/integration/...
  expected:
    exit_code: 0
    stdout: BenchmarkCrumbsDelete1000_UC005
- name: Fetch all benchmark with 100 crumbs
  description: 'Measure Table.Fetch latency with nil filter returning all crumbs.
    Exercises full table scan with entity hydration. Asserts result count matches
    data_size. '
  inputs:
    args:
    - go test -bench=BenchmarkCrumbsFetchAll100_UC005 -benchmem ./tests/integration/...
  expected:
    exit_code: 0
    stdout: BenchmarkCrumbsFetchAll100_UC005
- name: Fetch all benchmark with 1000 crumbs
  inputs:
    args:
    - go test -bench=BenchmarkCrumbsFetchAll1000_UC005 -benchmem ./tests/integration/...
  expected:
    exit_code: 0
    stdout: BenchmarkCrumbsFetchAll1000_UC005
- name: Fetch with state filter benchmark 100 crumbs
  description: 'Measure Table.Fetch with state filter (State: draft). Seeds 100 crumbs
    cycling through draft, pending, ready states. Exercises idx_crumbs_state index
    per prd002-sqlite-backend R3.3. '
  inputs:
    args:
    - go test -bench=BenchmarkCrumbsFetchState100_UC005 -benchmem ./tests/integration/...
  expected:
    exit_code: 0
    stdout: BenchmarkCrumbsFetchState100_UC005
- name: Fetch with state filter benchmark 1000 crumbs
  inputs:
    args:
    - go test -bench=BenchmarkCrumbsFetchState1000_UC005 -benchmem ./tests/integration/...
  expected:
    exit_code: 0
    stdout: BenchmarkCrumbsFetchState1000_UC005
