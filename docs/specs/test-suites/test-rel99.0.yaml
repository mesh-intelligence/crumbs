id: test-rel99.0
title: "Unscheduled"
release: "99.0"
description: >
  Release test suite for unscheduled.
  Covers 2 use cases with 56 test cases total.
traces:
  - rel99.0-uc001-blazes-templates
  - rel99.0-uc002-docker-bootstrap
tags:
  - agent
  - blazes
  - bootstrap
  - docker
  - integration
  - self-hosting
  - templates

preconditions:
  - Template directory exists at .crumbs/blazes/ or configured path
  - At least one valid template YAML file in the directory
  - YAML parsing capability available
  - Agent has access to task context for semantic matching
  - Docker installed and running on host
  - Claude API access available (ANTHROPIC_API_KEY set)
  - docs/ directory contains VISION.md, ARCHITECTURE.md, road-map.yaml, PRDs, use cases
  - No crumbs source code in container (only docs/ mounted)

test_cases:

  # --- uc: rel99.0-uc001-blazes-templates: Agent uses blazes (workflow templates) ---

  - name: Discover template directory at well-known path
    inputs:
      env:
        template_dir: .crumbs/blazes/
      command: 'Locate template directory at well-known path .crumbs/blazes/
        '
    expected:
      exit_code: 0
      state:
        directory_found: true
        directory_path: .crumbs/blazes/
  - name: Discover template directory at configured path
    inputs:
      env:
        template_dir: /custom/templates/blazes/
      command: 'Read template directory from configuration
        Locate directory at configured path
        '
    expected:
      exit_code: 0
      state:
        directory_found: true
        directory_path: /custom/templates/blazes/
  - name: Handle missing template directory gracefully
    inputs:
      env:
        template_dir: /nonexistent/blazes/
      command: 'Attempt to locate template directory
        '
    expected:
      state:
        directory_found: false
        templates_list: []
  - name: List all YAML files in template directory
    inputs:
      files:
        .crumbs/blazes/bug-fix.yaml: 'name: Bug Fix
          description: Fix a bug
          tags: [bug-fix]
          parameters: []
          '
        .crumbs/blazes/feature.yml: 'name: Feature
          description: Add a feature
          tags: [feature]
          parameters: []
          '
        .crumbs/blazes/readme.md: '# Readme (not a template)
          '
      command: 'List all .yaml and .yml files in .crumbs/blazes/
        '
    expected:
      exit_code: 0
      state:
        file_count: 2
        files_found:
        - bug-fix.yaml
        - feature.yml
        files_excluded:
        - readme.md
  - name: Handle empty template directory
    inputs:
      files: {}
      command: 'List all .yaml and .yml files in empty directory
        '
    expected:
      exit_code: 0
      state:
        file_count: 0
        files_found: []
  - name: Parse template metadata successfully
    inputs:
      files:
        .crumbs/blazes/bug-fix.yaml: "name: Bug Fix\ndescription: Investigate and fix a reported bug with proper testing\ntags:\n\
          \  - bug-fix\n  - debugging\n  - testing\nparameters:\n  - name: bug_description\n    type: text\n    description:\
          \ Short description of the bug\n  - name: affected_files\n    type: list\n    description: Files likely affected by\
          \ the bug\n"
      command: 'Parse .crumbs/blazes/bug-fix.yaml and extract metadata
        '
    expected:
      exit_code: 0
      state:
        name: Bug Fix
        description: Investigate and fix a reported bug with proper testing
        tags:
        - bug-fix
        - debugging
        - testing
        parameter_count: 2
  - name: Parse template with minimal metadata
    inputs:
      files:
        .crumbs/blazes/simple.yaml: 'name: Simple Template
          description: A simple template
          tags: []
          parameters: []
          '
      command: 'Parse .crumbs/blazes/simple.yaml and extract metadata
        '
    expected:
      exit_code: 0
      state:
        name: Simple Template
        description: A simple template
        tags: []
        parameter_count: 0
  - name: Skip malformed template with warning
    inputs:
      files:
        .crumbs/blazes/valid.yaml: 'name: Valid Template
          description: Valid template
          tags: [valid]
          parameters: []
          '
        .crumbs/blazes/malformed.yaml: 'name: [invalid yaml structure
          description:
          '
      command: 'Parse all templates in directory
        '
    expected:
      state:
        valid_templates: 1
        skipped_templates: 1
        warning_logged: true
  - name: Match task to template tags (exact match)
    inputs:
      files:
        .crumbs/blazes/bug-fix.yaml: 'name: Bug Fix
          description: Fix a bug
          tags: [bug-fix, debugging]
          parameters: []
          '
        .crumbs/blazes/feature.yaml: 'name: Feature
          description: Add a feature
          tags: [feature, enhancement]
          parameters: []
          '
      task_context:
        description: Fix the login bug that crashes on empty password
      command: 'Match task description to template tags
        '
    expected:
      state:
        matched_template: Bug Fix
        match_reason: tags contain bug-fix or debugging
  - name: Match task to template tags (semantic match)
    inputs:
      files:
        .crumbs/blazes/code-review.yaml: 'name: Code Review
          description: Review code changes
          tags: [review, code-review, pr-review]
          parameters: []
          '
      task_context:
        description: Review the pull request for the authentication module
      command: 'Match task description to template tags using semantic similarity
        '
    expected:
      state:
        matched_template: Code Review
        match_reason: task contains review keyword matching pr-review tag
  - name: No match when no templates have relevant tags
    inputs:
      files:
        .crumbs/blazes/deployment.yaml: 'name: Deployment
          description: Deploy to production
          tags: [deploy, production]
          parameters: []
          '
      task_context:
        description: Refactor the database layer
      command: 'Attempt to match task to template tags
        '
    expected:
      state:
        matched_template: null
        match_reason: no matching tags
  - name: Select single matching template
    inputs:
      files:
        .crumbs/blazes/bug-fix.yaml: 'name: Bug Fix
          description: Fix a bug
          tags: [bug-fix]
          parameters: []
          '
      task_context:
        description: Fix the crash on startup
      command: 'Match and select best template
        '
    expected:
      state:
        selected_template: Bug Fix
  - name: Select most specific template when multiple match
    inputs:
      files:
        .crumbs/blazes/general-fix.yaml: 'name: General Fix
          description: General fix template
          tags: [fix]
          parameters: []
          '
        .crumbs/blazes/security-fix.yaml: 'name: Security Fix
          description: Fix security vulnerabilities
          tags: [fix, security, vulnerability]
          parameters: []
          '
      task_context:
        description: Fix the SQL injection vulnerability in the login form
      command: 'Match task and select most specific template
        '
    expected:
      state:
        selected_template: Security Fix
        selection_reason: more specific tags matched (security, vulnerability)
  - name: Prompt user when multiple templates match equally
    inputs:
      files:
        .crumbs/blazes/template-a.yaml: 'name: Template A
          description: First template
          tags: [common-tag]
          parameters: []
          '
        .crumbs/blazes/template-b.yaml: 'name: Template B
          description: Second template
          tags: [common-tag]
          parameters: []
          '
      task_context:
        description: Task matching common-tag
      command: 'Match and select when multiple equally match
        '
    expected:
      state:
        candidates:
        - Template A
        - Template B
        user_prompt_required: true
  - name: Extract parameter definitions with all fields
    inputs:
      files:
        .crumbs/blazes/bug-fix.yaml: "name: Bug Fix\ndescription: Fix a bug\ntags: [bug-fix]\nparameters:\n  - name: bug_description\n\
          \    type: text\n    description: Short description of the bug\n  - name: severity\n    type: enum\n    description:\
          \ Bug severity level\n    default: medium\n    options: [low, medium, high, critical]\n  - name: affected_files\n\
          \    type: list\n    description: Files likely affected by the bug\n"
      command: 'Extract parameter definitions from template
        '
    expected:
      state:
        parameter_count: 3
        parameters:
        - name: bug_description
          type: text
          description: Short description of the bug
          default: null
        - name: severity
          type: enum
          description: Bug severity level
          default: medium
        - name: affected_files
          type: list
          description: Files likely affected by the bug
          default: null
  - name: Extract parameters with defaults
    inputs:
      files:
        .crumbs/blazes/with-defaults.yaml: "name: With Defaults\ndescription: Template with default values\ntags: []\nparameters:\n\
          \  - name: timeout\n    type: number\n    description: Timeout in seconds\n    default: 30\n  - name: retry\n    type:\
          \ boolean\n    description: Whether to retry on failure\n    default: true\n"
      command: 'Extract parameters and identify defaults
        '
    expected:
      state:
        parameters:
        - name: timeout
          default: 30
          has_default: true
        - name: retry
          default: true
          has_default: true
  - name: Identify parameters that can be inferred from context
    inputs:
      files:
        .crumbs/blazes/bug-fix.yaml: "name: Bug Fix\ndescription: Fix a bug\ntags: [bug-fix]\nparameters:\n  - name: bug_description\n\
          \    type: text\n    description: Short description of the bug\n  - name: affected_files\n    type: list\n    description:\
          \ Files likely affected by the bug\n"
      task_context:
        description: Fix the login crash bug
        files_in_context:
        - src/auth/login.go
        - src/auth/session.go
      command: 'Extract parameters and identify which can be inferred
        '
    expected:
      state:
        inferred_parameters:
        - name: bug_description
          inferred_value: login crash bug
        - name: affected_files
          inferred_value:
          - src/auth/login.go
          - src/auth/session.go
        user_input_required: []
  - name: Present template selection to user
    inputs:
      files:
        .crumbs/blazes/bug-fix.yaml: "name: Bug Fix\ndescription: Investigate and fix a reported bug with proper testing\ntags:\
          \ [bug-fix, debugging]\nparameters:\n  - name: bug_description\n    type: text\n    description: Short description\
          \ of the bug\n  - name: reproduction_steps\n    type: text\n    description: Steps to reproduce the bug\n"
      task_context:
        description: Fix the login crash
      command: 'Select template and present to user for confirmation
        '
    expected:
      stdout_contains: reproduction_steps
      state:
        user_confirmation_requested: true
  - name: Present template with inferred parameters
    inputs:
      files:
        .crumbs/blazes/bug-fix.yaml: "name: Bug Fix\ndescription: Fix a bug\ntags: [bug-fix]\nparameters:\n  - name: bug_description\n\
          \    type: text\n    description: Short description of the bug\n  - name: affected_files\n    type: list\n    description:\
          \ Files to examine\n"
      task_context:
        description: Fix the null pointer in parser.go
        files_in_context:
        - src/parser.go
      command: 'Present template with inferred values highlighted
        '
    expected:
      stdout_contains: 'affected_files: [src/parser.go] (inferred)'
  - name: Present template with missing required parameters
    inputs:
      files:
        .crumbs/blazes/deployment.yaml: "name: Deployment\ndescription: Deploy to environment\ntags: [deploy]\nparameters:\n\
          \  - name: environment\n    type: enum\n    description: Target environment\n    options: [staging, production]\n\
          \  - name: version\n    type: text\n    description: Version to deploy\n"
      task_context:
        description: Deploy the latest build
      command: 'Present template indicating required parameters
        '
    expected:
      stdout_contains: version (required)
  - name: Handle template directory permission denied
    inputs:
      env:
        template_dir: /root/protected/blazes/
      command: 'Attempt to read protected template directory
        '
    expected:
      state:
        error: permission denied
        templates_list: []
  # --- uc: rel99.0-uc002-docker-bootstrap: Docker bootstrap (docs to working system) ---

  - name: Start container with only docs mounted
    inputs:
      command: "docker run -it \\\n  -v $(pwd)/docs:/workspace/docs:ro \\\n  -e ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY \\\n  crumbs-bootstrap\n"
    expected:
      exit_code: 0
      state:
        container_started: true
        docs_mounted: true
        docs_readonly: true
  - name: Verify no source code in container
    inputs:
      command: 'ls /workspace/
        ls /workspace/pkg 2>&1 || echo "no pkg"
        ls /workspace/internal 2>&1 || echo "no internal"
        ls /workspace/cmd 2>&1 || echo "no cmd"
        '
    expected:
      stdout_contains: no cmd
      state:
        source_code_present: false
  - name: Verify Go toolchain available
    inputs:
      command: go version
    expected:
      exit_code: 0
      stdout_contains: go version
  - name: Verify Claude available
    inputs:
      command: claude --version || claude-code --version
    expected:
      exit_code: 0
  - name: Read VISION.md
    inputs:
      command: cat /workspace/docs/VISION.md
    expected:
      exit_code: 0
      stdout_contains: crumbs
  - name: Read ARCHITECTURE.md
    inputs:
      command: cat /workspace/docs/ARCHITECTURE.md
    expected:
      exit_code: 0
      stdout_contains: Cupboard
  - name: Read road-map.yaml
    inputs:
      command: cat /workspace/docs/road-map.yaml
    expected:
      exit_code: 0
      stdout_contains: releases
  - name: Read all PRDs in product-requirements
    inputs:
      command: ls /workspace/docs/specs/product-requirements/prd*.yaml | wc -l
    expected:
      exit_code: 0
      state:
        prd_count_gt: 0
  - name: Create pkg/types directory structure
    inputs:
      command: 'mkdir -p /workspace/pkg/types
        mkdir -p /workspace/internal/sqlite
        mkdir -p /workspace/cmd/crumbs
        '
    expected:
      exit_code: 0
      files:
        /workspace/pkg/types: directory_exists
        /workspace/internal/sqlite: directory_exists
        /workspace/cmd/crumbs: directory_exists
  - name: Implement Cupboard interface per prd001-cupboard-core
    inputs:
      command: 'Agent implements pkg/types/cupboard.go with:
        - Cupboard interface (Attach, Detach, GetTable)
        - Table interface (Get, Set, Delete, Fetch)
        - Config struct (Backend, DataDir)
        '
    expected:
      files:
        /workspace/pkg/types/cupboard.go: file_exists
      state:
        cupboard_interface_defined: true
        table_interface_defined: true
        config_struct_defined: true
  - name: Attach initializes storage
    inputs:
      command: 'config := Config{Backend: "sqlite", DataDir: "/tmp/test-crumbs"}
        cupboard.Attach(config)
        '
    expected:
      exit_code: 0
      state:
        data_dir_created: true
        sqlite_db_initialized: true
  - name: Detach cleans up resources
    inputs:
      setup:
      - Attach cupboard with config
      command: cupboard.Detach()
    expected:
      exit_code: 0
      state:
        resources_released: true
  - name: Table.Set creates entity
    inputs:
      setup:
      - Attach cupboard
      command: 'crumbsTable := cupboard.GetTable("crumbs")
        id, err := crumbsTable.Set("", &Crumb{Name: "Test", State: "draft"})
        '
    expected:
      exit_code: 0
      state:
        id_generated: true
        crumb_created: true
  - name: Table.Get retrieves entity
    inputs:
      setup:
      - Attach cupboard
      - Create crumb via Table.Set
      command: 'entity, err := crumbsTable.Get(crumb_id)
        '
    expected:
      exit_code: 0
      state:
        entity_retrieved: true
        entity_matches_created: true
  - name: Table.Delete removes entity
    inputs:
      setup:
      - Attach cupboard
      - Create crumb via Table.Set
      command: crumbsTable.Delete(crumb_id)
    expected:
      exit_code: 0
      state:
        entity_deleted: true
  - name: Table.Fetch queries entities
    inputs:
      setup:
      - Attach cupboard
      - Create multiple crumbs with different states
      command: 'filter := map[string]any{"state": "draft"}
        entities, err := crumbsTable.Fetch(filter)
        '
    expected:
      exit_code: 0
      state:
        entities_returned: true
        filter_applied: true
  - name: Crumb state transitions work
    inputs:
      setup:
      - Attach cupboard
      - Create crumb in draft state
      steps:
      - crumb.State = "ready"; crumbsTable.Set(crumb.CrumbID, crumb)
      - crumb.State = "taken"; crumbsTable.Set(crumb.CrumbID, crumb)
      - crumb.State = "pebble"; crumbsTable.Set(crumb.CrumbID, crumb)
    expected:
      state:
        final_state: pebble
  - name: Crumb property methods work
    inputs:
      setup:
      - Attach cupboard
      - Create crumb
      steps:
      - crumb.SetProperty("priority", "high")
      - crumbsTable.Set(crumb.CrumbID, crumb)
      - value := crumb.GetProperty("priority")
    expected:
      state:
        property_set: true
        property_value: high
  - name: JSONL files created on write
    inputs:
      setup:
      - Attach cupboard with DataDir=/tmp/test-crumbs
      - Create crumb via Table.Set
      command: ls /tmp/test-crumbs/*.jsonl
    expected:
      exit_code: 0
      stdout_contains: crumbs.jsonl
  - name: Data loads from JSONL on startup
    inputs:
      setup:
      - Attach cupboard, create crumb, detach
      steps:
      - Attach cupboard again with same DataDir
      - crumbsTable.Get(crumb_id)
    expected:
      state:
        crumb_loaded_from_jsonl: true
        crumb_data_matches: true
  - name: Run release 01.0 tests
    inputs:
      command: go test ./... -v
    expected:
      exit_code: 0
      stdout_contains: PASS
  - name: Verify rel01.0-uc001 success criteria
    description: Cupboard lifecycle use case validation
    inputs:
      steps:
      - Attach cupboard with SQLite config
      - GetTable for each standard table (crumbs, trails, links, stashes, blazes, properties)
      - Detach cupboard
    expected:
      state:
        all_tables_accessible: true
        lifecycle_complete: true
  - name: Verify rel01.0-uc002 success criteria
    description: SQLite CRUD use case validation
    inputs:
      steps:
      - Create, read, update, delete crumb
      - Verify JSONL persistence
    expected:
      state:
        crud_operations_work: true
        jsonl_persisted: true
  - name: Build crumbs CLI
    inputs:
      command: go build -o crumbs ./cmd/crumbs
    expected:
      exit_code: 0
      files:
        /workspace/crumbs: file_exists
  - name: Initialize crumbs data directory
    inputs:
      command: ./crumbs init --datadir /tmp/crumbs-data
    expected:
      exit_code: 0
      state:
        data_dir_created: true
  - name: Create work item via CLI
    inputs:
      command: './crumbs create --type task --name "Implement release 02.0" --state draft
        '
    expected:
      exit_code: 0
      stdout_contains: Created
  - name: Import release 02.0 work items
    inputs:
      steps:
      - ./crumbs create --type epic --name "Release 02.0: Properties with enforcement"
      - ./crumbs create --type task --name "Implement property enforcement" --state draft
      - ./crumbs create --type task --name "Add property validation" --state draft
    expected:
      state:
        work_items_created: 3
  - name: List pending work items
    inputs:
      command: ./crumbs list --state draft
    expected:
      exit_code: 0
      state:
        items_listed: true
  - name: Update work item status
    inputs:
      setup:
      - Create work item in draft state
      command: ./crumbs update ${item_id} --state ready
    expected:
      exit_code: 0
      state:
        item_state: ready
  - name: Verify Cupboard interface matches prd001-cupboard-core
    inputs:
      command: 'Inspect pkg/types/cupboard.go
        Verify Attach, Detach, GetTable methods present
        Verify Table interface has Get, Set, Delete, Fetch
        '
    expected:
      state:
        cupboard_interface_complete: true
        matches_prd: true
  - name: Verify Crumb struct matches prd003-crumbs-interface
    inputs:
      command: 'Inspect pkg/types/crumb.go
        Verify all fields from prd003-crumbs-interface R1
        '
    expected:
      state:
        crumb_struct_complete: true
        matches_prd: true
  - name: Verify SQLite backend matches prd002-sqlite-backend
    inputs:
      command: 'Inspect internal/sqlite/*.go
        Verify JSONL format, directory layout, startup loading
        '
    expected:
      state:
        sqlite_backend_complete: true
        matches_prd: true
  - name: Handle missing ANTHROPIC_API_KEY
    inputs:
      env:
        ANTHROPIC_API_KEY: ''
      command: Attempt to run Claude agent
    expected:
      exit_code: 1
      stderr_contains: API key
  - name: Handle documentation gaps
    description: Agent should file issues for missing specs
    inputs:
      setup:
      - Remove one PRD file from docs/
      command: Agent attempts to implement based on incomplete docs
    expected:
      state:
        issue_filed: true
        issue_describes_missing_spec: true
  - name: End-to-end bootstrap workflow
    description: 'Complete bootstrap from empty container to self-hosting crumbs. Validates the entire flow from documentation
      to working system.
      '
    inputs:
      steps:
      - Start container with only docs/ mounted
      - Verify no source code present
      - Read all documentation (VISION, ARCHITECTURE, PRDs, use cases)
      - Implement release 01.0 (pkg/types, internal/sqlite, cmd/crumbs)
      - Run tests and verify passing
      - Initialize crumbs for self-hosting
      - Import remaining work items for releases 02.0+
      - Use crumbs CLI to track work on one item (create, update, complete)
      - Verify JSONL persistence
    expected:
      state:
        container_started: true
        no_initial_source: true
        docs_read: true
        release_01_implemented: true
        tests_pass: true
        crumbs_initialized: true
        work_tracked_in_crumbs: true
        self_hosting_verified: true

cleanup:
  - Remove temp template directory
  - Stop and remove Docker container
  - Remove crumbs-output volume
  - Clean up temp directories
