id: test-rel01.0-uc004-scaffolding-validation
title: Scaffolding validation (types, interfaces, CLI compile)
release: "01.0"
description: >
  Validates that all entity types, interfaces, and the cupboard CLI compile
  and link correctly. Verifies the version command, standard table names,
  and GetTable for all six tables. This is the first use case implemented.
traces:
  - rel01.0-uc004-scaffolding-validation
  - prd001-cupboard-core R2
  - prd001-cupboard-core R2.5
tags:
  - cli
  - smoke
  - compile

preconditions:
  - Go toolchain installed (go build works)
  - Source tree is checked out and module dependencies resolved

test_cases:

  # --- module path (TestUC004_ModulePath) ---

  - name: Module path uses mesh-intelligence
    description: >
      go.mod declares module github.com/mesh-intelligence/crumbs.
    inputs:
      file: go.mod
    expected:
      file_contains: "module github.com/mesh-intelligence/crumbs"

  - name: Replace directive points to local directory
    description: >
      go.mod contains a replace directive pointing to ./ for local development.
    inputs:
      file: go.mod
    expected:
      file_contains: "replace github.com/mesh-intelligence/crumbs => ./"

  # --- build (TestUC004_CupboardCLICompiles) ---

  - name: Cupboard CLI compiles without errors
    description: >
      Build must succeed through the mesh-intelligence module path
      with the local replace directive. Validated by TestMain building
      the binary before tests run.
    inputs:
      command: go build -o cupboard ./cmd/cupboard
    expected:
      exit_code: 0

  # --- version command (TestUC004_VersionCommand, TestUC004_VersionWorksWithoutBackend) ---

  - name: Version command prints version and exits 0
    inputs:
      command: cupboard version
    expected:
      exit_code: 0
      stdout_contains: "cupboard"

  - name: Version command lists implemented use cases
    description: >
      The version output must include a list of implemented use cases.
      For this first use case, the output includes at minimum
      rel01.0-uc004-scaffolding-validation.
    inputs:
      command: cupboard version
    expected:
      exit_code: 0
      stdout_contains: "rel01.0-uc004"

  - name: Version command works without backend connection
    description: >
      The version command must not require an initialized backend.
      Running it without init must succeed.
    inputs:
      command: cupboard version
    expected:
      exit_code: 0
      stdout_contains: "cupboard"

  # --- entity struct compilation (TestUC004_*StructHasRequiredFields) ---

  - name: Crumb struct has required fields
    description: >
      Compile-time test. Instantiate a Crumb with all documented fields
      to verify the struct definition matches prd003-crumbs-interface.
    inputs:
      go_code: |
        c := &types.Crumb{
            CrumbID:    "test",
            Name:       "test",
            State:      "draft",
            CreatedAt:  time.Now(),
            UpdatedAt:  time.Now(),
            Properties: map[string]any{},
        }
        _ = c
    expected:
      compiles: true

  - name: Trail struct has required fields
    inputs:
      go_code: |
        tr := &types.Trail{
            TrailID:   "test",
            State:     "active",
            CreatedAt: time.Now(),
        }
        _ = tr
    expected:
      compiles: true

  - name: Property struct has required fields
    inputs:
      go_code: |
        p := &types.Property{
            PropertyID:  "test",
            Name:        "priority",
            Description: "Task priority",
            ValueType:   "categorical",
            CreatedAt:   time.Now(),
        }
        _ = p
    expected:
      compiles: true

  - name: Category struct has required fields
    inputs:
      go_code: |
        c := &types.Category{
            CategoryID: "test",
            PropertyID: "test",
            Name:       "high",
            Ordinal:    1,
        }
        _ = c
    expected:
      compiles: true

  - name: Stash struct has required fields
    inputs:
      go_code: |
        s := &types.Stash{
            StashID:   "test",
            Name:      "shared-config",
            StashType: "context",
            Value:     nil,
            Version:   0,
            CreatedAt: time.Now(),
        }
        _ = s
    expected:
      compiles: true

  - name: Metadata struct has required fields
    inputs:
      go_code: |
        m := &types.Metadata{
            MetadataID: "test",
            CrumbID:    "test",
            TableName:  "comments",
            Content:    "{}",
            CreatedAt:  time.Now(),
        }
        _ = m
    expected:
      compiles: true

  - name: Link struct has required fields
    inputs:
      go_code: |
        l := &types.Link{
            LinkID:    "test",
            LinkType:  "belongs_to",
            FromID:    "crumb-1",
            ToID:      "trail-1",
            CreatedAt: time.Now(),
        }
        _ = l
    expected:
      compiles: true

  # --- interface satisfaction (TestUC004_*Interface*) ---

  - name: SQLite backend satisfies Cupboard interface
    description: >
      Compile-time assertion that sqlite.Backend implements types.Cupboard.
    inputs:
      go_code: |
        var _ types.Cupboard = (*sqlite.Backend)(nil)
    expected:
      compiles: true

  - name: Table interface defines Get, Set, Delete, Fetch
    description: >
      Compile-time assertion that the Table interface has all four methods.
    inputs:
      go_code: |
        var tbl types.Table
        _, _ = tbl.Get("id")
        _, _ = tbl.Set("id", nil)
        _ = tbl.Delete("id")
        _, _ = tbl.Fetch(map[string]any{})
    expected:
      compiles: true

  - name: Cupboard interface defines GetTable, Attach, Detach
    description: >
      Compile-time assertion that the Cupboard interface has all three methods.
    inputs:
      go_code: |
        var cupboard types.Cupboard
        _, _ = cupboard.GetTable("name")
        _ = cupboard.Attach(types.Config{})
        _ = cupboard.Detach()
    expected:
      compiles: true

  # --- standard table names (TestUC004_StandardTableNameConstantsDefined) ---

  - name: Standard table name constants are defined
    description: >
      All six standard table name constants must be defined with correct values.
    inputs:
      go_code: |
        names := []string{
            types.CrumbsTable,
            types.TrailsTable,
            types.PropertiesTable,
            types.MetadataTable,
            types.LinksTable,
            types.StashesTable,
        }
        _ = names
    expected:
      compiles: true
      state:
        CrumbsTable: "crumbs"
        TrailsTable: "trails"
        PropertiesTable: "properties"
        MetadataTable: "metadata"
        LinksTable: "links"
        StashesTable: "stashes"

  # --- CLI GetTable for standard tables (TestUC004_GetTableSucceedsForStandardTables) ---

  - name: GetTable succeeds for crumbs table
    description: >
      We probe the crumbs table by requesting a nonexistent ID.
      Exit code 0 or 1 confirms the table exists. We must NOT get
      "table not found" or "unknown table" errors.
    inputs:
      setup:
        - cupboard init
      command: cupboard get crumbs nonexistent-probe-id
    expected:
      exit_code_in: [0, 1]
      stderr_not_contains:
        - "table not found"
        - "unknown table"

  - name: GetTable succeeds for trails table
    inputs:
      setup:
        - cupboard init
      command: cupboard get trails nonexistent-probe-id
    expected:
      exit_code_in: [0, 1]
      stderr_not_contains:
        - "table not found"
        - "unknown table"

  - name: GetTable succeeds for properties table
    inputs:
      setup:
        - cupboard init
      command: cupboard get properties nonexistent-probe-id
    expected:
      exit_code_in: [0, 1]
      stderr_not_contains:
        - "table not found"
        - "unknown table"

  - name: GetTable succeeds for metadata table
    inputs:
      setup:
        - cupboard init
      command: cupboard get metadata nonexistent-probe-id
    expected:
      exit_code_in: [0, 1]
      stderr_not_contains:
        - "table not found"
        - "unknown table"

  - name: GetTable succeeds for links table
    inputs:
      setup:
        - cupboard init
      command: cupboard get links nonexistent-probe-id
    expected:
      exit_code_in: [0, 1]
      stderr_not_contains:
        - "table not found"
        - "unknown table"

  - name: GetTable succeeds for stashes table
    inputs:
      setup:
        - cupboard init
      command: cupboard get stashes nonexistent-probe-id
    expected:
      exit_code_in: [0, 1]
      stderr_not_contains:
        - "table not found"
        - "unknown table"

  - name: GetTable fails for unknown table name
    description: >
      Requesting a table that does not exist via CLI must return a non-zero exit code.
    inputs:
      setup:
        - cupboard init
      command: cupboard get nonexistent nonexistent-id
    expected:
      exit_code: 1

  # --- Backend API GetTable tests (TestUC004_BackendGetTableAllTables) ---

  - name: Backend GetTable succeeds for crumbs table
    description: >
      Direct backend API test. GetTable returns a non-nil Table for crumbs.
    inputs:
      go_code: |
        backend := sqlite.NewBackend()
        config := types.Config{Backend: "sqlite", DataDir: tmpDir}
        backend.Attach(config)
        defer backend.Detach()
        tbl, err := backend.GetTable(types.CrumbsTable)
    expected:
      error: nil
      result_not_nil: true

  - name: Backend GetTable succeeds for trails table
    inputs:
      go_code: |
        backend := sqlite.NewBackend()
        config := types.Config{Backend: "sqlite", DataDir: tmpDir}
        backend.Attach(config)
        defer backend.Detach()
        tbl, err := backend.GetTable(types.TrailsTable)
    expected:
      error: nil
      result_not_nil: true

  - name: Backend GetTable succeeds for properties table
    inputs:
      go_code: |
        backend := sqlite.NewBackend()
        config := types.Config{Backend: "sqlite", DataDir: tmpDir}
        backend.Attach(config)
        defer backend.Detach()
        tbl, err := backend.GetTable(types.PropertiesTable)
    expected:
      error: nil
      result_not_nil: true

  - name: Backend GetTable succeeds for metadata table
    inputs:
      go_code: |
        backend := sqlite.NewBackend()
        config := types.Config{Backend: "sqlite", DataDir: tmpDir}
        backend.Attach(config)
        defer backend.Detach()
        tbl, err := backend.GetTable(types.MetadataTable)
    expected:
      error: nil
      result_not_nil: true

  - name: Backend GetTable succeeds for links table
    inputs:
      go_code: |
        backend := sqlite.NewBackend()
        config := types.Config{Backend: "sqlite", DataDir: tmpDir}
        backend.Attach(config)
        defer backend.Detach()
        tbl, err := backend.GetTable(types.LinksTable)
    expected:
      error: nil
      result_not_nil: true

  - name: Backend GetTable succeeds for stashes table
    inputs:
      go_code: |
        backend := sqlite.NewBackend()
        config := types.Config{Backend: "sqlite", DataDir: tmpDir}
        backend.Attach(config)
        defer backend.Detach()
        tbl, err := backend.GetTable(types.StashesTable)
    expected:
      error: nil
      result_not_nil: true

  - name: Backend GetTable returns ErrTableNotFound for unknown table
    description: >
      Direct backend API test. GetTable for an unknown table name returns ErrTableNotFound.
    inputs:
      go_code: |
        backend := sqlite.NewBackend()
        config := types.Config{Backend: "sqlite", DataDir: tmpDir}
        backend.Attach(config)
        defer backend.Detach()
        _, err := backend.GetTable("nonexistent")
    expected:
      error: ErrTableNotFound

cleanup:
  - Remove temp directories created during tests
