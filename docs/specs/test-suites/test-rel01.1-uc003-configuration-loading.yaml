id: test-rel01.1-uc003-configuration-loading
title: Configuration and path resolution test suite
description: >
  Validates the configuration loading pipeline: platform-specific defaults,
  environment variable overrides, config.yaml values, and CLI flag overrides.
  Tests exercise the precedence chain defined in prd010-configuration-directories.
traces:
  - rel01.1-uc003-configuration-loading
tags:
  - cli
  - integration
  - configuration

preconditions:
  - Cupboard binary built from cmd/cupboard
  - Fresh temp directories for config and data
  - Clean environment (no pre-existing CRUMBS_* env vars)

test_cases:

  # --- Platform defaults (testPlatformDefaults) ---

  - name: Platform defaults with explicit flags
    description: >
      Tests that --config-dir and --data-dir flags work and creates data directory
      with crumbs.jsonl. Validates the CLI accepts explicit paths.
    inputs:
      setup:
        - Create temp config directory
        - Do not create config.yaml (test defaults)
      command: cupboard --config-dir=<tempdir>/config --data-dir=<tempdir>/data init
    expected:
      exit_code: 0
      files:
        <tempdir>/data:
          exists: true
          is_dir: true
        <tempdir>/data/crumbs.jsonl:
          exists: true

  # --- Environment variable overrides (testEnvironmentOverrides) ---

  - name: CRUMBS_CONFIG_DIR is resolved with explicit data-dir
    description: >
      Environment variable CRUMBS_CONFIG_DIR sets the config directory.
      Uses --data-dir flag for data location.
    inputs:
      setup:
        - Create temp env-config directory
      env:
        CRUMBS_CONFIG_DIR: <tempdir>/env-config
      command: cupboard --config-dir=<tempdir>/env-config --data-dir=<tempdir>/env-data init
    expected:
      exit_code: 0
      files:
        <tempdir>/env-data/crumbs.jsonl:
          exists: true

  - name: data_dir via --data-dir flag is respected
    description: The --data-dir flag specifies where data is stored.
    inputs:
      setup:
        - Create temp yaml-config directory
      env:
        CRUMBS_CONFIG_DIR: <tempdir>/yaml-config
      command: cupboard --config-dir=<tempdir>/yaml-config --data-dir=<tempdir>/yaml-data init
    expected:
      exit_code: 0
      files:
        <tempdir>/yaml-data/crumbs.jsonl:
          exists: true

  # --- Flag overrides (testFlagOverrides) ---

  - name: --config-dir overrides CRUMBS_CONFIG_DIR
    description: >
      The --config-dir flag takes precedence over CRUMBS_CONFIG_DIR environment variable.
      Data is created in the flag-specified data directory.
    inputs:
      setup:
        - Create temp env-cfg and flag-cfg directories
      env:
        CRUMBS_CONFIG_DIR: <tempdir>/env-cfg
      command: cupboard --config-dir=<tempdir>/flag-cfg --data-dir=<tempdir>/data init
    expected:
      exit_code: 0
      files:
        <tempdir>/data/crumbs.jsonl:
          exists: true

  - name: --data-dir overrides config.yaml data_dir
    description: >
      The --data-dir flag takes precedence over data_dir set in config.yaml.
      Data is created in flag location, not config location.
    inputs:
      setup:
        - Create temp cfg directory
        - Write config.yaml with data_dir pointing to config-data
      files:
        <tempdir>/cfg/config.yaml: |
          backend: sqlite
          data_dir: <tempdir>/config-data
      command: cupboard --config-dir=<tempdir>/cfg --data-dir=<tempdir>/flag-data init
    expected:
      exit_code: 0
      files:
        <tempdir>/flag-data/crumbs.jsonl:
          exists: true
        <tempdir>/config-data/crumbs.jsonl:
          exists: false

  - name: --data-dir overrides platform default
    description: >
      The --data-dir flag overrides the platform default data directory.
      No config.yaml is used.
    inputs:
      setup:
        - Create temp cfg directory with no config.yaml
      command: cupboard --config-dir=<tempdir>/cfg --data-dir=<tempdir>/explicit-data init
    expected:
      exit_code: 0
      files:
        <tempdir>/explicit-data/crumbs.jsonl:
          exists: true

  # --- Config file loading (testConfigFileLoading) ---

  - name: Missing config directory works with --data-dir flag
    description: >
      CLI works when config directory does not exist, using --data-dir flag
      to specify data location.
    inputs:
      setup:
        - Do not create config directory
      command: cupboard --config-dir=<tempdir>/config --data-dir=<tempdir>/data init
    expected:
      exit_code: 0
      files:
        <tempdir>/data/crumbs.jsonl:
          exists: true

  - name: Empty config directory works with --data-dir flag
    description: >
      CLI works with an empty config directory (no config.yaml),
      using --data-dir flag to specify data location.
    inputs:
      setup:
        - Create empty config directory
      command: cupboard --config-dir=<tempdir>/config --data-dir=<tempdir>/data init
    expected:
      exit_code: 0
      files:
        <tempdir>/data/crumbs.jsonl:
          exists: true

  # --- Precedence chain (testPrecedenceChain) ---

  - name: Full precedence chain flag overrides env and config
    description: >
      Validates precedence order: flag > env > config > default.
      Sets CRUMBS_CONFIG_DIR env var with config.yaml containing data_dir,
      but --data-dir flag takes precedence.
    inputs:
      setup:
        - Create temp env-config directory
        - Write config.yaml with data_dir pointing to env-data
      env:
        CRUMBS_CONFIG_DIR: <tempdir>/env-config
      files:
        <tempdir>/env-config/config.yaml: |
          backend: sqlite
          data_dir: <tempdir>/env-data
      command: cupboard --data-dir=<tempdir>/flag-data init
    expected:
      exit_code: 0
      files:
        <tempdir>/flag-data/crumbs.jsonl:
          exists: true
        <tempdir>/env-data/crumbs.jsonl:
          exists: false

  # --- Error conditions (testErrorConditions) ---

  - name: Invalid YAML syntax in .crumbs.yaml
    description: >
      Invalid YAML syntax in .crumbs.yaml (the file the CLI reads from current directory)
      causes exit code 1 with error message containing "read config".
    inputs:
      setup:
        - Create work directory
        - Write invalid YAML as .crumbs.yaml in work directory
      files:
        <workdir>/.crumbs.yaml: "invalid: yaml: syntax: : :"
      command: cupboard --data-dir=<tempdir>/data init
      working_directory: <workdir>
    expected:
      exit_code: 1
      stderr_contains: "read config"

  # --- XDG paths on Linux (TestXDGPathsOnLinux) ---

  - name: XDG paths on Linux
    description: >
      On Linux, XDG_CONFIG_HOME and XDG_DATA_HOME environment variables
      control config and data directories. Skip on non-Linux platforms.
    inputs:
      skip_unless: runtime.GOOS == "linux"
      setup:
        - Create XDG config and data directories
        - Create crumbs subdirectory in XDG config
        - Write config.yaml with data_dir pointing to XDG data crumbs
      env:
        XDG_CONFIG_HOME: <tempdir>/xdg-config
        XDG_DATA_HOME: <tempdir>/xdg-data
        HOME: <tempdir>
      files:
        <tempdir>/xdg-config/crumbs/config.yaml: |
          backend: sqlite
          data_dir: <tempdir>/xdg-data/crumbs
      command: cupboard init
    expected:
      exit_code: 0
      files:
        <tempdir>/xdg-data/crumbs/crumbs.jsonl:
          exists: true

  # --- Config directory creation (TestConfigDirectoryCreation) ---

  - name: Config directory created on first run
    description: >
      CLI creates the config directory specified by CRUMBS_CONFIG_DIR
      if it does not exist.
    inputs:
      setup:
        - Do not create config directory (it should not exist)
      env:
        CRUMBS_CONFIG_DIR: <tempdir>/new-config-dir
      command: cupboard --data-dir=<tempdir>/data init
    expected:
      exit_code: 0
      files:
        <tempdir>/new-config-dir:
          exists: true
          is_dir: true

  # --- Operations with resolved paths (TestOperationsWithResolvedPaths) ---

  - name: Commands work with resolved paths
    description: >
      Validates that init, set, and list commands work with resolved paths.
      Creates a crumb and verifies it appears in list output.
    inputs:
      setup:
        - Create config directory
      command_sequence:
        - cupboard --config-dir=<tempdir>/config init
        - cupboard --config-dir=<tempdir>/config --data-dir=<tempdir>/data set crumbs "" '{"Name":"Test crumb","State":"draft"}'
        - cupboard --config-dir=<tempdir>/config --data-dir=<tempdir>/data list crumbs
    expected:
      exit_code: 0
      stdout_contains: "Test crumb"

cleanup:
  - Remove all temp directories created during tests
