id: test-rel01.1-uc002-jsonl-git-roundtrip
title: JSONL git roundtrip persistence
description: >
  Validates that JSONL files are the source of truth for the SQLite backend.
  Tests the complete roundtrip: create crumbs, verify JSONL written, delete
  cupboard.db, re-attach, and verify data is intact. Exercises prd-sqlite-backend
  R1 (directory layout), R4 (startup sequence), R5 (write operations), and
  eng01-git-integration conventions.
traces:
  - rel01.1-uc002-jsonl-git-roundtrip
tags:
  - persistence
  - jsonl
  - sqlite
  - git-integration

preconditions:
  - Cupboard binary built from cmd/cupboard
  - Fresh temp directory initialized as git repository
  - Config file points SQLite backend at data subdirectory
  - data/cupboard.db added to .gitignore
  - No existing crumbs or JSONL files

test_cases:

  # --- JSONL file creation (TestJSONLFileCreation) ---

  - name: JSONL files created on first crumb
    description: >
      Creating the first crumb should generate crumbs.jsonl and cupboard.db
      in the data directory.
    inputs:
      command: cupboard init && cupboard set crumbs "" '{"Name":"First crumb","State":"draft"}'
    expected:
      exit_code: 0
      files:
        - path: data/crumbs.jsonl
          exists: true
        - path: data/cupboard.db
          exists: true
      state:
        crumb_count: 1

  - name: Crumb appears in crumbs.jsonl
    inputs:
      command: cupboard init && cupboard set crumbs "" '{"Name":"Tracked crumb","State":"draft"}'
    expected:
      exit_code: 0
      state:
        crumb_count: 1

  - name: Multiple crumbs written to JSONL
    inputs:
      setup:
        - cupboard init
        - cupboard set crumbs "" '{"Name":"Task one","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Epic one","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Task two","State":"draft"}'
      command: cupboard list crumbs
    expected:
      exit_code: 0
      state:
        crumb_count: 3

  # --- JSONL content correctness (TestJSONLContentCorrectness) ---

  - name: JSONL contains correct crumb data
    description: >
      JSONL file should contain crumb name, crumb_id, and state fields.
    inputs:
      setup:
        - cupboard init
        - cupboard set crumbs "" '{"Name":"Verify content","State":"draft"}'
      command: cat data/crumbs.jsonl
    expected:
      exit_code: 0
      stdout_contains:
        - "Verify content"
        - "crumb_id"
        - "state"

  - name: JSONL uses RFC 3339 timestamps
    description: >
      Timestamps should include T separator and timezone indicator (Z or offset).
    inputs:
      setup:
        - cupboard init
        - cupboard set crumbs "" '{"Name":"Timestamp test","State":"draft"}'
      command: cat data/crumbs.jsonl
    expected:
      exit_code: 0
      stdout_contains:
        - "created_at"
        - "T"
      stdout_pattern: "(Z|[+-]\\d{2}:\\d{2})"

  - name: JSONL uses lowercase hyphenated UUIDs
    description: >
      UUID v7 identifiers should be lowercase with hyphens per prd-sqlite-backend R2.12.
    inputs:
      setup:
        - cupboard init
        - cupboard set crumbs "" '{"Name":"UUID test","State":"draft"}'
      command: cat data/crumbs.jsonl
    expected:
      exit_code: 0
      stdout_pattern: '"crumb_id"\s*:\s*"[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"'

  # --- Database deletion and rebuild (TestDatabaseDeletionAndRebuild) ---

  - name: Delete cupboard.db removes database
    inputs:
      setup:
        - cupboard init
        - cupboard set crumbs "" '{"Name":"Pre-delete","State":"draft"}'
      command: rm data/cupboard.db && ls data/cupboard.db 2>&1
    expected:
      exit_code: 1

  - name: Cupboard command regenerates database from JSONL
    description: >
      After deleting cupboard.db, running any cupboard command should trigger
      the startup sequence (prd-sqlite-backend R4) which recreates the database.
    inputs:
      setup:
        - cupboard init
        - cupboard set crumbs "" '{"Name":"Rebuilder","State":"draft"}'
        - rm data/cupboard.db
      command: cupboard list crumbs
    expected:
      exit_code: 0
      state:
        crumb_count: 1
        file_exists: data/cupboard.db

  - name: Single crumb survives database deletion
    inputs:
      setup:
        - cupboard init
        - cupboard set crumbs "" '{"Name":"Survivor","State":"draft"}'
        - rm data/cupboard.db
      command: cupboard list crumbs
    expected:
      exit_code: 0
      state:
        crumb_count: 1
      stdout_contains: "Survivor"

  - name: Multiple crumbs survive database deletion
    inputs:
      setup:
        - cupboard init
        - cupboard set crumbs "" '{"Name":"First survivor","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Second survivor","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Third survivor","State":"draft"}'
        - rm data/cupboard.db
      command: cupboard list crumbs
    expected:
      exit_code: 0
      state:
        crumb_count: 3

  - name: Crumb details intact after rebuild
    description: >
      Verify that crumb title is preserved after deleting cupboard.db
      and rebuilding from JSONL.
    inputs:
      setup:
        - cupboard init
        - cupboard set crumbs "" '{"Name":"Detailed epic","State":"draft"}'
        - rm data/cupboard.db
      command: cupboard get crumbs ${crumb_id}
    expected:
      exit_code: 0
      stdout_contains: "Detailed epic"

  # --- State changes persist to JSONL (TestStateChangesPersistence) ---

  - name: State update persists to JSONL
    inputs:
      setup:
        - cupboard init
        - cupboard set crumbs "" '{"Name":"State test crumb","State":"draft"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"State test crumb","State":"taken"}' && cat data/crumbs.jsonl
    expected:
      exit_code: 0
      stdout_contains: "taken"

  - name: State change survives database deletion
    inputs:
      setup:
        - cupboard init
        - cupboard set crumbs "" '{"Name":"State test crumb","State":"draft"}'
        - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"State test crumb","State":"taken"}'
        - rm data/cupboard.db
      command: cupboard get crumbs ${crumb_id}
    expected:
      exit_code: 0
      stdout_contains: "taken"

  - name: Closed state survives database deletion
    inputs:
      setup:
        - cupboard init
        - cupboard set crumbs "" '{"Name":"State test crumb","State":"draft"}'
        - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"State test crumb","State":"pebble"}'
        - rm data/cupboard.db
      command: cupboard get crumbs ${crumb_id}
    expected:
      exit_code: 0
      stdout_contains: "pebble"

  # --- Queries work after rebuild (TestQueriesAfterRebuild) ---

  - name: Ready filter works after rebuild
    description: >
      State filter should work correctly after database rebuild from JSONL.
    inputs:
      setup:
        - cupboard init
        - cupboard set crumbs "" '{"Name":"Open task","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Closed task","State":"draft"}'
        - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Closed task","State":"pebble"}'
        - rm data/cupboard.db
      command: cupboard list crumbs State=draft
    expected:
      exit_code: 0
      state:
        crumb_count: 1

  - name: Type filter works after rebuild
    description: >
      State filter distinguishes crumbs by state after database rebuild.
    inputs:
      setup:
        - cupboard init
        - cupboard set crumbs "" '{"Name":"A task","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"An epic","State":"ready"}'
        - rm data/cupboard.db
      command: cupboard list crumbs State=ready
    expected:
      exit_code: 0
      state:
        crumb_count: 1

  # --- Empty cupboard rebuild (TestEmptyCupboardRebuild) ---

  - name: Empty JSONL files create empty cupboard
    description: >
      Starting with empty JSONL files (fresh repository clone scenario) should
      result in an empty but functional cupboard.
    inputs:
      setup:
        - cupboard init
        - rm -f data/*.jsonl data/cupboard.db
      command: cupboard init && cupboard list crumbs
    expected:
      exit_code: 0
      state:
        crumb_count: 0

  - name: Fresh start with no files
    description: >
      When no data directory exists, cupboard should create it and initialize
      empty JSONL files per prd-sqlite-backend R1.3, R1.4.
    inputs:
      setup:
        - cupboard init
        - rm -rf data
      command: cupboard init && cupboard list crumbs
    expected:
      exit_code: 0
      state:
        crumb_count: 0
      files:
        - path: data/crumbs.jsonl
          exists: true

  - name: Create works after fresh start
    description: >
      After a fresh start with no existing data, creating crumbs should work
      normally and persist to JSONL.
    inputs:
      setup:
        - cupboard init
        - rm -rf data
        - cupboard init
      command: cupboard set crumbs "" '{"Name":"Fresh crumb","State":"draft"}'
    expected:
      exit_code: 0
      stdout_contains: "Fresh crumb"

  # --- Git integration (TestGitIntegration) ---

  - name: JSONL files can be committed to git
    description: >
      JSONL files should be committable to git while cupboard.db is gitignored.
      This simulates the git workflow from eng01-git-integration.
    inputs:
      setup:
        - git init
        - echo "data/cupboard.db" >> .gitignore
        - cupboard init
        - cupboard set crumbs "" '{"Name":"Git tracked","State":"draft"}'
      command: git add data/*.jsonl && git status --porcelain data/
    expected:
      exit_code: 0
      stdout_contains: "crumbs.jsonl"

  - name: Cupboard.db not tracked by git
    description: >
      The SQLite database should be gitignored per eng01-git-integration.
    inputs:
      setup:
        - git init
        - echo "data/cupboard.db" >> .gitignore
        - cupboard init
        - cupboard set crumbs "" '{"Name":"Db test","State":"draft"}'
      command: git status --porcelain data/cupboard.db
    expected:
      exit_code: 0
      stdout_equals: ""

  # --- Full roundtrip workflow (TestFullRoundtripWorkflow) ---

  - name: Complete roundtrip workflow
    description: >
      Simulates the full workflow from rel01.1-uc002: create crumbs, commit JSONL,
      delete database, rebuild, verify data, modify data, repeat roundtrip.
    inputs:
      setup:
        - git init
        - git config user.email "test@example.com"
        - git config user.name "Test User"
        - echo "data/cupboard.db" >> .gitignore
        - cupboard init
      steps:
        - command: cupboard set crumbs "" '{"Name":"Roundtrip task","State":"draft"}'
          capture: task_id
        - command: cupboard set crumbs "" '{"Name":"Roundtrip epic","State":"draft"}'
          capture: epic_id
        - command: git add data/*.jsonl && git commit -m "Add initial crumbs"
        - command: cupboard list crumbs
          expected:
            state:
              crumb_count: 2
        - command: rm data/cupboard.db
        - command: cupboard list crumbs
          expected:
            state:
              crumb_count: 2
        - command: cupboard get crumbs ${task_id}
          expected:
            stdout_contains: "Roundtrip task"
        - command: cupboard set crumbs ${task_id} '{"CrumbID":"${task_id}","Name":"Roundtrip task","State":"taken"}'
        - command: rm data/cupboard.db && cupboard get crumbs ${task_id}
          expected:
            stdout_contains: "taken"
        - command: cupboard set crumbs ${task_id} '{"CrumbID":"${task_id}","Name":"Roundtrip task","State":"pebble"}'
        - command: rm data/cupboard.db && cupboard get crumbs ${task_id}
          expected:
            stdout_contains: "pebble"
        - command: cupboard list crumbs State=draft
          expected:
            state:
              crumb_count: 1
    expected:
      exit_code: 0

  - name: Roundtrip with multiple deletes
    description: >
      Repeatedly deleting and rebuilding the database should always produce
      consistent results from JSONL.
    inputs:
      setup:
        - git init
        - git config user.email "test@example.com"
        - git config user.name "Test User"
        - echo "data/cupboard.db" >> .gitignore
        - cupboard init
        - cupboard set crumbs "" '{"Name":"Persistent","State":"draft"}'
      steps:
        - command: rm data/cupboard.db && cupboard list crumbs
          expected:
            state:
              crumb_count: 1
        - command: rm data/cupboard.db && cupboard list crumbs
          expected:
            state:
              crumb_count: 1
        - command: rm data/cupboard.db && cupboard list crumbs
          expected:
            state:
              crumb_count: 1
    expected:
      exit_code: 0

cleanup:
  - Remove temp directory and git repository
