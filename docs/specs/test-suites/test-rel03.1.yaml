id: test-rel03.1
title: Post-Trails Validation
release: '03.1'
traces:
- rel03.1-uc001-self-hosting-with-epics
preconditions:
- Cupboard initialized with SQLite backend
- No existing crumbs, trails, or links in the database
- rel03.0 trail lifecycle features are implemented
test_cases:
- name: Create epic trail in draft state
  inputs:
    args:
    - cupboard set trails "" '{"State":"draft"}'
  expected:
    exit_code: 0
    stdout_structure: '{"State": "draft"}'
- name: Transition trail from draft to active
  inputs:
    args:
    - cupboard set trails <trail_id> '{"TrailID":"<trail_id>","State":"active"}'
  expected:
    exit_code: 0
    stdout_structure: '{"State": "active"}'
- name: Create crumbs for epic
  inputs:
    args:
    - cupboard set crumbs "" '{"Name":"Epic Task 1","State":"draft"}'
    - cupboard set crumbs "" '{"Name":"Epic Task 2","State":"draft"}'
  expected:
    exit_code: 0
- name: Create belongs_to link from crumb to trail
  inputs:
    args:
    - cupboard set links "" '{"LinkType":"belongs_to","FromID":"<crumb_id>","ToID":"<trail_id>"}'
  expected:
    exit_code: 0
    stdout_structure: '{"LinkType": "belongs_to"}'
- name: Query crumbs by trail via belongs_to links
  inputs:
    args:
    - cupboard list links LinkType=belongs_to ToID=<trail_id>
  expected:
    exit_code: 0
    stdout: belongs_to
- name: Crumbs in active trail are queryable
  inputs:
    args:
    - cupboard get crumbs <crumb_id>
  expected:
    exit_code: 0
    stdout_structure: '{"State": "draft"}'
- name: Crumbs in active trail are modifiable
  inputs:
    args:
    - cupboard set crumbs <crumb_id> '{"CrumbID":"<crumb_id>","Name":"Epic Task 1","State":"taken"}'
  expected:
    exit_code: 0
    stdout_structure: '{"State": "taken"}'
- name: Complete a crumb in the epic
  inputs:
    args:
    - cupboard set crumbs <crumb_id> '{"CrumbID":"<crumb_id>","Name":"Epic Task 1","State":"pebble"}'
  expected:
    exit_code: 0
    stdout_structure: '{"State": "pebble"}'
- name: Complete trail removes belongs_to links
  inputs:
    args:
    - cupboard set trails <trail_id> '{"TrailID":"<trail_id>","State":"completed"}'
  expected:
    exit_code: 0
    stdout_structure: '{"State": "completed"}'
- name: Crumbs persist after trail completion
  inputs:
    args:
    - cupboard get crumbs <crumb_id>
  expected:
    exit_code: 0
    stdout: CrumbID
- name: No belongs_to links after trail completion
  inputs:
    args:
    - cupboard list links LinkType=belongs_to ToID=<trail_id>
  expected:
    exit_code: 0
    stdout: '[]'
- name: Create trail for abandonment test
  inputs:
    args:
    - cupboard set trails "" '{"State":"active"}'
  expected:
    exit_code: 0
    stdout_structure: '{"State": "active"}'
- name: Create crumbs for abandonment trail
  inputs:
    args:
    - cupboard set crumbs "" '{"Name":"Abandon Task 1","State":"draft"}'
    - cupboard set crumbs "" '{"Name":"Abandon Task 2","State":"draft"}'
  expected:
    exit_code: 0
- name: Link crumbs to abandonment trail
  inputs:
    args:
    - cupboard set links "" '{"LinkType":"belongs_to","FromID":"<crumb_a_id>","ToID":"<abandon_trail_id>"}'
    - cupboard set links "" '{"LinkType":"belongs_to","FromID":"<crumb_b_id>","ToID":"<abandon_trail_id>"}'
  expected:
    exit_code: 0
- name: Abandon trail deletes associated crumbs
  inputs:
    args:
    - cupboard set trails <abandon_trail_id> '{"TrailID":"<abandon_trail_id>","State":"abandoned"}'
  expected:
    exit_code: 0
    stdout_structure: '{"State": "abandoned"}'
- name: Abandoned crumbs return not found
  inputs:
    args:
    - cupboard get crumbs <crumb_a_id>
  expected:
    exit_code: 1
    stderr_contains: not found
- name: Trail remains after abandonment for audit
  inputs:
    args:
    - cupboard get trails <abandon_trail_id>
  expected:
    exit_code: 0
    stdout_structure: '{"State": "abandoned"}'
- name: Belongs_to links removed after abandonment
  inputs:
    args:
    - cupboard list links LinkType=belongs_to ToID=<abandon_trail_id>
  expected:
    exit_code: 0
    stdout: '[]'
- name: Crumb cannot belong to multiple trails
  description: Attempting to create a second belongs_to link for the same crumb should fail or overwrite
  inputs:
    args:
    - cupboard set trails "" '{"State":"active"}'
    - cupboard set crumbs "" '{"Name":"Single Owner","State":"draft"}'
    - cupboard set links "" '{"LinkType":"belongs_to","FromID":"<crumb_id>","ToID":"<trail_1_id>"}'
    - cupboard set links "" '{"LinkType":"belongs_to","FromID":"<crumb_id>","ToID":"<trail_2_id>"}'
  expected:
    exit_code: 1
    stderr_contains: cardinality
- name: JSONL files contain trail and link data
  inputs:
    args:
    - ls -la <data_dir>/trails.jsonl
    - ls -la <data_dir>/links.jsonl
  expected:
    exit_code: 0
- name: Add crumb to active trail during work
  description: Test that new crumbs can be added to an active trail
  inputs:
    args:
    - cupboard set trails "" '{"State":"active"}'
    - cupboard set crumbs "" '{"Name":"Initial task","State":"draft"}'
    - cupboard set links "" '{"LinkType":"belongs_to","FromID":"<initial_crumb>","ToID":"<new_trail>"}'
    - cupboard set crumbs "" '{"Name":"Added later","State":"draft"}'
    - cupboard set links "" '{"LinkType":"belongs_to","FromID":"<later_crumb>","ToID":"<new_trail>"}'
    - cupboard list links LinkType=belongs_to ToID=<new_trail>
  expected:
    exit_code: 0
- name: Move crumb between trails
  description: Test moving a crumb from one trail to another by deleting and recreating link
  inputs:
    args:
    - cupboard set trails "" '{"State":"active"}'
    - cupboard set trails "" '{"State":"active"}'
    - cupboard set crumbs "" '{"Name":"Movable task","State":"draft"}'
    - cupboard set links "" '{"LinkType":"belongs_to","FromID":"<movable_crumb>","ToID":"<trail_A>"}'
    - cupboard delete links <link_id>
    - cupboard set links "" '{"LinkType":"belongs_to","FromID":"<movable_crumb>","ToID":"<trail_B>"}'
    - cupboard list links LinkType=belongs_to FromID=<movable_crumb>
  expected:
    exit_code: 0
    stdout_structure: '{"ToID": "<trail_B>"}'
