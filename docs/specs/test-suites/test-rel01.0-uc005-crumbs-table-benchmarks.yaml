id: test-rel01.0-uc005-crumbs-table-benchmarks
title: Crumbs Table performance benchmarks
description: >
  Validates Go benchmark functions for crumbs Table interface operations at
  various data scales. Each test case runs a Go benchmark command and verifies
  that it completes without error and reports timing and memory metrics. The
  benchmarks establish baseline performance for Get, Set, Delete, and Fetch
  operations as specified in rel01.0-uc005-crumbs-table-benchmarks. Property
  operations are out of scope for rel01.0; see rel02.1-uc002 for those.
traces:
  - rel01.0-uc005-crumbs-table-benchmarks
tags:
  - performance
  - benchmark
  - table-interface
  - crumbs

preconditions:
  - Go test infrastructure available (go test command)
  - tests/integration package contains benchmark test files
  - Cupboard initialized with SQLite backend in a temp directory

test_cases:

  # --- Get benchmarks (F3-F6, S5) ---

  - name: Get benchmark with 10 crumbs
    description: >
      Measure Table.Get latency with 10 seeded crumbs. Benchmark uses random
      ID selection to measure average lookup time.
    inputs:
      command: go test -bench=BenchmarkCrumbsGet10_UC005 -benchmem ./tests/integration/...
      data_size: 10
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsGet10_UC005
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true

  - name: Get benchmark with 100 crumbs
    inputs:
      command: go test -bench=BenchmarkCrumbsGet100_UC005 -benchmem ./tests/integration/...
      data_size: 100
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsGet100_UC005
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true

  - name: Get benchmark with 1000 crumbs
    inputs:
      command: go test -bench=BenchmarkCrumbsGet1000_UC005 -benchmem ./tests/integration/...
      data_size: 1000
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsGet1000_UC005
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true

  - name: Get benchmark with 10000 crumbs
    inputs:
      command: go test -bench=BenchmarkCrumbsGet10000_UC005 -benchmem ./tests/integration/...
      data_size: 10000
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsGet10000_UC005
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true

  # --- Set (create) benchmarks (F7-F8, S6) ---

  - name: Set create benchmark with 10 existing crumbs
    description: >
      Measure Table.Set latency for creating new crumbs (empty ID triggers
      UUID v7 generation). Seeds 10 existing crumbs before measuring create
      operations per prd-sqlite-backend R5.3.
    inputs:
      command: go test -bench=BenchmarkCrumbsSetCreate10_UC005 -benchmem ./tests/integration/...
      data_size: 10
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsSetCreate10_UC005
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true

  - name: Set create benchmark with 1000 existing crumbs
    inputs:
      command: go test -bench=BenchmarkCrumbsSetCreate1000_UC005 -benchmem ./tests/integration/...
      data_size: 1000
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsSetCreate1000_UC005
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true

  # --- Set (update) benchmarks (F9-F10, S7) ---

  - name: Set update benchmark with 10 crumbs
    description: >
      Measure Table.Set latency for updating existing crumbs. Uses random ID
      selection and updates the Name field.
    inputs:
      command: go test -bench=BenchmarkCrumbsSetUpdate10_UC005 -benchmem ./tests/integration/...
      data_size: 10
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsSetUpdate10_UC005
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true

  - name: Set update benchmark with 1000 crumbs
    inputs:
      command: go test -bench=BenchmarkCrumbsSetUpdate1000_UC005 -benchmem ./tests/integration/...
      data_size: 1000
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsSetUpdate1000_UC005
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true

  # --- Delete benchmarks (F11-F12, S8) ---

  - name: Delete benchmark with 10 crumbs
    description: >
      Measure Table.Delete latency. Seeds 10 crumbs, then each iteration
      creates and deletes a crumb. Uses StopTimer/StartTimer to exclude
      create cost from measurement.
    inputs:
      command: go test -bench=BenchmarkCrumbsDelete10_UC005 -benchmem ./tests/integration/...
      data_size: 10
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsDelete10_UC005
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true

  - name: Delete benchmark with 1000 crumbs
    inputs:
      command: go test -bench=BenchmarkCrumbsDelete1000_UC005 -benchmem ./tests/integration/...
      data_size: 1000
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsDelete1000_UC005
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true

  # --- Fetch all benchmarks (F13-F14, S9) ---

  - name: Fetch all benchmark with 100 crumbs
    description: >
      Measure Table.Fetch latency with nil filter returning all crumbs.
      Exercises full table scan with entity hydration. Asserts result
      count matches data_size.
    inputs:
      command: go test -bench=BenchmarkCrumbsFetchAll100_UC005 -benchmem ./tests/integration/...
      data_size: 100
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsFetchAll100_UC005
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true

  - name: Fetch all benchmark with 1000 crumbs
    inputs:
      command: go test -bench=BenchmarkCrumbsFetchAll1000_UC005 -benchmem ./tests/integration/...
      data_size: 1000
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsFetchAll1000_UC005
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true

  # --- Fetch with state filter benchmarks (F15-F16, S10) ---

  - name: Fetch with state filter benchmark 100 crumbs
    description: >
      Measure Table.Fetch with state filter (State: draft). Seeds 100 crumbs
      cycling through draft, pending, ready states. Exercises idx_crumbs_state
      index per prd-sqlite-backend R3.3.
    inputs:
      command: go test -bench=BenchmarkCrumbsFetchState100_UC005 -benchmem ./tests/integration/...
      data_size: 100
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsFetchState100_UC005
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true

  - name: Fetch with state filter benchmark 1000 crumbs
    inputs:
      command: go test -bench=BenchmarkCrumbsFetchState1000_UC005 -benchmem ./tests/integration/...
      data_size: 1000
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsFetchState1000_UC005
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true

cleanup:
  - Remove temp data directories created by benchmarks
