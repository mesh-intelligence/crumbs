id: test-rel01.0-uc001-cupboard-lifecycle
title: Cupboard lifecycle and CRUD operations
description: >
  Validates trail creation, trail state transitions, crumb-trail linking,
  JSONL persistence, and full lifecycle workflow with cascade operations.
  Each test case corresponds to an implemented Go test in
  tests/integration/test_rel01_0_uc001_cupboard_lifecycle_test.go.
traces:
  - rel01.0-uc001-cupboard-lifecycle
tags:
  - cli
  - integration
  - lifecycle

preconditions:
  - Cupboard binary built from cmd/cupboard
  - Fresh temp directory for config and data
  - Config file points SQLite backend at the temp data directory
  - No existing crumbs, trails, or links

test_cases:

  # --- TestLifecycleInitialize ---

  - name: Initialize cupboard for lifecycle tests
    description: Validates cupboard init creates required JSONL files.
    inputs:
      command: cupboard init
    expected:
      exit_code: 0
      stdout_contains: output message
      files:
        trails.jsonl:
          exists: true
        links.jsonl:
          exists: true

  # --- TestTrailCreation ---

  - name: Create single trail
    description: Create one trail and verify ID generation and active state.
    inputs:
      setup:
        - cupboard init
      command: cupboard set trails "" '{"State":"active"}'
    expected:
      exit_code: 0
      stdout_json:
        TrailID: non-empty
        State: active
      state:
        trail_count: 1

  - name: Create multiple trails
    description: Create three trails and verify unique IDs and count.
    inputs:
      setup:
        - cupboard init
      steps:
        - cupboard set trails "" '{"State":"active"}'
        - cupboard set trails "" '{"State":"active"}'
        - cupboard set trails "" '{"State":"active"}'
    expected:
      exit_code: 0
      state:
        trail_count: 3
        all_trail_ids_unique: true

  # --- TestTrailLifecycle ---

  - name: Complete trail
    description: Create an active trail, then transition to completed state.
    inputs:
      setup:
        - cupboard init
        - cupboard set trails "" '{"State":"active"}'
      command: cupboard set trails ${trail_id} '{"TrailID":"${trail_id}","State":"completed"}'
    expected:
      exit_code: 0
    verify:
      command: cupboard get trails ${trail_id}
      stdout_json:
        State: completed

  - name: Abandon trail
    description: Create an active trail, then transition to abandoned state.
    inputs:
      setup:
        - cupboard init
        - cupboard set trails "" '{"State":"active"}'
      command: cupboard set trails ${trail_id} '{"TrailID":"${trail_id}","State":"abandoned"}'
    expected:
      exit_code: 0
    verify:
      command: cupboard get trails ${trail_id}
      stdout_json:
        State: abandoned

  # --- TestCrumbTrailLinking ---

  - name: Link single crumb to trail
    description: Create one crumb and one trail, link them via belongs_to.
    inputs:
      setup:
        - cupboard init
        - cupboard set crumbs "" '{"Name":"Crumb 1","State":"draft"}'
        - cupboard set trails "" '{"State":"active"}'
      command: cupboard set links "" '{"LinkType":"belongs_to","FromID":"${crumb_id}","ToID":"${trail_id}"}'
    expected:
      exit_code: 0
      stdout_json:
        LinkID: non-empty
        LinkType: belongs_to
      state:
        link_count: 1

  - name: Link multiple crumbs to different trails
    description: Create two crumbs and two trails, link each crumb to a different trail.
    inputs:
      setup:
        - cupboard init
        - cupboard set crumbs "" '{"Name":"Crumb 1","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Crumb 2","State":"draft"}'
        - cupboard set trails "" '{"State":"active"}'
        - cupboard set trails "" '{"State":"active"}'
      steps:
        - cupboard set links "" '{"LinkType":"belongs_to","FromID":"${crumb1_id}","ToID":"${trail1_id}"}'
        - cupboard set links "" '{"LinkType":"belongs_to","FromID":"${crumb2_id}","ToID":"${trail2_id}"}'
    expected:
      exit_code: 0
      state:
        link_count: 2

  # --- TestTrailPersistence ---

  - name: Trails persisted to JSONL
    description: Create trails, transition states, verify JSONL file contains correct state values.
    inputs:
      setup:
        - cupboard init
        - cupboard set trails "" '{"State":"active"}'
        - cupboard set trails "" '{"State":"active"}'
      steps:
        - cupboard set trails ${trail1_id} '{"TrailID":"${trail1_id}","State":"completed"}'
        - cupboard set trails ${trail2_id} '{"TrailID":"${trail2_id}","State":"abandoned"}'
    expected:
      exit_code: 0
      files:
        trails.jsonl:
          line_count: 2
          contains:
            - '"state":"completed"'
            - '"state":"abandoned"'

  # --- TestFullLifecycleWorkflow ---

  - name: Full lifecycle with crumbs and trails
    description: >
      Create 3 crumbs, transition crumb1 to pebble, create 2 trails, link crumb2
      to trail1 and crumb3 to trail2, complete trail1, abandon trail2.
      Per prd006-trails-interface R5.6/R6.6: completing trail1 removes belongs_to
      links (crumb2 becomes permanent), abandoning trail2 deletes crumb3.
    inputs:
      setup:
        - cupboard init
        - cupboard set crumbs "" '{"Name":"Implement feature X","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Write tests for feature X","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Try approach A","State":"draft"}'
      steps:
        - cupboard set crumbs ${crumb1_id} '{"CrumbID":"${crumb1_id}","Name":"Implement feature X","State":"pebble"}'
        - cupboard set trails "" '{"State":"active"}'
        - cupboard set trails "" '{"State":"active"}'
        - cupboard set links "" '{"LinkType":"belongs_to","FromID":"${crumb2_id}","ToID":"${trail1_id}"}'
        - cupboard set links "" '{"LinkType":"belongs_to","FromID":"${crumb3_id}","ToID":"${trail2_id}"}'
        - cupboard set trails ${trail1_id} '{"TrailID":"${trail1_id}","State":"completed"}'
        - cupboard set trails ${trail2_id} '{"TrailID":"${trail2_id}","State":"abandoned"}'
    expected:
      exit_code: 0
      state:
        crumb_count: 2
        trail_count: 2
        link_count: 0
        pebble_count: 1
        draft_count: 1
        completed_trail_count: 1
        abandoned_trail_count: 1
    notes: >
      crumb3 is deleted by the abandon cascade (prd006-trails-interface R6.6).
      Links are removed by cascade operations (complete removes belongs_to links,
      abandon deletes crumb and its links).

cleanup:
  - Remove temp config and data directories
