id: test-rel03.0-uc004-trail-crumb-lifecycle
title: Trail-crumb lifecycle control and cascade operations
description: >
  Validates trail as a container for crumbs, lifecycle coupling (complete makes
  crumbs permanent, abandon deletes crumbs), cardinality constraints, and query
  patterns for trail membership. Distinct from trail-exploration which focuses
  on branching and exploratory workflows.
traces:
  - rel03.0-uc004-trail-crumb-lifecycle
tags:
  - integration
  - trails
  - lifecycle
  - cascade

preconditions:
  - Cupboard initialized with SQLite backend
  - trails, crumbs, and links tables accessible via GetTable
  - No existing trails, crumbs, or links in the database

test_cases:

  # --- S1: Crumbs associate with trails via belongs_to links ---

  - name: Create belongs_to link associates crumb with trail
    inputs:
      setup:
        - Create trail in active state
        - Create crumb via crumbsTable.Set
      command: |
        link := &Link{LinkType: "belongs_to", FromID: crumb.CrumbID, ToID: trail.TrailID}
        linksTable.Set("", link)
    expected:
      exit_code: 0
      state:
        link_created: true
        link_type: belongs_to
        link_from_id: crumb_id
        link_to_id: trail_id

  - name: Crumb without belongs_to link is orphaned or permanent
    description: A crumb with no belongs_to link is either permanent (was on completed trail) or orphaned
    inputs:
      setup:
        - Create crumb via crumbsTable.Set (no link)
      command: |
        linksTable.Fetch(map[string]any{"link_type": "belongs_to", "from_id": crumb.CrumbID})
    expected:
      state:
        result_count: 0
        crumb_has_no_trail: true

  # --- S2: Cardinality enforcement - crumb belongs to at most one trail ---

  - name: Crumb can belong to only one trail
    description: Attempting to add second belongs_to link for same crumb fails due to uniqueness constraint
    inputs:
      setup:
        - Create trail1 and trail2 in active state
        - Create crumb and link to trail1 via belongs_to
      command: |
        link := &Link{LinkType: "belongs_to", FromID: crumb.CrumbID, ToID: trail2.TrailID}
        linksTable.Set("", link)
    expected:
      error: uniqueness_constraint_violation

  - name: Moving crumb requires deleting old link first
    inputs:
      setup:
        - Create trail1 and trail2 in active state
        - Create crumb and link to trail1 via belongs_to
      steps:
        - linksTable.Delete(link.LinkID)
        - linksTable.Set("", &Link{LinkType: "belongs_to", FromID: crumb.CrumbID, ToID: trail2.TrailID})
      command: |
        linksTable.Fetch(map[string]any{"link_type": "belongs_to", "from_id": crumb.CrumbID})
    expected:
      exit_code: 0
      state:
        result_count: 1
        crumb_belongs_to: trail2_id

  # --- S3: Fetch crumbs by trail membership ---

  - name: Fetch all crumbs belonging to a trail
    inputs:
      setup:
        - Create trail in active state
        - Create crumb1, crumb2, crumb3
        - Link crumb1 and crumb2 to trail via belongs_to
        - crumb3 has no belongs_to link
      command: |
        linksTable.Fetch(map[string]any{"link_type": "belongs_to", "to_id": trail.TrailID})
    expected:
      state:
        result_count: 2
        result_contains_from_ids: [crumb1_id, crumb2_id]
        result_excludes_from_ids: [crumb3_id]

  - name: Fetch returns empty for trail with no crumbs
    inputs:
      setup:
        - Create trail in active state (no crumbs added)
      command: |
        linksTable.Fetch(map[string]any{"link_type": "belongs_to", "to_id": trail.TrailID})
    expected:
      state:
        result_count: 0

  - name: Fetch crumbs across multiple trails
    inputs:
      setup:
        - Create trail1 and trail2 in active state
        - Create crumb1 on trail1, crumb2 on trail2
      steps:
        - linksTable.Fetch(map[string]any{"link_type": "belongs_to", "to_id": trail1.TrailID})
        - linksTable.Fetch(map[string]any{"link_type": "belongs_to", "to_id": trail2.TrailID})
    expected:
      state:
        trail1_crumbs: [crumb1_id]
        trail2_crumbs: [crumb2_id]

  # --- S4: Move crumb between trails ---

  - name: Move crumb from one trail to another
    inputs:
      setup:
        - Create trail1 and trail2 in active state
        - Create crumb and link to trail1
      steps:
        - linksTable.Delete(link.LinkID)
        - linksTable.Set("", &Link{LinkType: "belongs_to", FromID: crumb.CrumbID, ToID: trail2.TrailID})
    expected:
      exit_code: 0
      state:
        crumb_on_trail1: false
        crumb_on_trail2: true

  - name: Crumb data unchanged after moving trails
    inputs:
      setup:
        - Create trail1 and trail2 in active state
        - Create crumb with name and state, link to trail1
      steps:
        - linksTable.Delete(link.LinkID)
        - linksTable.Set("", &Link{LinkType: "belongs_to", FromID: crumb.CrumbID, ToID: trail2.TrailID})
        - crumbsTable.Get(crumb.CrumbID)
    expected:
      state:
        crumb_name: unchanged
        crumb_state: unchanged

  # --- S5: Complete removes belongs_to links ---

  - name: Complete trail removes all belongs_to links
    inputs:
      setup:
        - Create trail in active state
        - Create crumb1 and crumb2, link both to trail
      steps:
        - trail.Complete()
        - trailsTable.Set(trail.TrailID, trail)
        - linksTable.Fetch(map[string]any{"link_type": "belongs_to", "to_id": trail.TrailID})
    expected:
      state:
        trail_state: completed
        links_count: 0

  - name: Complete sets CompletedAt timestamp
    inputs:
      setup:
        - Create trail in active state
      steps:
        - trail.Complete()
        - trailsTable.Set(trail.TrailID, trail)
        - trailsTable.Get(trail.TrailID)
    expected:
      state:
        trail_state: completed
        completed_at_set: true
        completed_at_not_nil: true

  # --- S6: Crumbs persist after completion ---

  - name: Crumbs exist after trail completion
    inputs:
      setup:
        - Create trail in active state
        - Create crumb1 and crumb2, link to trail
      steps:
        - trail.Complete()
        - trailsTable.Set(trail.TrailID, trail)
        - crumbsTable.Get(crumb1.CrumbID)
        - crumbsTable.Get(crumb2.CrumbID)
    expected:
      state:
        crumb1_exists: true
        crumb2_exists: true

  - name: Completed crumbs have no belongs_to link
    inputs:
      setup:
        - Create trail in active state
        - Create crumb, link to trail
      steps:
        - trail.Complete()
        - trailsTable.Set(trail.TrailID, trail)
        - linksTable.Fetch(map[string]any{"link_type": "belongs_to", "from_id": crumb.CrumbID})
    expected:
      state:
        result_count: 0
        crumb_is_permanent: true

  - name: Permanent crumbs indistinguishable from never-trailed crumbs
    description: After completion, crumbs look the same as crumbs that were never on a trail
    inputs:
      setup:
        - Create crumb_standalone (never linked to trail)
        - Create trail in active state
        - Create crumb_completed, link to trail
        - Complete trail
      steps:
        - crumbsTable.Get(crumb_standalone.CrumbID)
        - crumbsTable.Get(crumb_completed.CrumbID)
        - linksTable.Fetch(map[string]any{"link_type": "belongs_to", "from_id": crumb_standalone.CrumbID})
        - linksTable.Fetch(map[string]any{"link_type": "belongs_to", "from_id": crumb_completed.CrumbID})
    expected:
      state:
        both_crumbs_exist: true
        standalone_belongs_to_count: 0
        completed_belongs_to_count: 0

  # --- S7: Abandon deletes all crumbs belonging to trail ---

  - name: Abandon trail deletes associated crumbs
    inputs:
      setup:
        - Create trail in active state
        - Create crumb1 and crumb2, link both to trail
      steps:
        - trail.Abandon()
        - trailsTable.Set(trail.TrailID, trail)
        - crumbsTable.Get(crumb1.CrumbID)
        - crumbsTable.Get(crumb2.CrumbID)
    expected:
      state:
        trail_state: abandoned
        crumb1_error: ErrNotFound
        crumb2_error: ErrNotFound

  - name: Abandon only deletes crumbs with belongs_to link
    description: Crumbs not linked to the trail are unaffected
    inputs:
      setup:
        - Create trail in active state
        - Create crumb_linked, link to trail
        - Create crumb_unlinked (no belongs_to)
      steps:
        - trail.Abandon()
        - trailsTable.Set(trail.TrailID, trail)
        - crumbsTable.Get(crumb_linked.CrumbID)
        - crumbsTable.Get(crumb_unlinked.CrumbID)
    expected:
      state:
        crumb_linked_error: ErrNotFound
        crumb_unlinked_exists: true

  - name: Crumb removed from trail before abandon survives
    inputs:
      setup:
        - Create trail in active state
        - Create crumb1 and crumb2, link both to trail
      steps:
        - linksTable.Delete(link_for_crumb1.LinkID)
        - trail.Abandon()
        - trailsTable.Set(trail.TrailID, trail)
        - crumbsTable.Get(crumb1.CrumbID)
        - crumbsTable.Get(crumb2.CrumbID)
    expected:
      state:
        crumb1_exists: true
        crumb2_error: ErrNotFound

  # --- S8: Cascade deletion cleans up properties, metadata, links ---

  - name: Abandon deletes crumb properties
    inputs:
      setup:
        - Create trail in active state
        - Create crumb with properties set
        - Link crumb to trail
      steps:
        - trail.Abandon()
        - trailsTable.Set(trail.TrailID, trail)
    expected:
      state:
        crumb_properties_deleted: true

  - name: Abandon deletes crumb metadata
    inputs:
      setup:
        - Create trail in active state
        - Create crumb with metadata attached
        - Link crumb to trail
      steps:
        - trail.Abandon()
        - trailsTable.Set(trail.TrailID, trail)
        - metadataTable.Fetch(map[string]any{"CrumbID": crumb.CrumbID})
    expected:
      state:
        metadata_count: 0

  - name: Abandon deletes all links involving crumb
    description: Both belongs_to and any child_of links are removed
    inputs:
      setup:
        - Create trail in active state
        - Create parent_crumb and child_crumb, link both to trail
        - Create child_of link from child_crumb to parent_crumb
      steps:
        - trail.Abandon()
        - trailsTable.Set(trail.TrailID, trail)
        - linksTable.Fetch(map[string]any{"link_type": "child_of"})
    expected:
      state:
        child_of_links_count: 0

  - name: Abandon removes belongs_to links for trail
    inputs:
      setup:
        - Create trail in active state
        - Create crumb, link to trail
      steps:
        - trail.Abandon()
        - trailsTable.Set(trail.TrailID, trail)
        - linksTable.Fetch(map[string]any{"link_type": "belongs_to", "to_id": trail.TrailID})
    expected:
      state:
        belongs_to_links_count: 0

  # --- S9: Trail remains in database after abandonment ---

  - name: Abandoned trail still retrievable
    inputs:
      setup:
        - Create trail in active state
        - Create crumb, link to trail
      steps:
        - trail.Abandon()
        - trailsTable.Set(trail.TrailID, trail)
        - trailsTable.Get(trail.TrailID)
    expected:
      state:
        trail_exists: true
        trail_state: abandoned
        completed_at_set: true

  - name: Abandoned trail has no associated crumbs
    inputs:
      setup:
        - Create trail in active state
        - Create crumb1 and crumb2, link to trail
      steps:
        - trail.Abandon()
        - trailsTable.Set(trail.TrailID, trail)
        - linksTable.Fetch(map[string]any{"link_type": "belongs_to", "to_id": trail.TrailID})
    expected:
      state:
        trail_state: abandoned
        associated_crumbs_count: 0

  # --- S10: State validation for Complete and Abandon ---

  - name: Complete requires active state
    inputs:
      setup:
        - Create trail in draft state
      command: trail.Complete()
    expected:
      error: ErrInvalidState

  - name: Complete on pending state returns error
    inputs:
      setup:
        - Create trail in pending state
      command: trail.Complete()
    expected:
      error: ErrInvalidState

  - name: Complete on completed state returns error
    inputs:
      setup:
        - Create trail in active state
        - Complete the trail
      command: trail.Complete()
    expected:
      error: ErrInvalidState

  - name: Abandon requires active state
    inputs:
      setup:
        - Create trail in draft state
      command: trail.Abandon()
    expected:
      error: ErrInvalidState

  - name: Abandon on completed state returns error
    inputs:
      setup:
        - Create trail in active state
        - Complete the trail
      command: trail.Abandon()
    expected:
      error: ErrInvalidState

  - name: Abandon on abandoned state returns error
    inputs:
      setup:
        - Create trail in active state
        - Abandon the trail
      command: trail.Abandon()
    expected:
      error: ErrInvalidState

  # --- Full lifecycle workflow ---

  - name: Complete lifecycle - trail as container with completion
    description: Create trail, add crumbs, complete, verify crumbs become permanent
    inputs:
      steps:
        - Create trail in draft state
        - Transition trail to active
        - Create crumb1, crumb2, crumb3
        - Link all crumbs to trail via belongs_to
        - Verify Fetch returns 3 crumbs for trail
        - Complete trail
        - Verify all 3 crumbs still exist
        - Verify no belongs_to links remain for trail
        - Verify crumbs are queryable and modifiable
    expected:
      state:
        trail_state: completed
        crumb1_exists: true
        crumb2_exists: true
        crumb3_exists: true
        belongs_to_links_for_trail: 0

  - name: Abandon lifecycle - trail as container with cleanup
    description: Create trail, add crumbs with properties, abandon, verify cascade deletion
    inputs:
      steps:
        - Create trail in active state
        - Create crumb1 and crumb2 with properties
        - Link crumbs to trail via belongs_to
        - Create child_of link between crumbs
        - Abandon trail
        - Verify crumbs are deleted
        - Verify properties are deleted
        - Verify all links involving crumbs are deleted
        - Verify trail still exists in abandoned state
    expected:
      state:
        trail_state: abandoned
        trail_exists: true
        crumb1_exists: false
        crumb2_exists: false
        orphan_links: 0

cleanup:
  - Remove temp data directory
  - Detach cupboard
