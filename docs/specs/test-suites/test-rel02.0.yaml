id: test-rel02.0
title: Properties with Enforcement
release: '02.0'
traces:
- rel02.0-uc001-property-enforcement
- rel02.0-uc002-regeneration-compatibility
preconditions: |-
  Cupboard binary built from cmd/cupboard
  Fresh temp directory for config and data
  Config file points SQLite backend at the temp data directory
  No existing crumbs or properties
  Generation N built and installed via go install ./cmd/cupboard
  Fresh temp directory for test data (separate from repo)
  The cupboard binary is accessible from $GOBIN or $PATH
  Git repository is clean (no uncommitted changes)
test_cases:
- name: Built-in properties seeded on initialization
  description: Verify that five built-in properties exist after cupboard initialization.
  inputs:
    args:
    - cupboard list properties
  expected:
    exit_code: 0
    stdout_structure: '{"length": 5}'
- name: Built-in property priority exists with categorical type
  inputs:
    args:
    - cupboard list properties --json
  expected:
    exit_code: 0
    stdout: '"name":"priority"'
- name: Built-in property type exists with categorical type
  inputs:
    args:
    - cupboard list properties --json
  expected:
    exit_code: 0
    stdout: '"name":"type"'
- name: Built-in property description exists with text type
  inputs:
    args:
    - cupboard list properties --json
  expected:
    exit_code: 0
    stdout: '"name":"description"'
- name: Built-in property owner exists with text type
  inputs:
    args:
    - cupboard list properties --json
  expected:
    exit_code: 0
    stdout: '"name":"owner"'
- name: Built-in property labels exists with list type
  inputs:
    args:
    - cupboard list properties --json
  expected:
    exit_code: 0
    stdout: '"name":"labels"'
- name: New crumb has all five built-in properties initialized
  inputs:
    args:
    - cupboard set crumbs "" '{"Name":"Test crumb"}'
  expected:
    exit_code: 0
    stdout: CrumbID
- name: New crumb properties have default values
  description: Verify that text properties default to empty string, list to empty
    array.
  inputs:
    args:
    - cupboard get crumbs ${crumb_id} --json
  expected:
    exit_code: 0
- name: SetProperty updates property value
  inputs:
    args:
    - cupboard set-property crumbs ${crumb_id} owner "alice"
  expected:
    exit_code: 0
- name: SetProperty updates UpdatedAt timestamp
  description: Verify that UpdatedAt changes after SetProperty.
  inputs:
    args:
    - cupboard set-property crumbs ${crumb_id} owner "bob"
  expected:
    exit_code: 0
- name: SetProperty with list value
  inputs:
    args:
    - cupboard set-property crumbs ${crumb_id} labels '["frontend","urgent"]'
  expected:
    exit_code: 0
- name: GetProperty returns set value
  inputs:
    args:
    - cupboard get-property crumbs ${crumb_id} description
  expected:
    exit_code: 0
    stdout: A detailed description
- name: GetProperty returns default value before set
  inputs:
    args:
    - cupboard get-property crumbs ${crumb_id} owner
  expected:
    exit_code: 0
    stdout: ''
- name: Define custom property backfills existing crumbs
  description: Create a crumb, define a new property, verify crumb has the new property.
  inputs:
    args:
    - cupboard get crumbs ${crumb_id} --json
  expected:
    exit_code: 0
- name: Multiple existing crumbs are backfilled
  description: Create multiple crumbs, define property, verify all have the new property.
  inputs:
    args:
    - cupboard list crumbs --json
  expected:
    exit_code: 0
- name: GetProperties returns all defined properties
  inputs:
    args:
    - cupboard get-properties crumbs ${crumb_id}
  expected:
    exit_code: 0
- name: GetProperties includes custom properties
  inputs:
    args:
    - cupboard get-properties crumbs ${crumb_id}
  expected:
    exit_code: 0
- name: ClearProperty resets text to empty string
  inputs:
    args:
    - cupboard clear-property crumbs ${crumb_id} owner
  expected:
    exit_code: 0
- name: ClearProperty resets list to empty array
  inputs:
    args:
    - cupboard clear-property crumbs ${crumb_id} labels
  expected:
    exit_code: 0
- name: ClearProperty resets integer to zero
  inputs:
    args:
    - cupboard clear-property crumbs ${crumb_id} points
  expected:
    exit_code: 0
- name: ClearProperty updates UpdatedAt timestamp
  inputs:
    args:
    - cupboard clear-property crumbs ${crumb_id} owner
  expected:
    exit_code: 0
- name: Crumb created after property definition has new property
  inputs:
    args:
    - cupboard set crumbs "" '{"Name":"New crumb after prop def"}'
  expected:
    exit_code: 0
- name: Multiple crumbs after property definition all have property
  inputs:
    args:
    - cupboard list crumbs --json
  expected:
    exit_code: 0
- name: All crumbs have same property count after multiple definitions
  description: Define multiple properties, create crumbs at different times, verify
    all have same count.
  inputs:
    args:
    - cupboard list crumbs --json
  expected:
    exit_code: 0
- name: Invariant holds after mixed operations
  description: Perform various operations and verify property count invariant.
  inputs:
    args:
    - cupboard list crumbs --json
  expected:
    exit_code: 0
- name: SetProperty with invalid property fails
  inputs:
    args:
    - cupboard set-property crumbs ${crumb_id} nonexistent_prop "value"
  expected:
    exit_code: 1
    stderr_contains: property not found
- name: SetProperty with wrong type fails
  inputs:
    args:
    - cupboard set-property crumbs ${crumb_id} numeric_field "not a number"
  expected:
    exit_code: 1
    stderr_contains: type mismatch
- name: GetProperty with invalid property fails
  inputs:
    args:
    - cupboard get-property crumbs ${crumb_id} nonexistent_prop
  expected:
    exit_code: 1
    stderr_contains: property not found
- name: ClearProperty with invalid property fails
  inputs:
    args:
    - cupboard clear-property crumbs ${crumb_id} nonexistent_prop
  expected:
    exit_code: 1
    stderr_contains: property not found
- name: Duplicate property name fails
  inputs:
    args:
    - cupboard set properties "" '{"Name":"priority","ValueType":"text","Description":"Duplicate"}'
  expected:
    exit_code: 1
    stderr_contains: duplicate name
- name: Get crumb returns populated Properties map
  description: Verify that Table.Get returns a crumb with Properties map containing
    all defined properties.
  inputs:
    args:
    - cupboard get crumbs ${crumb_id} --json
  expected:
    exit_code: 0
- name: Fetched crumb properties match values set at creation
  description: Verify that properties retrieved via Get match the values that were
    set during crumb creation.
  inputs:
    args:
    - cupboard get crumbs ${crumb_id} --json
  expected:
    exit_code: 0
- name: SetProperty on fetched crumb persists through round-trip
  description: Get a crumb, set a property, save, re-get, and verify the property
    value persists.
  inputs:
    args:
    - cupboard get crumbs ${crumb_id} --json
  expected:
    exit_code: 0
- name: Multiple property updates persist through round-trip
  description: Update multiple properties and verify all values persist after re-fetching.
  inputs:
    args:
    - cupboard get crumbs ${crumb_id} --json
  expected:
    exit_code: 0
- name: Property round-trip with custom property
  description: Create custom property, create crumb, update property, re-fetch and
    verify.
  inputs:
    args:
    - cupboard get crumbs ${crumb_id} --json
  expected:
    exit_code: 0
- name: DefineCategory creates category for categorical property
  description: Define a category on the priority property and verify it is persisted.
  inputs:
    args:
    - cupboard get-categories priority
  expected:
    exit_code: 0
    stdout: critical
- name: DefineCategory returns category with populated CategoryID
  inputs:
    args:
    - cupboard define-category priority "urgent" -1
  expected:
    exit_code: 0
    stdout_structure: '{"has_category_id": true, "name": "urgent", "ordinal": -1}'
- name: Multiple categories can be defined on same property
  inputs:
    args:
    - cupboard get-categories type
  expected:
    exit_code: 0
- name: GetCategories returns categories ordered by ordinal ascending
  inputs:
    args:
    - cupboard get-categories severity --json
  expected:
    exit_code: 0
- name: GetCategories orders by name for same ordinal
  description: Categories with the same ordinal are ordered by name ascending.
  inputs:
    args:
    - cupboard get-categories status --json
  expected:
    exit_code: 0
- name: GetCategories returns empty slice for property with no categories
  inputs:
    args:
    - cupboard get-categories empty_cat --json
  expected:
    exit_code: 0
    stdout_structure: '{"length": 0}'
- name: DefineCategory fails for duplicate name
  inputs:
    args:
    - cupboard define-category dup_test "same_name" 2
  expected:
    exit_code: 1
    stderr_contains: duplicate name
- name: DefineCategory allows same name on different properties
  description: Same category name can exist on different properties.
  inputs:
    args:
    - cupboard define-category prop_b "shared_name" 1
  expected:
    exit_code: 0
- name: DefineCategory fails for text property
  inputs:
    args:
    - cupboard define-category description "some_value" 1
  expected:
    exit_code: 1
    stderr_contains: invalid value type
- name: DefineCategory fails for integer property
  inputs:
    args:
    - cupboard define-category int_prop "value" 1
  expected:
    exit_code: 1
    stderr_contains: invalid value type
- name: GetCategories fails for text property
  inputs:
    args:
    - cupboard get-categories owner
  expected:
    exit_code: 1
    stderr_contains: invalid value type
- name: GetCategories fails for list property
  inputs:
    args:
    - cupboard get-categories labels
  expected:
    exit_code: 1
    stderr_contains: invalid value type
- name: DefineCategory allows negative ordinals
  inputs:
    args:
    - cupboard define-category neg_ord "top_priority" -10
  expected:
    exit_code: 0
    stdout_structure: '{"ordinal": -10}'
- name: Negative ordinals sort before positive
  inputs:
    args:
    - cupboard get-categories ord_sort --json
  expected:
    exit_code: 0
- name: Categories persist to JSONL
  description: Verify that categories are persisted to categories.jsonl.
  inputs:
    args:
    - cat ${data_dir}/categories.jsonl
  expected:
    exit_code: 0
    stdout: '"name":"persisted"'
- name: Build generation N succeeds
  inputs:
    args:
    - go build -o /tmp/cupboard-gen-n ./cmd/cupboard
  expected:
    exit_code: 0
- name: Install generation N to GOBIN succeeds
  inputs:
    args:
    - go install ./cmd/cupboard
  expected:
    exit_code: 0
- name: Installed cupboard --help works
  inputs:
    args:
    - cupboard --help
  expected:
    exit_code: 0
    stdout: cupboard
- name: Installed cupboard version works
  inputs:
    args:
    - cupboard version
  expected:
    exit_code: 0
    stdout: cupboard
- name: Initialize data directory with generation N
  inputs:
    args:
    - cupboard init --datadir /tmp/regen-test
  expected:
    exit_code: 0
- name: Create crumb with generation N
  inputs:
    args:
    - cupboard set crumbs "" '{"Name":"Compat test crumb","State":"draft"}' --datadir
      /tmp/regen-test
  expected:
    exit_code: 0
    stdout: CrumbID
- name: Create multiple crumbs with generation N
  inputs:
    args:
    - cupboard list crumbs --datadir /tmp/regen-test
  expected:
    exit_code: 0
    stdout_structure: '{"length": 4}'
- name: Crumbs persisted to JSONL file
  inputs:
    args:
    - cat /tmp/regen-test/crumbs.jsonl
  expected:
    exit_code: 0
    stdout: '[''"name":"Compat test crumb"'', ''"name":"Crumb one"'', ''"name":"Crumb
      two"'', ''"name":"Crumb three"'']'
- name: Create git tag before regeneration
  inputs:
    args:
    - git tag -a regen-test-$(date +%s) -m "Pre-regeneration tag"
  expected:
    exit_code: 0
- name: Regenerate via mage runs successfully
  description: Run the openGeneration mage target which deletes Go files and reinitializes.
  inputs:
    args:
    - mage openGeneration
  expected:
    exit_code: 0
    stdout: generation
- name: Regeneration creates clean commit
  description: Verify regeneration commits the deletion of Go files.
  inputs:
    args:
    - git log -1 --oneline
  expected:
    exit_code: 0
- name: Build generation N+1 from fresh code
  inputs:
    args:
    - go build -o /tmp/cupboard-gen-n1 ./cmd/cupboard
  expected:
    exit_code: 0
- name: Generation N+1 binary runs
  inputs:
    args:
    - /tmp/cupboard-gen-n1 --help
  expected:
    exit_code: 0
    stdout: cupboard
- name: Generation N+1 lists crumbs created by generation N
  inputs:
    args:
    - /tmp/cupboard-gen-n1 list crumbs --datadir /tmp/regen-test
  expected:
    exit_code: 0
    stdout: '[''Compat test crumb'', ''Crumb one'', ''Crumb two'', ''Crumb three'']'
- name: Generation N+1 gets specific crumb by ID
  inputs:
    args:
    - /tmp/cupboard-gen-n1 get crumbs ${CRUMB_ID} --datadir /tmp/regen-test
  expected:
    exit_code: 0
    stdout: CrumbID
- name: Generation N+1 reads all crumb fields correctly
  inputs:
    args:
    - /tmp/cupboard-gen-n1 list crumbs --datadir /tmp/regen-test --json
  expected:
    exit_code: 0
    stdout_structure: '{"length": 4}'
- name: Generation N+1 updates crumb state
  inputs:
    args:
    - /tmp/cupboard-gen-n1 set crumbs ${CRUMB_ID} '{"CrumbID":"${CRUMB_ID}","Name":"Crumb
      two","State":"pebble"}' --datadir /tmp/regen-test
  expected:
    exit_code: 0
- name: Modification reflected in JSONL
  inputs:
    args:
    - cat /tmp/regen-test/crumbs.jsonl
  expected:
    exit_code: 0
    stdout: '"state":"pebble"'
- name: Generation N+1 creates new crumb
  inputs:
    args:
    - /tmp/cupboard-gen-n1 set crumbs "" '{"Name":"N+1 created crumb","State":"draft"}'
      --datadir /tmp/regen-test
  expected:
    exit_code: 0
    stdout: CrumbID
- name: New crumb appears in JSONL
  inputs:
    args:
    - cat /tmp/regen-test/crumbs.jsonl
  expected:
    exit_code: 0
    stdout: '"name":"N+1 created crumb"'
- name: Installed generation N lists all crumbs including N+1 additions
  inputs:
    args:
    - cupboard list crumbs --datadir /tmp/regen-test
  expected:
    exit_code: 0
    stdout: '[''Compat test crumb'', ''Crumb one'', ''Crumb two'', ''N+1 created crumb'']'
- name: Generation N reads state change made by N+1
  inputs:
    args:
    - cupboard list crumbs --datadir /tmp/regen-test --json
  expected:
    exit_code: 0
- name: Generation N gets crumb created by N+1
  inputs:
    args:
    - cupboard get crumbs ${CRUMB_ID} --datadir /tmp/regen-test
  expected:
    exit_code: 0
    stdout: N+1 created crumb
- name: Generation N modifies crumb after N+1 modification
  inputs:
    args:
    - cupboard set crumbs ${CRUMB_ID} '{"CrumbID":"${CRUMB_ID}","Name":"Crumb three","State":"dust"}'
      --datadir /tmp/regen-test
  expected:
    exit_code: 0
- name: Generation N sets property value on crumb
  inputs:
    args:
    - cupboard set-property crumbs ${CRUMB_ID} owner "alice" --datadir /tmp/regen-test
  expected:
    exit_code: 0
- name: Generation N+1 reads property value set by N
  inputs:
    args:
    - /tmp/cupboard-gen-n1 get-property crumbs ${CRUMB_ID} owner --datadir /tmp/regen-test
  expected:
    exit_code: 0
    stdout: alice
- name: Generation N defines custom property
  inputs:
    args:
    - cupboard set properties "" '{"Name":"regen_test_prop","ValueType":"text","Description":"Test
      property for regeneration"}' --datadir /tmp/regen-test
  expected:
    exit_code: 0
- name: Generation N+1 lists custom property defined by N
  inputs:
    args:
    - /tmp/cupboard-gen-n1 list properties --datadir /tmp/regen-test --json
  expected:
    exit_code: 0
    stdout: '"name":"regen_test_prop"'
- name: Generation N+1 sets value on property defined by N
  inputs:
    args:
    - /tmp/cupboard-gen-n1 set-property crumbs ${CRUMB_ID} regen_test_prop "n+1 value"
      --datadir /tmp/regen-test
  expected:
    exit_code: 0
- name: Generation N reads property value set by N+1
  inputs:
    args:
    - cupboard get-property crumbs ${CRUMB_ID} regen_test_prop --datadir /tmp/regen-test
  expected:
    exit_code: 0
    stdout: n+1 value
- name: JSONL with unknown fields is parsed by older generation
  description: Generation N+1 adds a field; generation N ignores it.
  inputs:
    args:
    - cupboard list crumbs --datadir /tmp/regen-test
  expected:
    exit_code: 0
    stdout: Unknown field test
- name: Generation N+1 handles missing JSONL gracefully
  inputs:
    args:
    - /tmp/cupboard-gen-n1 list crumbs --datadir /tmp/empty-dir
  expected:
    exit_code: 0
    stdout_structure: '{"length": 0}'
- name: Both generations handle corrupted entry
  description: A single corrupted line should not prevent reading valid entries.
  inputs:
    args:
    - cupboard list crumbs --datadir /tmp/regen-test-corrupt
  expected:
    exit_code: 0
    stdout: Valid after corrupt
