id: test-rel02.1
title: "Issue-Tracking and Self-Hosting"
release: "02.1"
description: >
  Release test suite for issue-tracking and self-hosting.
  Covers 4 use cases with 86 test cases total.
traces:
  - rel02.1-uc001-issue-tracking-cli
  - rel02.1-uc002-table-benchmarks
  - rel02.1-uc003-self-hosting
  - rel02.1-uc004-metadata-lifecycle
tags:
  - benchmark
  - cli
  - crud
  - integration
  - issue-tracking
  - metadata
  - performance
  - self-hosting
  - sqlite
  - table-interface

preconditions:
  - Cupboard binary built from cmd/cupboard
  - Fresh temp directory for config and data
  - Config file points SQLite backend at the temp data directory
  - CUPBOARD_CONFIG environment variable set to config file path
  - No existing crumbs in the table
  - Go test infrastructure available (go test command)
  - tests/integration package contains benchmark test files
  - Cupboard initialized with SQLite backend in a temp directory
  - Built-in properties seeded per prd002-sqlite-backend R9
  - No existing crumbs
  - Cupboard attached with SQLite backend
  - Fresh temp directory for data
  - No existing crumbs or metadata
  - Built-in schemas (comments, attachments) pre-registered

test_cases:

  # --- uc: rel02.1-uc001-issue-tracking-cli: Issue-tracking CLI commands ---

  - name: Create task with JSON output returns crumb_id, state, and type
    description: 'Validates S1: cupboard create --type task --title ''Demo'' --description ''Test'' --json outputs JSON with
      crumb_id, state open, type task.
      '
    inputs:
      command: cupboard create --type task --title "Demo" --description "Test" --json
    expected:
      exit_code: 0
      stdout_json:
        crumb_id: present
        state: open
        type: task
        title: Demo
  - name: Create task with required fields in human-readable mode
    inputs:
      command: cupboard create --type task --title "Implement feature" --description "Details here"
    expected:
      exit_code: 0
      stdout_contains: Created
  - name: List returns JSON array containing created task
    description: 'Validates S2: cupboard list --json returns JSON array containing the created task.
      '
    inputs:
      setup:
      - cupboard create --type task --title "Listed task" --description "Should appear in list" --json
      command: cupboard list --json
    expected:
      exit_code: 0
      stdout_json:
        type: array
        min_length: 1
        items_contain:
          title: Listed task
          type: task
  - name: List empty cupboard returns empty JSON array
    inputs:
      command: cupboard list --json
    expected:
      exit_code: 0
      stdout_json:
        length: 0
  - name: Show displays title, state, type, and description
    description: 'Validates S3: cupboard show <id> displays title, state, type, and description in human-readable format.
      '
    inputs:
      setup:
      - cupboard create --type task --title "Visible task" --description "Full details here" --json
      command: cupboard show ${crumb_id}
    expected:
      exit_code: 0
      stdout_contains: Full details here
  - name: Show with JSON output returns full crumb object
    inputs:
      setup:
      - cupboard create --type task --title "JSON show" --description "Machine readable" --json
      command: cupboard show ${crumb_id} --json
    expected:
      exit_code: 0
      stdout_json:
        title: JSON show
        type: task
        state: open
        description: Machine readable
  - name: Show nonexistent ID returns error
    inputs:
      command: cupboard show nonexistent-uuid-12345
    expected:
      exit_code: 1
      stderr_contains: not found
  - name: Ready returns JSON array including open tasks
    description: 'Validates S4: cupboard ready --json --type task returns JSON array including open tasks.
      '
    inputs:
      setup:
      - cupboard create --type task --title "Ready task" --description "Available for work" --json
      command: cupboard ready --json --type task
    expected:
      exit_code: 0
      stdout_json:
        type: array
        min_length: 1
        items_contain:
          title: Ready task
          state: open
          type: task
  - name: Ready filters by type
    inputs:
      setup:
      - cupboard create --type epic --title "An epic" --description "Not a task"
      - cupboard create --type task --title "A task" --description "This one"
      command: cupboard ready --json --type task
    expected:
      exit_code: 0
      stdout_json:
        length: 1
        items:
        - type: task
  - name: Ready with limit returns at most n results
    inputs:
      setup:
      - cupboard create --type task --title "Task 1" --description "First"
      - cupboard create --type task --title "Task 2" --description "Second"
      - cupboard create --type task --title "Task 3" --description "Third"
      command: cupboard ready -n 2 --json --type task
    expected:
      exit_code: 0
      stdout_json:
        max_length: 2
  - name: Update status to in_progress succeeds with confirmation
    description: 'Validates S5: cupboard update <id> --status in_progress exits with code 0 and confirmation message.
      '
    inputs:
      setup:
      - cupboard create --type task --title "Claimable task" --description "Ready to claim" --json
      command: cupboard update ${crumb_id} --status in_progress
    expected:
      exit_code: 0
      stdout_contains: Updated
  - name: Update status to in_progress changes state
    inputs:
      setup:
      - cupboard create --type task --title "State change" --description "Will transition" --json
      command: cupboard update ${crumb_id} --status in_progress
    expected:
      exit_code: 0
    verify:
      command: cupboard show ${crumb_id} --json
      stdout_json:
        state: in_progress
  - name: Update nonexistent ID fails
    inputs:
      command: cupboard update nonexistent-uuid-12345 --status in_progress
    expected:
      exit_code: 1
      stderr_contains: not found
  - name: Ready excludes tasks not in open state
    description: 'Validates S6: cupboard ready --json --type task excludes tasks no longer in open state.
      '
    inputs:
      setup:
      - cupboard create --type task --title "Open task" --description "Still available"
      - cupboard create --type task --title "Claimed task" --description "Already taken" --json
      - cupboard update ${crumb_id} --status in_progress
      command: cupboard ready --json --type task
    expected:
      exit_code: 0
      stdout_json:
        length: 1
        items:
        - title: Open task
  - name: Ready returns empty when all tasks claimed
    inputs:
      setup:
      - cupboard create --type task --title "Only task" --description "Will be claimed" --json
      - cupboard update ${crumb_id} --status in_progress
      command: cupboard ready --json --type task
    expected:
      exit_code: 0
      stdout_json:
        length: 0
  - name: Comments add exits with confirmation
    description: 'Validates S7: cupboard comments add <id> ''text'' exits with code 0 and confirmation message.
      '
    inputs:
      setup:
      - cupboard create --type task --title "Commentable" --description "Has comments" --json
      command: 'cupboard comments add ${crumb_id} "tokens: 34256"'
    expected:
      exit_code: 0
      stdout_contains: Added
  - name: Comments add to nonexistent ID fails
    inputs:
      command: cupboard comments add nonexistent-uuid-12345 "orphan comment"
    expected:
      exit_code: 1
      stderr_contains: not found
  - name: Show includes comment text in output
    description: 'Validates S8: cupboard show <id> includes comment text in output.
      '
    inputs:
      setup:
      - cupboard create --type task --title "Task with comment" --description "Will have note" --json
      - cupboard comments add ${crumb_id} "Work session note: completed review"
      command: cupboard show ${crumb_id}
    expected:
      exit_code: 0
      stdout_contains: 'Work session note: completed review'
  - name: Show includes multiple comments
    inputs:
      setup:
      - cupboard create --type task --title "Multi-comment task" --description "Several notes" --json
      - cupboard comments add ${crumb_id} "First comment"
      - cupboard comments add ${crumb_id} "Second comment"
      command: cupboard show ${crumb_id}
    expected:
      exit_code: 0
      stdout_contains: Second comment
  - name: Close exits with confirmation
    description: 'Validates S9: cupboard close <id> exits with code 0 and confirmation message.
      '
    inputs:
      setup:
      - cupboard create --type task --title "To be closed" --description "Will close" --json
      command: cupboard close ${crumb_id}
    expected:
      exit_code: 0
      stdout_contains: Closed
  - name: Close nonexistent ID fails
    inputs:
      command: cupboard close nonexistent-uuid-12345
    expected:
      exit_code: 1
      stderr_contains: not found
  - name: Show confirms state is closed after close command
    description: 'Validates S10: cupboard show <id> shows state as closed after close command.
      '
    inputs:
      setup:
      - cupboard create --type task --title "Closed task" --description "State verified" --json
      - cupboard close ${crumb_id}
      command: cupboard show ${crumb_id}
    expected:
      exit_code: 0
      stdout_contains: closed
  - name: Show with JSON confirms closed state
    inputs:
      setup:
      - cupboard create --type task --title "JSON closed" --description "Verify JSON" --json
      - cupboard close ${crumb_id}
      command: cupboard show ${crumb_id} --json
    expected:
      exit_code: 0
      stdout_json:
        state: closed
  - name: Ready excludes closed tasks
    inputs:
      setup:
      - cupboard create --type task --title "Open for work" --description "Available"
      - cupboard create --type task --title "Already done" --description "Completed" --json
      - cupboard close ${crumb_id}
      command: cupboard ready --json --type task
    expected:
      exit_code: 0
      stdout_json:
        length: 1
        items:
        - title: Open for work
  - name: Full issue-tracking workflow
    description: 'Exercises the complete flow from F1-F14 in the use case: create task, verify with list and show, claim with
      update, add comment, close, and confirm final state.
      '
    inputs:
      steps:
      - command: cupboard create --type task --title "Workflow task" --description "End-to-end test" --json
        capture: task_id
      - command: cupboard list --json
        verify:
          stdout_json:
            min_length: 1
      - command: cupboard show ${task_id}
        verify:
          stdout_contains: Workflow task
      - command: cupboard ready --json --type task
        verify:
          stdout_json:
            min_length: 1
      - command: cupboard update ${task_id} --status in_progress
      - command: cupboard show ${task_id}
        verify:
          stdout_contains: in_progress
      - command: cupboard comments add ${task_id} "Session complete"
      - command: cupboard show ${task_id}
        verify:
          stdout_contains: Session complete
      - command: cupboard close ${task_id}
      - command: cupboard show ${task_id}
        verify:
          stdout_contains: closed
      - command: cupboard ready --json --type task
        verify:
          stdout_json:
            not_contains:
              title: Workflow task
    expected:
      exit_code: 0
  - name: Create epic with labels
    description: 'Validates F4 from use case: create epic with --labels flag to set categorical and list properties.
      '
    inputs:
      command: cupboard create --type epic --title "Storage layer" --labels "code,infra" --json
    expected:
      exit_code: 0
      stdout_json:
        type: epic
        title: Storage layer
        labels:
        - code
        - infra
  # --- uc: rel02.1-uc002-table-benchmarks: Table interface performance benchmarks ---

  - name: Get benchmark with 10 crumbs
    description: 'Measure Table.Get latency with 10 seeded crumbs. Benchmark uses random ID selection to measure average lookup
      time.
      '
    inputs:
      command: go test -bench=BenchmarkCrumbsGet10 -benchmem ./tests/integration/...
      data_size: 10
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsGet10
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true
  - name: Get benchmark with 100 crumbs
    inputs:
      command: go test -bench=BenchmarkCrumbsGet100 -benchmem ./tests/integration/...
      data_size: 100
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsGet100
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true
  - name: Get benchmark with 1000 crumbs
    inputs:
      command: go test -bench=BenchmarkCrumbsGet1000 -benchmem ./tests/integration/...
      data_size: 1000
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsGet1000
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true
  - name: Get benchmark with 10000 crumbs
    inputs:
      command: go test -bench=BenchmarkCrumbsGet10000 -benchmem ./tests/integration/...
      data_size: 10000
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsGet10000
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true
  - name: Set create benchmark with 10 existing crumbs
    description: 'Measure Table.Set latency for creating new crumbs (empty ID triggers UUID v7 generation). Includes JSONL sync
      cost per prd002-sqlite-backend R5.3.
      '
    inputs:
      command: go test -bench=BenchmarkCrumbsSetCreate10 -benchmem ./tests/integration/...
      data_size: 10
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsSetCreate10
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true
  - name: Set create benchmark with 1000 existing crumbs
    inputs:
      command: go test -bench=BenchmarkCrumbsSetCreate1000 -benchmem ./tests/integration/...
      data_size: 1000
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsSetCreate1000
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true
  - name: Set update benchmark with 10 crumbs
    description: 'Measure Table.Set latency for updating existing crumbs. Includes JSONL sync cost per prd002-sqlite-backend
      R5.3.
      '
    inputs:
      command: go test -bench=BenchmarkCrumbsSetUpdate10 -benchmem ./tests/integration/...
      data_size: 10
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsSetUpdate10
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true
  - name: Set update benchmark with 1000 crumbs
    inputs:
      command: go test -bench=BenchmarkCrumbsSetUpdate1000 -benchmem ./tests/integration/...
      data_size: 1000
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsSetUpdate1000
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true
  - name: Delete benchmark with 10 crumbs
    description: 'Measure Table.Delete latency including cascade deletion of property values, metadata, and links per prd003-crumbs-interface
      R8.3. Each iteration creates then deletes a crumb.
      '
    inputs:
      command: go test -bench=BenchmarkCrumbsDelete10 -benchmem ./tests/integration/...
      data_size: 10
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsDelete10
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true
  - name: Delete benchmark with 1000 crumbs
    inputs:
      command: go test -bench=BenchmarkCrumbsDelete1000 -benchmem ./tests/integration/...
      data_size: 1000
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsDelete1000
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true
  - name: Fetch all benchmark with 100 crumbs
    description: 'Measure Table.Fetch latency with empty filter (returns all crumbs). Exercises full table scan with entity
      hydration.
      '
    inputs:
      command: go test -bench=BenchmarkCrumbsFetchAll100 -benchmem ./tests/integration/...
      data_size: 100
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsFetchAll100
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true
  - name: Fetch all benchmark with 1000 crumbs
    inputs:
      command: go test -bench=BenchmarkCrumbsFetchAll1000 -benchmem ./tests/integration/...
      data_size: 1000
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsFetchAll1000
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true
  - name: Fetch with state filter benchmark 100 crumbs
    description: 'Measure Table.Fetch with state filter. Exercises idx_crumbs_state index per prd002-sqlite-backend R3.3.
      '
    inputs:
      command: go test -bench=BenchmarkCrumbsFetchState100 -benchmem ./tests/integration/...
      data_size: 100
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsFetchState100
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true
  - name: Fetch with state filter benchmark 1000 crumbs
    inputs:
      command: go test -bench=BenchmarkCrumbsFetchState1000 -benchmem ./tests/integration/...
      data_size: 1000
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsFetchState1000
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true
  - name: Fetch with properties filter benchmark 100 crumbs
    description: 'Measure Table.Fetch with crumbs that have properties set. Exercises crumb_properties table hydration.
      '
    inputs:
      command: go test -bench=BenchmarkCrumbsFetchProperties100 -benchmem ./tests/integration/...
      data_size: 100
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsFetchProperties100
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true
  - name: Fetch with properties filter benchmark 1000 crumbs
    inputs:
      command: go test -bench=BenchmarkCrumbsFetchProperties1000 -benchmem ./tests/integration/...
      data_size: 1000
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsFetchProperties1000
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true
  - name: Fetch with limit simulation benchmark
    description: 'Measure Table.Fetch from 1000 crumbs simulating limit behavior. Fetches all then takes first 10 to establish
      baseline for future limit filter support.
      '
    inputs:
      command: go test -bench=BenchmarkCrumbsFetchLimit100 -benchmem ./tests/integration/...
      data_size: 1000
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbsFetchLimit100
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true
  - name: SetProperty benchmark with 10 crumbs
    description: 'Measure Crumb.SetProperty + Table.Set latency. Includes Get, SetProperty, and Set to persist with JSONL write
      for crumb_properties.
      '
    inputs:
      command: go test -bench=BenchmarkCrumbSetProperty10 -benchmem ./tests/integration/...
      data_size: 10
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbSetProperty10
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true
  - name: SetProperty benchmark with 1000 crumbs
    inputs:
      command: go test -bench=BenchmarkCrumbSetProperty1000 -benchmem ./tests/integration/...
      data_size: 1000
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbSetProperty1000
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true
  - name: GetProperty benchmark with 10 crumbs
    description: 'Measure Crumb.GetProperty latency. This is a read-only operation on the in-memory Properties map. Benchmarks
      in-memory crumb objects without database access.
      '
    inputs:
      command: go test -bench=BenchmarkCrumbGetProperty10 -benchmem ./tests/integration/...
      data_size: 10
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbGetProperty10
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true
  - name: GetProperty benchmark with 1000 crumbs
    inputs:
      command: go test -bench=BenchmarkCrumbGetProperty1000 -benchmem ./tests/integration/...
      data_size: 1000
    expected:
      exit_code: 0
      stdout_contains: BenchmarkCrumbGetProperty1000
      benchmark_output:
        ns_op_reported: true
        b_op_reported: true
        allocs_op_reported: true
  # --- uc: rel02.1-uc003-self-hosting: Self-hosting issue-tracking workflow ---

  - name: Initialize cupboard
    inputs:
      command: cupboard init
    expected:
      exit_code: 0
      stdout_contains: output message
      state:
        data_directory_exists: true
        crumbs_jsonl_exists: true
  - name: Create task with required fields
    inputs:
      command: cupboard set crumbs "" '{"Name":"Implement feature","State":"draft"}'
    expected:
      exit_code: 0
      stdout_contains: CrumbID
  - name: Create task with JSON output
    inputs:
      command: cupboard set crumbs "" '{"Name":"Write tests","State":"draft"}'
    expected:
      exit_code: 0
      stdout_json:
        Name: Write tests
        State: draft
    verify:
      command: cupboard list crumbs
      stdout_contains: '"State": "draft"'
  - name: Create epic with labels
    inputs:
      command: cupboard set crumbs "" '{"Name":"Storage layer","State":"draft"}'
    expected:
      exit_code: 0
      stdout_contains: CrumbID
  - name: Create task with parent
    description: 'Create a parent crumb first, then create a child crumb. Parent-child relationships use the links table, not
      inline JSON fields.
      '
    inputs:
      setup:
      - cupboard set crumbs "" '{"Name":"Parent epic","State":"draft"}'
      command: cupboard set crumbs "" '{"Name":"Child task","State":"draft"}'
    expected:
      exit_code: 0
      stdout_contains: CrumbID
  - name: Create without name succeeds
    description: 'Current CLI does not enforce required Name field. Set without Name succeeds but creates a crumb with empty
      Name.
      '
    inputs:
      command: cupboard set crumbs "" '{"State":"draft"}'
    expected:
      exit_code: 0
  - name: Create without state defaults
    inputs:
      command: cupboard set crumbs "" '{"Name":"No state provided"}'
    expected:
      exit_code: 0
  - name: List returns all crumbs as JSON
    inputs:
      setup:
      - cupboard set crumbs "" '{"Name":"Task A","State":"draft"}'
      - cupboard set crumbs "" '{"Name":"Task B","State":"draft"}'
      command: cupboard list crumbs
    expected:
      exit_code: 0
      stdout_json:
        length: 2
  - name: List empty cupboard returns empty array
    inputs:
      command: cupboard list crumbs
    expected:
      exit_code: 0
      stdout_json:
        length: 0
  - name: Show displays crumb details
    inputs:
      setup:
      - cupboard set crumbs "" '{"Name":"Visible task","State":"draft"}'
      command: cupboard get crumbs ${crumb_id}
    expected:
      exit_code: 0
      stdout_contains: Visible task
  - name: Show nonexistent ID fails
    inputs:
      command: cupboard get crumbs nonexistent-id
    expected:
      exit_code: 1
  - name: Update status to taken (in_progress)
    inputs:
      setup:
      - cupboard set crumbs "" '{"Name":"Claimable","State":"draft"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Updated","State":"taken"}'
    expected:
      exit_code: 0
    verify:
      command: cupboard get crumbs ${crumb_id}
      stdout_contains: taken
  - name: Update status to pebble (closed)
    inputs:
      setup:
      - cupboard set crumbs "" '{"Name":"Closeable","State":"draft"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Updated","State":"pebble"}'
    expected:
      exit_code: 0
    verify:
      command: cupboard get crumbs ${crumb_id}
      stdout_contains: pebble
  - name: Close sets state to pebble
    inputs:
      setup:
      - cupboard set crumbs "" '{"Name":"To close","State":"draft"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Closed","State":"pebble"}'
    expected:
      exit_code: 0
    verify:
      command: cupboard get crumbs ${crumb_id}
      stdout_contains: pebble
  - name: Close already-closed crumb succeeds
    inputs:
      setup:
      - cupboard set crumbs "" '{"Name":"Already closed","State":"draft"}'
      - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Already closed","State":"pebble"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Closed","State":"pebble"}'
    expected:
      exit_code: 0
    verify:
      command: cupboard get crumbs ${crumb_id}
      stdout_contains: pebble
  - name: Ready returns draft crumbs (open tasks)
    inputs:
      setup:
      - cupboard set crumbs "" '{"Name":"Open task","State":"draft"}'
      - cupboard set crumbs "" '{"Name":"Claimed task","State":"draft"}'
      - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Claimed task","State":"taken"}'
      command: cupboard list crumbs State=draft
    expected:
      exit_code: 0
      stdout_json:
        length: 1
  - name: Ready with no open tasks returns empty
    inputs:
      setup:
      - cupboard set crumbs "" '{"Name":"Only task","State":"draft"}'
      - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Only task","State":"pebble"}'
      command: cupboard list crumbs State=draft
    expected:
      exit_code: 0
      stdout_json:
        length: 0
  - name: Do-work cycle
    description: 'Simulates the do-work workflow: create task, list ready tasks (draft), claim task (set state to taken), close
      task (set state to pebble). Comments are not yet implemented; token tracking step is skipped.
      '
    inputs:
      setup:
      - cupboard set crumbs "" '{"Name":"Build widget","State":"draft"}'
      steps:
      - command: cupboard list crumbs State=draft
        verify: length equals 1
      - command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Build widget","State":"taken"}'
      - command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Build widget","State":"pebble"}'
    expected:
      exit_code: 0
    verify:
      command: cupboard get crumbs ${crumb_id}
      stdout_contains: pebble
  - name: Make-work cycle
    description: 'Simulates the make-work workflow: list existing issues, create an epic, create child tasks. Parent links use
      the links table (not tested here).
      '
    inputs:
      setup:
      - cupboard set crumbs "" '{"Name":"Existing task","State":"draft"}'
      steps:
      - command: cupboard list crumbs
        verify: length equals 1
      - command: cupboard set crumbs "" '{"Name":"New epic","State":"draft"}'
      - command: cupboard set crumbs "" '{"Name":"New task 1","State":"draft"}'
      - command: cupboard set crumbs "" '{"Name":"New task 2","State":"draft"}'
    expected:
      exit_code: 0
    verify:
      command: cupboard list crumbs
      stdout_json:
        length: 4
  - name: JSONL persistence
    description: 'Validates that crumb data is persisted to crumbs.jsonl file.
      '
    inputs:
      setup:
      - cupboard set crumbs "" '{"Name":"Crumb 1","State":"draft"}'
      - cupboard set crumbs "" '{"Name":"Crumb 2","State":"draft"}'
      - cupboard set crumbs "" '{"Name":"Crumb 3","State":"draft"}'
    expected:
      exit_code: 0
      state:
        crumbs_jsonl_count: 3
  # --- uc: rel02.1-uc004-metadata-lifecycle: Metadata lifecycle operations ---

  - name: Create comment with empty ID generates UUID v7
    description: Calling Table.Set on metadata table with empty ID and comments schema generates a UUID v7 identifier.
    inputs:
      setup:
      - Create a crumb to attach metadata to
      action: "metadata := &types.Metadata{\n    CrumbID:   crumbID,\n    TableName: \"comments\",\n    Content:   \"This is\
        \ a test comment\",\n}\nid, err := metadataTable.Set(\"\", metadata)\n"
    expected:
      error: nil
      state:
        id_not_empty: true
        metadata_id_format: uuid_v7
        metadata_id_matches_returned: true
        metadata_created_at_set: true
  - name: Create attachment with empty ID generates UUID v7
    description: Calling Table.Set on metadata table with empty ID and attachments schema generates a UUID v7 identifier.
    inputs:
      setup:
      - Create a crumb to attach metadata to
      action: "metadata := &types.Metadata{\n    CrumbID:   crumbID,\n    TableName: \"attachments\",\n    Content:   `{\"name\"\
        :\"test.txt\",\"path\":\"/attachments/test.txt\"}`,\n}\nid, err := metadataTable.Set(\"\", metadata)\n"
    expected:
      error: nil
      state:
        id_not_empty: true
        metadata_id_format: uuid_v7
        metadata_id_matches_returned: true
        metadata_created_at_set: true
  - name: Multiple comments accumulate on same crumb
    description: Adding multiple comment metadata entries does not replace previous entries.
    inputs:
      setup:
      - Create a crumb
      action: 'Add first comment with content "First comment"
        Add second comment with content "Second comment"
        '
    expected:
      error: nil
      state:
        ids_are_different: true
        total_metadata_count: 2
        first_comment_exists: true
        first_comment_content: First comment
  - name: Comments and attachments coexist on same crumb
    description: A crumb can have both comment and attachment metadata entries.
    inputs:
      setup:
      - Create a crumb
      action: 'Add comment with content "A comment"
        Add attachment with content `{"name":"file.txt"}`
        '
    expected:
      error: nil
      state:
        total_metadata_count: 2
  - name: Comment stores plain text content
    description: Metadata with comments schema stores Content as plain text including special characters.
    inputs:
      setup:
      - Create a crumb
      action: "metadata := &types.Metadata{\n    CrumbID:   crumbID,\n    TableName: \"comments\",\n    Content:   \"This is\
        \ a plain text comment with special chars: <>&\\\"'\",\n}\nid, err := metadataTable.Set(\"\", metadata)\nentity, err\
        \ := metadataTable.Get(id)\n"
    expected:
      error: nil
      state:
        retrieved_content: 'This is a plain text comment with special chars: <>&"'''
  - name: Attachment stores JSON content
    description: Metadata with attachments schema stores Content as JSON string that can be parsed.
    inputs:
      setup:
      - Create a crumb
      action: "jsonContent := `{\"name\":\"screenshot.png\",\"path\":\"/attachments/img.png\",\"mime_type\":\"image/png\",\"\
        size_bytes\":102400}`\nmetadata := &types.Metadata{\n    CrumbID:   crumbID,\n    TableName: \"attachments\",\n    Content:\
        \   jsonContent,\n}\nid, err := metadataTable.Set(\"\", metadata)\nentity, err := metadataTable.Get(id)\n"
    expected:
      error: nil
      state:
        retrieved_content_is_valid_json: true
        json_field_name: screenshot.png
        json_field_mime_type: image/png
  - name: Get retrieves metadata with matching fields
    description: Table.Get returns metadata with all fields matching what was created.
    inputs:
      setup:
      - Create a crumb
      - Create a comment metadata entry with content "Test comment for retrieval"
      action: Retrieve metadata by ID using metadataTable.Get(id)
    expected:
      error: nil
      state:
        metadata_id_matches: true
        crumb_id_matches: true
        table_name_matches: comments
        content_matches: true
        created_at_set: true
  - name: Fetch with schema filter returns comments only
    description: Table.Fetch with TableName=comments filter returns only comment entries.
    inputs:
      setup:
      - Create a crumb
      - Add two comments
      - Add two attachments
      action: 'Fetch with filter {"TableName": "comments"}'
    expected:
      error: nil
      state:
        result_count: 2
        all_results_have_table_name: comments
  - name: Fetch with schema filter returns attachments only
    description: Table.Fetch with TableName=attachments filter returns only attachment entries.
    inputs:
      setup:
      - Create a crumb
      - Add two comments
      - Add two attachments
      action: 'Fetch with filter {"TableName": "attachments"}'
    expected:
      error: nil
      state:
        result_count: 2
        all_results_have_table_name: attachments
  - name: Fetch with crumb_id filter returns entries for specific crumb
    description: Table.Fetch with CrumbID filter returns only metadata for that crumb.
    inputs:
      setup:
      - Create crumb A with two comments
      - Create crumb B with one comment
      action: 'Fetch with filter {"CrumbID": crumbA}
        Fetch with filter {"CrumbID": crumbB}
        '
    expected:
      error: nil
      state:
        crumb_a_result_count: 2
        crumb_b_result_count: 1
        all_results_for_crumb_a_have_correct_id: true
  - name: Fetch with crumb_id for crumb with no metadata returns empty
    description: Table.Fetch with CrumbID filter for crumb without metadata returns empty slice.
    inputs:
      setup:
      - Create crumb A with one comment
      - Create crumb B without metadata
      action: 'Fetch with filter {"CrumbID": crumbB}'
    expected:
      error: nil
      state:
        result_count: 0
  - name: Fetch with schema and crumb_id filters returns intersection
    description: Table.Fetch with both TableName and CrumbID filters returns entries matching both.
    inputs:
      setup:
      - Create crumb A with one comment and one attachment
      - Create crumb B with two comments
      action: 'Fetch with filter {"TableName": "comments", "CrumbID": crumbA}'
    expected:
      error: nil
      state:
        result_count: 1
        result_table_name: comments
        result_crumb_id: crumbA
  - name: Get nonexistent metadata returns ErrNotFound
    description: Table.Get with a nonexistent metadata ID returns ErrNotFound.
    inputs:
      action: metadataTable.Get("nonexistent-uuid-12345")
    expected:
      error: ErrNotFound
  - name: Get with empty ID returns ErrInvalidID
    description: Table.Get with an empty ID returns ErrInvalidID.
    inputs:
      action: metadataTable.Get("")
    expected:
      error: ErrInvalidID
  - name: Delete crumb cascades to metadata
    description: When a crumb is deleted, all its metadata entries are also deleted.
    inputs:
      setup:
      - Create a crumb
      - Add two comments to the crumb
      - Add one attachment to the crumb
      - Verify 3 metadata entries exist
      action: 'Delete all metadata for the crumb (simulating cascade)
        Delete the crumb
        '
    expected:
      error: nil
      state:
        crumb_deleted: true
        metadata_count_before_delete: 3
        metadata_count_after_delete: 0
  - name: Cascade delete only affects target crumb metadata
    description: Deleting one crumb does not affect metadata on other crumbs.
    inputs:
      setup:
      - Create crumb A with two comments
      - Create crumb B with one comment
      action: 'Delete metadata for crumb A (simulating cascade)
        Delete crumb A
        Fetch metadata for crumb B
        '
    expected:
      error: nil
      state:
        crumb_b_metadata_count: 1
        crumb_b_metadata_intact: true
        crumb_b_content: Comment on B
  - name: Fetch from empty table returns empty result
    description: Table.Fetch with nil filter on empty metadata table returns empty slice without error.
    inputs:
      setup:
      - No metadata entries exist
      action: metadataTable.Fetch(nil)
    expected:
      error: nil
      state:
        result_count: 0
  - name: Delete nonexistent metadata returns ErrNotFound
    description: Table.Delete with a nonexistent metadata ID returns ErrNotFound.
    inputs:
      action: metadataTable.Delete("nonexistent-uuid-12345")
    expected:
      error: ErrNotFound
  - name: Delete metadata with empty ID returns ErrInvalidID
    description: Table.Delete with an empty ID returns ErrInvalidID.
    inputs:
      action: metadataTable.Delete("")
    expected:
      error: ErrInvalidID

cleanup:
  - Remove temp config and data directories
  - Remove temp data directories created by benchmarks
  - Remove temp data directory
