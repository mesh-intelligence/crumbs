id: prd004-properties-interface
title: Properties Interface
problem: |
  Applications need extensible attributes on crumbs beyond the core fields (name, state, timestamps). A task tracker might need priority, labels, and owner; a bug tracker might need severity and component. Hardcoding these fields into the Crumb struct creates rigid schemas that require code changes and migrations for every new attribute.

  We need a property system where applications can define custom attributes at runtime. Properties are metadata definitions (name, type, description) that can then be assigned values on individual crumbs. This separates schema (what properties exist) from data (what values crumbs have), enabling flexibility without migrations.

  This PRD defines the Property and Category entities: their struct fields and entity methods. Properties and categories are stored and retrieved via the generic Table interface from prd001-cupboard-core. Setting and getting property values on crumbs is handled by Crumb entity methods (see prd003-crumbs-interface); this PRD covers only the property definitions themselves.

  Future scope: VISION.md establishes that properties are a general mechanism extending crumbs, trails, and stashes uniformly. This PRD specifies crumb properties for the current release. Trail properties (e.g., hypothesis, approach, risk-level for exploration sessions) and stash properties (e.g., build-stage, artifact-type, retention-policy for shared state) will follow the same pattern in later releases.
goals:
- id: G1
  goal: Define the Property struct with all required fields
- id: G2
  goal: Define the Category struct for categorical properties
- id: G3
  goal: Define value types and their meaning
- id: G4
  goal: Specify entity method DefineCategory for creating categories on a property
- id: G5
  goal: Specify how properties are created, retrieved, and queried via the Table interface
- id: G6
  goal: Document built-in properties seeded on first startup
- id: G7
  goal: Document error conditions for all operations
requirements:
- group: R1
  title: Property Struct
  items:
  - id: R1.1
    requirement: The Property struct must include the following fields
  - id: R1.2
    requirement: PropertyID must be a UUID v7 (time-ordered) generated by the backend
      when Table.Set is called with an empty id parameter
  - id: R1.3
    requirement: Name must be unique across all properties. Table.Set must reject
      duplicate names with ErrDuplicateName
  - id: R1.4
    requirement: Name must be non-empty. Table.Set must reject empty names with ErrInvalidName
  - id: R1.5
    requirement: Description may be empty
- group: R2
  title: Category Struct
  items:
  - id: R2.1
    requirement: The Category struct must include the following fields
  - id: R2.2
    requirement: CategoryID must be a UUID v7 (time-ordered) generated by the backend
      when Table.Set is called with an empty id parameter
  - id: R2.3
    requirement: Categories enable ordered enumeration for categorical properties.
      When a crumb has a categorical property value, the value is a CategoryID
  - id: R2.4
    requirement: Name must be unique within a property. Table.Set must reject duplicate
      names for the same property with ErrDuplicateName
  - id: R2.5
    requirement: Ordinal determines display order. Categories with lower ordinals
      appear first. Multiple categories may share the same ordinal (ties broken by
      name)
- group: R3
  title: Value Types
  items:
  - id: R3.1
    requirement: A property must have exactly one of the following value types
  - id: R3.2
    requirement: ValueType is stored as a string, not an enum, for JSON compatibility
  - id: R3.3
    requirement: Crumb.SetProperty validates that values match the property's ValueType
      (see prd003-crumbs-interface R5)
  - id: R3.4
    requirement: For categorical properties, values must be valid CategoryIDs defined
      for that property
  - id: R3.5
    requirement: Each value type has a default value used when initializing properties
      on crumbs
  - id: R3.6
    requirement: Default values ensure every crumb has a value for every defined property.
      There is no concept of a property being "not set" on a crumb
- group: R4
  title: Creating Properties
  items:
  - id: R4.1
    requirement: To create a new property, the caller constructs a Property struct
      and passes it to Table.Set
  - id: R4.2
    requirement: When Table.Set is called with an empty id parameter, the backend
      must generate a UUID v7 for PropertyID, set CreatedAt to the current time, validate
      that Name is non-empty (ErrInvalidName if empty), validate that Name is unique
      (ErrDuplicateName if exists), validate that ValueType is one of the valid types
      in R3.1 (ErrInvalidValueType if not), and initialize the property on all existing
      crumbs with the type's default value (see R3.5)
  - id: R4.3
    requirement: Property initialization on existing crumbs (backfill) is atomic with
      property creation. If backfill fails, the property is not created
  - id: R4.4
    requirement: Table.Set returns the generated PropertyID and any error. After successful
      creation, the Property struct is updated with the generated PropertyID and CreatedAt
      timestamp
  - id: R4.5
    requirement: Table.Set must persist the property before returning
- group: R5
  title: Retrieving Properties
  items:
  - id: R5.1
    requirement: To retrieve a property by ID, use Table.Get
  - id: R5.2
    requirement: Table.Get returns the entity as any; the caller must type-assert
      to *Property
  - id: R5.3
    requirement: Table.Get returns ErrNotFound if no property exists with the given
      ID
  - id: R5.4
    requirement: Table.Get returns ErrInvalidID if id is empty
- group: R6
  title: Querying Properties
  items:
  - id: R6.1
    requirement: To retrieve all properties, use Table.Fetch with an empty filter
  - id: R6.2
    requirement: Table.Fetch returns a slice of entities ([]any); the caller must
      type-assert each element to *Property
  - id: R6.3
    requirement: Table.Fetch returns an empty slice (not nil) if no properties exist
  - id: R6.4
    requirement: Results are ordered by CreatedAt ascending (oldest first, built-ins
      first)
- group: R7
  title: DefineCategory Entity Method
  items:
  - id: R7.1
    requirement: DefineCategory is an entity method on Property that creates a new
      category
  - id: R7.2
    requirement: DefineCategory must validate that the property's ValueType is "categorical"
      (ErrInvalidValueType if not)
  - id: R7.3
    requirement: DefineCategory must validate that name is non-empty (ErrInvalidName
      if empty)
  - id: R7.4
    requirement: DefineCategory must validate that name is unique within the property
      (ErrDuplicateName if exists)
  - id: R7.5
    requirement: DefineCategory must create a Category struct with a UUID v7 for CategoryID
      (generated by the backend), PropertyID set to the property's ID, and the provided
      name and ordinal
  - id: R7.6
    requirement: DefineCategory must persist the category to backend storage. The
      backend manages category storage internally (e.g., SQLite backend uses categories.jsonl)
  - id: R7.7
    requirement: DefineCategory must return the created Category with all fields populated
  - id: R7.8
    requirement: Ordinal may be any integer. Negative ordinals are allowed
  - id: R7.9
    requirement: DefineCategory requires the Cupboard reference to access backend
      storage for categories
- group: R8
  title: GetCategories Entity Method
  items:
  - id: R8.1
    requirement: GetCategories is an entity method on Property that retrieves all
      categories for the property
  - id: R8.2
    requirement: GetCategories must validate that the property's ValueType is "categorical"
      (ErrInvalidValueType if not)
  - id: R8.3
    requirement: GetCategories must query backend storage for categories with a filter
      for PropertyID
  - id: R8.4
    requirement: GetCategories must return categories ordered by ordinal ascending,
      then name ascending for ties
  - id: R8.5
    requirement: GetCategories must return an empty slice (not nil) if no categories
      are defined for the property
  - id: R8.6
    requirement: GetCategories requires the Cupboard reference to access backend storage
      for categories
- group: R9
  title: Built-in Properties
  items:
  - id: R9.1
    requirement: On first startup (when properties storage is empty), the backend
      must seed the following built-in properties
  - id: R9.2
    requirement: Built-in categories for "priority" property
  - id: R9.3
    requirement: Built-in categories for "type" property
  - id: R9.4
    requirement: Seeding only occurs when the properties storage is empty (first run).
      Existing data is never modified by seeding
  - id: R9.5
    requirement: Built-in properties can be extended (new categories added) but not
      deleted or renamed
  - id: R9.6
    requirement: Applications may define additional properties beyond the built-ins
- group: R10
  title: Error Types
  items:
  - id: R10.1
    requirement: Property and Category operations must return the following sentinel
      errors
  - id: R10.2
    requirement: All errors must be checkable with errors.Is
non_goals:
- This PRD does not define setting or getting property values on crumbs. See prd003-crumbs-interface
  for SetProperty, GetProperty, GetProperties, and ClearProperty
- This PRD does not define property deletion. Properties are permanent once defined.
  Applications can stop using a property but cannot remove its definition
- This PRD does not define property modification (renaming, changing type). Properties
  are immutable after creation
- This PRD does not define property inheritance or computed properties
- This PRD does not define validation rules beyond type checking (e.g., regex patterns,
  min/max values)
- This PRD does not define a specialized PropertyTable interface. Properties and categories
  are accessed via the standard Table interface from prd001-cupboard-core
acceptance_criteria:
- id: AC1
  criterion: Property struct defined with PropertyID, Name, Description, ValueType,
    CreatedAt
- id: AC2
  criterion: Category struct defined with CategoryID, PropertyID, Name, Ordinal
- id: AC3
  criterion: Value types documented (categorical, text, integer, boolean, timestamp,
    list)
- id: AC4
  criterion: Default values documented for each value type (R3.5)
- id: AC5
  criterion: Property creation via Table.Set specified (ID generation, validation,
    backfill existing crumbs)
- id: AC6
  criterion: Property retrieval via Table.Get specified (type assertion to *Property)
- id: AC7
  criterion: Property query via Table.Fetch specified (list all properties)
- id: AC8
  criterion: DefineCategory entity method specified (create category, validation,
    persist via Table.Set)
- id: AC9
  criterion: GetCategories entity method specified (retrieve categories for a property)
- id: AC10
  criterion: Built-in properties listed (priority, type, description, owner, labels)
- id: AC11
  criterion: Built-in categories listed for priority and type
- id: AC12
  criterion: Error types documented
- id: AC13
  criterion: All requirements numbered and specific
