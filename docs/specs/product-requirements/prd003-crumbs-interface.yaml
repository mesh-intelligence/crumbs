id: prd003-crumbs-interface
title: Crumbs Interface
problem: |
  Applications need to create, retrieve, and manage individual work items (crumbs). prd001-cupboard-core defines the Cupboard interface with uniform Table access, but it does not specify the Crumb entity structure, entity methods, or how crumbs interact with the Table interface. Without this specification, implementations will make inconsistent decisions about field names, state transitions, and property handling.

  This PRD defines the Crumb entity: the struct fields, entity methods for state management and property access, and how crumbs are stored and retrieved via the Table interface. Trail membership is not stored on the Crumb; the links table (prd002-sqlite-backend) handles belongs_to relationships.
goals:
- G1: Define the Crumb struct with all required fields
- G2: Define state values and their meaning
- G3: Define entity methods for state transitions (SetState, Pebble, Dust)
- G4: Define entity methods for property access (SetProperty, GetProperty, GetProperties, ClearProperty)
- G5: Specify how crumbs are created, stored, and queried via the Table interface
- G6: Specify state validation rules for entity methods
- G7: Document error conditions for entity operations
requirements:
  R1:
    title: Crumb Struct
    items:
    - R1.1: The Crumb struct must include the following fields
    - R1.2: CrumbID must be a UUID v7 (time-ordered) generated by the backend when Table.Set is called with an empty CrumbID
    - R1.3: Name must be non-empty. Entity methods that modify name must validate non-empty
    - R1.4: Trail membership is not a Crumb field. Use the links table (belongs_to link type) to associate crumbs with trails.
        See prd002-sqlite-backend
    - R1.5: CreatedAt and UpdatedAt must be set to the current time on creation. UpdatedAt must be updated on any modification
        (state change, property change)
    - R1.6: Properties is a map from property_id to value. All defined properties are initialized with type-based defaults
        on creation (see R3)
  R2:
    title: State Values
    items:
    - R2.1: A crumb must be in exactly one of the following states
    - R2.2: Initial state on creation is draft
    - R2.3: State transitions are validated by entity methods (see R4). Direct modification of the State field bypasses validation;
        callers should use entity methods
    - R2.4: State is stored as a string, not an enum, for JSON compatibility
  R3:
    title: Creating Crumbs
    items:
    - R3.1: To create a new crumb, the caller constructs a Crumb struct and passes it to Table.Set
    - R3.2: When Table.Set is called with an empty ID, the backend must generate a UUID v7 for CrumbID, set State to "draft",
        set CreatedAt to now, set UpdatedAt to now, and initialize Properties map with all defined properties set to their
        type-based default values (see prd004-properties-interface R3.5)
    - R3.4: Table.Set must validate that Name is non-empty and return ErrInvalidName if empty
    - R3.5: After successful creation, the Crumb struct is updated with the generated CrumbID, timestamps, and initialized
        Properties
  R4:
    title: State Transition Methods
    items:
    - R4.1: The Crumb struct provides methods for common state transitions
    - R4.5: After calling any state transition method, the caller must save the crumb with Table.Set to persist the changes
  R5:
    title: Property Methods
    items:
    - R5.1: The Crumb struct provides methods for property access
    - R5.2: SetProperty assigns a value to a property. Must validate that the property exists (return ErrPropertyNotFound
        if not; requires property definitions lookup), must validate that value matches the property's value_type (return
        ErrTypeMismatch if not), for categorical properties value must be a valid category_id (return ErrInvalidCategory if
        not), must update the Properties map, must update the UpdatedAt timestamp
    - R5.3: GetProperty retrieves a single property value. Must return the value from the Properties map. Since all properties
        are initialized on crumb creation (R3.2), the property always has a value. Must return ErrPropertyNotFound if the
        property does not exist (not in Properties map)
    - R5.4: GetProperties retrieves all property values. Must return the Properties map. The map contains an entry for every
        defined property. The map is empty only if no properties are defined
    - R5.6: After calling any property method that modifies state, the caller must save the crumb with Table.Set to persist
        the changes
  R6:
    title: Retrieving Crumbs
    items:
    - R6.1: To retrieve a crumb by ID, use Table.Get
    - R6.2: Table.Get returns the entity as any; the caller must type-assert to *Crumb
    - R6.3: Table.Get returns ErrNotFound if no crumb exists with the given ID
    - R6.4: Table.Get returns ErrInvalidID if id is empty
  R7:
    title: Updating Crumbs
    items:
    - R7.1: To update a crumb, retrieve it with Table.Get, modify it with entity methods or direct field access, and save
        it with Table.Set
    - R7.2: Direct field modification (e.g., changing Name) does not automatically update UpdatedAt. The caller must update
        UpdatedAt manually when modifying fields directly
    - R7.3: Entity methods (SetState, SetProperty, etc.) automatically update UpdatedAt
    - R7.4: Table.Set validates that Name is non-empty and returns ErrInvalidName if empty
  R8:
    title: Deleting Crumbs
    items:
    - R8.1: To soft-delete a crumb, use the Dust entity method and save
    - R8.2: To hard-delete a crumb, use Table.Delete
    - R8.4: Table.Delete returns ErrNotFound if no crumb exists with the given ID
    - R8.5: Table.Delete returns ErrInvalidID if id is empty
    - R8.7: Dust crumbs remain queryable via Table.Fetch. Applications filter by state to exclude dust crumbs from active
        views
  R9:
    title: Filter Map
    items:
    - R9.1: Filters are expressed as map[string]any where keys are filter names and values are filter criteria
    - R9.2: Supported filter keys for crumbs
    - R9.3: An empty or nil filter matches all crumbs
    - R9.5: Unknown filter keys must be ignored (forward compatibility)
    - R9.6: Results are ordered by CreatedAt descending (newest first)
  R10:
    title: Querying Crumbs
    items:
    - R10.1: To query crumbs, use Table.Fetch with a filter map
    - R10.2: Table.Fetch returns a slice of entities ([]any); the caller must type-assert each element to *Crumb
    - R10.3: Table.Fetch returns an empty slice (not nil) if no crumbs match
    - R10.4: Table.Fetch applies limit and offset after filtering and ordering
    - R10.5: Table.Fetch does not return an error for an empty result set
    - R10.6: Table.Fetch returns ErrInvalidFilter if a filter value has the wrong type (e.g., "states" is not []string)
  R11:
    title: Error Types
    items:
    - R11.1: Crumb entity methods and Table operations must return the following sentinel errors
    - R11.2: All errors must be checkable with errors.Is
non_goals:
- This PRD does not define the Table interface or Cupboard interface. See prd001-cupboard-core
- This PRD does not define trail operations. See prd006-trails-interface
- This PRD does not define property definitions. See prd004-properties-interface
- This PRD does not define complex state transition rules beyond Pebble validation. Applications may add additional validation
  logic
- This PRD does not define batch operations (e.g., bulk dust, bulk update)
- This PRD does not define full-text search on crumb names or content
- This PRD does not define property validation at the entity method level. Property methods may defer validation to Table.Set
  for simplicity
acceptance_criteria:
- Crumb struct defined with CrumbID, Name, State, CreatedAt, UpdatedAt, Properties fields
- State values documented (draft, pending, ready, taken, pebble, dust)
- State transition methods defined (SetState, Pebble, Dust)
- State transition validation rules documented (Pebble requires taken state)
- Property methods defined (SetProperty, GetProperty, GetProperties, ClearProperty)
- Property method behavior documented (validation, defaults, UpdatedAt)
- Crumb creation via Table.Set specified (ID generation, state initialization, property initialization)
- Crumb retrieval via Table.Get specified (type assertion to *Crumb)
- Crumb update pattern documented (Get, modify, Set)
- Crumb deletion via Table.Delete specified (hard delete, cascade)
- Soft delete via Dust method documented
- Filter map defined with states, trail_id, parent_id, properties, limit, offset
- Query via Table.Fetch specified (filter map, type assertion, pagination)
- Error types documented (including ErrInvalidTransition)
- All requirements numbered and specific
