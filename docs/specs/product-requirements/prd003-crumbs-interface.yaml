id: prd003-crumbs-interface
title: Crumbs Interface
problem: |
  Applications need to create, retrieve, and manage individual work items (crumbs). prd001-cupboard-core defines the Cupboard interface with uniform Table access, but it does not specify the Crumb entity structure, entity methods, or how crumbs interact with the Table interface. Without this specification, implementations will make inconsistent decisions about field names, state transitions, and property handling.

  This PRD defines the Crumb entity: the struct fields, entity methods for state management and property access, and how crumbs are stored and retrieved via the Table interface. Trail membership is not stored on the Crumb; the links table (prd002-sqlite-backend) handles belongs_to relationships.
goals:
- id: G1
  goal: Define the Crumb struct with all required fields
- id: G2
  goal: Define state values and their meaning
- id: G3
  goal: Define entity methods for state transitions (SetState, Pebble, Dust)
- id: G4
  goal: Define entity methods for property access (SetProperty, GetProperty, GetProperties,
    ClearProperty)
- id: G5
  goal: Specify how crumbs are created, stored, and queried via the Table interface
- id: G6
  goal: Specify state validation rules for entity methods
- id: G7
  goal: Document error conditions for entity operations
requirements:
- group: R1
  title: Crumb Struct
  items:
  - id: R1.1
    requirement: The Crumb struct must include the following fields
  - id: R1.2
    requirement: CrumbID must be a UUID v7 (time-ordered) generated by the backend
      when Table.Set is called with an empty CrumbID
  - id: R1.3
    requirement: Name must be non-empty. Entity methods that modify name must validate
      non-empty
  - id: R1.4
    requirement: Trail membership is not a Crumb field. Use the links table (belongs_to
      link type) to associate crumbs with trails. See prd002-sqlite-backend
  - id: R1.5
    requirement: CreatedAt and UpdatedAt must be set to the current time on creation.
      UpdatedAt must be updated on any modification (state change, property change)
  - id: R1.6
    requirement: Properties is a map from property_id to value. All defined properties
      are initialized with type-based defaults on creation (see R3)
- group: R2
  title: State Values
  items:
  - id: R2.1
    requirement: A crumb must be in exactly one of the following states
  - id: R2.2
    requirement: Initial state on creation is draft
  - id: R2.3
    requirement: State transitions are validated by entity methods (see R4). Direct
      modification of the State field bypasses validation; callers should use entity
      methods
  - id: R2.4
    requirement: State is stored as a string, not an enum, for JSON compatibility
- group: R3
  title: Creating Crumbs
  items:
  - id: R3.1
    requirement: To create a new crumb, the caller constructs a Crumb struct and passes
      it to Table.Set
  - id: R3.2
    requirement: When Table.Set is called with an empty ID, the backend must generate
      a UUID v7 for CrumbID, set State to "draft", set CreatedAt to now, set UpdatedAt
      to now, and initialize Properties map with all defined properties set to their
      type-based default values (see prd004-properties-interface R3.5)
  - id: R3.4
    requirement: Table.Set must validate that Name is non-empty and return ErrInvalidName
      if empty
  - id: R3.5
    requirement: After successful creation, the Crumb struct is updated with the generated
      CrumbID, timestamps, and initialized Properties
- group: R4
  title: State Transition Methods
  items:
  - id: R4.1
    requirement: The Crumb struct provides methods for common state transitions
  - id: R4.5
    requirement: After calling any state transition method, the caller must save the
      crumb with Table.Set to persist the changes
- group: R5
  title: Property Methods
  items:
  - id: R5.1
    requirement: The Crumb struct provides methods for property access
  - id: R5.2
    requirement: SetProperty assigns a value to a property. Must validate that the
      property exists (return ErrPropertyNotFound if not; requires property definitions
      lookup), must validate that value matches the property's value_type (return
      ErrTypeMismatch if not), for categorical properties value must be a valid category_id
      (return ErrInvalidCategory if not), must update the Properties map, must update
      the UpdatedAt timestamp
  - id: R5.3
    requirement: GetProperty retrieves a single property value. Must return the value
      from the Properties map. Since all properties are initialized on crumb creation
      (R3.2), the property always has a value. Must return ErrPropertyNotFound if
      the property does not exist (not in Properties map)
  - id: R5.4
    requirement: GetProperties retrieves all property values. Must return the Properties
      map. The map contains an entry for every defined property. The map is empty
      only if no properties are defined
  - id: R5.6
    requirement: After calling any property method that modifies state, the caller
      must save the crumb with Table.Set to persist the changes
- group: R6
  title: Retrieving Crumbs
  items:
  - id: R6.1
    requirement: To retrieve a crumb by ID, use Table.Get
  - id: R6.2
    requirement: Table.Get returns the entity as any; the caller must type-assert
      to *Crumb
  - id: R6.3
    requirement: Table.Get returns ErrNotFound if no crumb exists with the given ID
  - id: R6.4
    requirement: Table.Get returns ErrInvalidID if id is empty
- group: R7
  title: Updating Crumbs
  items:
  - id: R7.1
    requirement: To update a crumb, retrieve it with Table.Get, modify it with entity
      methods or direct field access, and save it with Table.Set
  - id: R7.2
    requirement: Direct field modification (e.g., changing Name) does not automatically
      update UpdatedAt. The caller must update UpdatedAt manually when modifying fields
      directly
  - id: R7.3
    requirement: Entity methods (SetState, SetProperty, etc.) automatically update
      UpdatedAt
  - id: R7.4
    requirement: Table.Set validates that Name is non-empty and returns ErrInvalidName
      if empty
- group: R8
  title: Deleting Crumbs
  items:
  - id: R8.1
    requirement: To soft-delete a crumb, use the Dust entity method and save
  - id: R8.2
    requirement: To hard-delete a crumb, use Table.Delete
  - id: R8.4
    requirement: Table.Delete returns ErrNotFound if no crumb exists with the given
      ID
  - id: R8.5
    requirement: Table.Delete returns ErrInvalidID if id is empty
  - id: R8.7
    requirement: Dust crumbs remain queryable via Table.Fetch. Applications filter
      by state to exclude dust crumbs from active views
- group: R9
  title: Filter Map
  items:
  - id: R9.1
    requirement: Filters are expressed as map[string]any where keys are filter names
      and values are filter criteria
  - id: R9.2
    requirement: Supported filter keys for crumbs
  - id: R9.3
    requirement: An empty or nil filter matches all crumbs
  - id: R9.5
    requirement: Unknown filter keys must be ignored (forward compatibility)
  - id: R9.6
    requirement: Results are ordered by CreatedAt descending (newest first)
- group: R10
  title: Querying Crumbs
  items:
  - id: R10.1
    requirement: To query crumbs, use Table.Fetch with a filter map
  - id: R10.2
    requirement: Table.Fetch returns a slice of entities ([]any); the caller must
      type-assert each element to *Crumb
  - id: R10.3
    requirement: Table.Fetch returns an empty slice (not nil) if no crumbs match
  - id: R10.4
    requirement: Table.Fetch applies limit and offset after filtering and ordering
  - id: R10.5
    requirement: Table.Fetch does not return an error for an empty result set
  - id: R10.6
    requirement: Table.Fetch returns ErrInvalidFilter if a filter value has the wrong
      type (e.g., "states" is not []string)
- group: R11
  title: Error Types
  items:
  - id: R11.1
    requirement: Crumb entity methods and Table operations must return the following
      sentinel errors
  - id: R11.2
    requirement: All errors must be checkable with errors.Is
non_goals:
- This PRD does not define the Table interface or Cupboard interface. See prd001-cupboard-core
- This PRD does not define trail operations. See prd006-trails-interface
- This PRD does not define property definitions. See prd004-properties-interface
- This PRD does not define complex state transition rules beyond Pebble validation.
  Applications may add additional validation logic
- This PRD does not define batch operations (e.g., bulk dust, bulk update)
- This PRD does not define full-text search on crumb names or content
- This PRD does not define property validation at the entity method level. Property
  methods may defer validation to Table.Set for simplicity
acceptance_criteria:
- id: AC1
  criterion: Crumb struct defined with CrumbID, Name, State, CreatedAt, UpdatedAt,
    Properties fields
- id: AC2
  criterion: State values documented (draft, pending, ready, taken, pebble, dust)
- id: AC3
  criterion: State transition methods defined (SetState, Pebble, Dust)
- id: AC4
  criterion: State transition validation rules documented (Pebble requires taken state)
- id: AC5
  criterion: Property methods defined (SetProperty, GetProperty, GetProperties, ClearProperty)
- id: AC6
  criterion: Property method behavior documented (validation, defaults, UpdatedAt)
- id: AC7
  criterion: Crumb creation via Table.Set specified (ID generation, state initialization,
    property initialization)
- id: AC8
  criterion: Crumb retrieval via Table.Get specified (type assertion to *Crumb)
- id: AC9
  criterion: Crumb update pattern documented (Get, modify, Set)
- id: AC10
  criterion: Crumb deletion via Table.Delete specified (hard delete, cascade)
- id: AC11
  criterion: Soft delete via Dust method documented
- id: AC12
  criterion: Filter map defined with states, trail_id, parent_id, properties, limit,
    offset
- id: AC13
  criterion: Query via Table.Fetch specified (filter map, type assertion, pagination)
- id: AC14
  criterion: Error types documented (including ErrInvalidTransition)
- id: AC15
  criterion: All requirements numbered and specific
