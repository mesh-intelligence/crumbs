id: prd006-trails-interface
title: Trails Interface
problem: |
  Applications need to support exploratory work sessions where users can try different approaches without committing to them permanently. A developer might start working on a feature, explore multiple implementation paths, and later decide to keep some work while discarding dead ends. Without trails, all crumbs are permanent from the moment of creation, making exploratory workflows awkward or impossible.

  We need a way to group crumbs into exploratory sessions (trails) that can later be committed (made permanent) or abandoned (discarded entirely). This enables backtracking and branching without cluttering the main work stream with abandoned attempts.

  This PRD defines the Trail entity: its struct fields and entity methods for lifecycle operations (Complete, Abandon). Entity methods update the Trail struct in memory; the caller persists changes via Table.Set, at which point the backend performs cascade operations (removing links or deleting crumbs). Trail membership is stored via the links table (belongs_to relationship); this PRD specifies the semantics while prd002-sqlite-backend specifies the storage.
goals:
- id: G1
  goal: Define the Trail struct with all required fields
- id: G2
  goal: Define trail states and their meaning
- id: G3
  goal: Specify entity methods for lifecycle operations (Complete, Abandon)
- id: G4
  goal: Specify Complete method semantics (entity updates state; backend cascades
    on persist)
- id: G5
  goal: Specify Abandon method semantics (entity updates state; backend cascades on
    persist)
- id: G6
  goal: Document error conditions for entity methods
- id: G7
  goal: Define how trails are accessed via the Table interface
requirements:
- group: R1
  title: Trail Struct
  items:
  - id: R1.1
    requirement: The Trail struct must include the fields defined in the following
      table
  - id: R1.2
    requirement: TrailID must be a UUID v7 (time-ordered) generated by the backend
      when Set is called with an empty ID
  - id: R1.3
    requirement: CompletedAt is set when the trail transitions to completed or abandoned
      state
  - id: R1.4
    requirement: Trail branching (deviating from a crumb on another trail) uses a
      `branches_from` link in the links table (see R9)
- group: R2
  title: State Values
  items:
  - id: R2.1
    requirement: A trail must be in exactly one of the states defined in the following
      table
  - id: R2.2
    requirement: Initial state on creation is draft
  - id: R2.3
    requirement: 'State transitions follow this lifecycle: draft → pending → active
      → completed or abandoned. A trail in draft state can transition to pending or
      directly to active. A trail in pending state transitions to active when its
      precondition is met. A trail in active state can transition to completed or
      abandoned. The completed and abandoned states are terminal.'
  - id: R2.4
    requirement: State is stored as a string, not an enum, for JSON compatibility
- group: R3
  title: Trail Creation
  items:
  - id: R3.1
    requirement: Trails are created via the Table interface (Cupboard.GetTable("trails").Set)
  - id: R3.2
    requirement: The backend must generate a UUID v7 for TrailID when Set is called
      with an empty ID
  - id: R3.3
    requirement: Initial State must be "draft", CreatedAt must be set to the current
      time, and CompletedAt must be nil
  - id: R3.4
    requirement: After Set returns, the Trail struct must have TrailID populated by
      the backend
  - id: R3.5
    requirement: To create a trail that branches from a crumb, first create the trail,
      then create a `branches_from` link (see R9)
- group: R4
  title: Trail Retrieval
  items:
  - id: R4.1
    requirement: Trails are retrieved via the Table interface
  - id: R4.2
    requirement: Get must return the Trail entity if found
  - id: R4.3
    requirement: Get must return ErrNotFound if no trail exists with the given ID
  - id: R4.4
    requirement: Get must return ErrInvalidID if id is empty
- group: R5
  title: Complete Entity Method
  items:
  - id: R5.1
    requirement: Complete is an entity method on Trail that marks it as finished
  - id: R5.2
    requirement: Complete must set the trail's State field to "completed"
  - id: R5.3
    requirement: Complete must set the CompletedAt field to the current time
  - id: R5.4
    requirement: Complete must return ErrInvalidState if the trail is not in "active"
      state
  - id: R5.5
    requirement: Complete only updates the Trail struct in memory. The caller must
      persist changes via Table.Set
  - id: R5.6
    requirement: When the trail is persisted via Table.Set, the backend removes all
      belongs_to links for crumbs on this trail. After persistence, the crumbs exist
      but do not belong to any trail
  - id: R5.7
    requirement: The backend must perform the cascade operation atomically with the
      trail update
  - id: R5.8
    requirement: After completion and persistence, the crumbs are indistinguishable
      from crumbs that were never on a trail. They have become permanent parts of
      the work graph
- group: R6
  title: Abandon Entity Method
  items:
  - id: R6.1
    requirement: Abandon is an entity method on Trail that marks it as discarded
  - id: R6.2
    requirement: Abandon must set the trail's State field to "abandoned"
  - id: R6.3
    requirement: Abandon must set the CompletedAt field to the current time
  - id: R6.4
    requirement: Abandon must return ErrInvalidState if the trail is not in "active"
      state
  - id: R6.5
    requirement: Abandon only updates the Trail struct in memory. The caller must
      persist changes via Table.Set
  - id: R6.6
    requirement: When the trail is persisted via Table.Set, the backend deletes all
      crumbs that belong to this trail (via belongs_to links)
  - id: R6.7
    requirement: 'For each deleted crumb, the backend must also delete: all property
      values for the crumb (crumb_properties); all metadata for the crumb; all links
      where the crumb is from_id or to_id (belongs_to, child_of)'
  - id: R6.8
    requirement: The backend must perform all cascade deletions atomically with the
      trail update
  - id: R6.9
    requirement: After abandonment and persistence, the trail remains in the database
      (for audit purposes) but has no associated crumbs
- group: R7
  title: Crumb Membership
  items:
  - id: R7.1
    requirement: A crumb belongs to a trail via a belongs_to link in the links table
  - id: R7.2
    requirement: A crumb can belong to at most one trail at a time. The backend must
      enforce this constraint
  - id: R7.3
    requirement: All crumbs must belong to a trail. A crumb without a belongs_to link
      is either permanent (was on a completed trail whose belongs_to links were removed)
      or orphaned (should be cleaned up). There is no "untracked" state—crumbs are
      created on trails and either become permanent when the trail completes or are
      deleted when the trail is abandoned
  - id: R7.4
    requirement: Crumb-to-trail membership is managed via the links table. Applications
      create belongs_to links using the Table interface for the links table
  - id: R7.5
    requirement: Moving a crumb between trails requires removing the old belongs_to
      link and creating a new one
- group: R8
  title: Error Types
  items:
  - id: R8.1
    requirement: Trail entity methods must return the sentinel errors defined in the
      following table
  - id: R8.2
    requirement: All errors must be checkable with errors.Is
  - id: R8.3
    requirement: Table operations (Get, Set, Fetch) may return additional errors as
      defined in prd001-cupboard-core R7
- group: R9
  title: Trail Branching
  items:
  - id: R9.1
    requirement: A trail can branch from a crumb via a `branches_from` link in the
      links table
  - id: R9.2
    requirement: A trail can have at most one `branches_from` link. The backend must
      enforce this constraint
  - id: R9.3
    requirement: The `branches_from` link indicates that this trail represents an
      alternative approach starting from a specific crumb in the work graph
  - id: R9.4
    requirement: Trail branching is managed via the links table. Applications create
      `branches_from` links using the Table interface for the links table
  - id: R9.5
    requirement: To find the branch point of a trail, query the links table for a
      `branches_from` link where `from_id` equals the trail ID
  - id: R9.6
    requirement: Trails without a `branches_from` link are standalone (not branched
      from any crumb)
non_goals:
- This PRD does not define crumb CRUD operations. See prd003-crumbs-interface.
- This PRD does not define the Table interface or link storage. The Table interface
  is defined in prd001-cupboard-core and the links table is detailed in prd002-sqlite-backend.
  This PRD defines entity methods that use those interfaces.
- This PRD does not define nested trails or trail hierarchies. Each trail is independent.
- This PRD does not define undo for Complete or Abandon. These are terminal operations.
- This PRD does not define batch operations on trails (e.g., merge trails, split trails).
- This PRD does not define a specialized TrailTable interface. Trails are accessed
  via the standard Table interface from prd001-cupboard-core.
- This PRD does not define entity methods for adding or removing crumbs from trails.
  Crumb membership is managed via the links table using the standard Table interface.
acceptance_criteria:
- id: AC1
  criterion: Trail struct defined with TrailID, State, CreatedAt, CompletedAt
- id: AC2
  criterion: State values documented (draft, pending, active, completed, abandoned)
- id: AC3
  criterion: Trail creation specified via Table.Set interface
- id: AC4
  criterion: Trail retrieval specified via Table.Get interface
- id: AC5
  criterion: Complete entity method specified with no arguments (updates State and
    CompletedAt)
- id: AC6
  criterion: Complete documents backend cascade responsibility (remove belongs_to
    links on Table.Set)
- id: AC7
  criterion: Abandon entity method specified with no arguments (updates State and
    CompletedAt)
- id: AC8
  criterion: Abandon documents backend cascade responsibility (delete crumbs on Table.Set)
- id: AC9
  criterion: Crumb membership semantics documented (belongs_to link, one trail per
    crumb)
- id: AC10
  criterion: Trail branching semantics documented (branches_from link, one per trail)
- id: AC11
  criterion: Error types documented (ErrInvalidState for entity methods)
- id: AC12
  criterion: All requirements numbered and specific
