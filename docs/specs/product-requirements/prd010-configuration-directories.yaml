id: prd010-configuration-directories
title: Configuration Directory Structure
problem: |
  The Cupboard CLI needs two distinct directory locations: one for application settings (backend selection, defaults) and one for backend data (crumbs, trails, links). These serve different purposes and have different lifecycles. Configuration is set once and rarely changes; data changes constantly. Separating them clarifies what to version-control versus what to treat as runtime state, and simplifies backup strategies.

  Data files need a format suited to append-heavy workloads. JSONL (one JSON object per line) allows appending without rewriting, supports streaming reads, tolerates partial corruption (only the affected line is lost), and works with standard line-oriented tools (grep, head, tail). These properties also make JSONL files easy to merge in version control.

  Both directories default to the current working directory so that each project gets its own configuration and data without global state.
goals:
- id: G1
  goal: Define a CLI configuration directory separate from backend data
- id: G2
  goal: Define the backend data directory structure for SQLite backend
- id: G3
  goal: Specify JSONL (line-delimited JSON) as the file format for data tables
- id: G4
  goal: Establish working-directory-local defaults for both directories
- id: G5
  goal: Clarify the relationship between configuration and the Cupboard interface
requirements:
- group: R1
  title: CLI Configuration Directory
  items:
  - id: R1.1
    requirement: The CLI configuration directory holds application-level settings,
      not backend data
  - id: R1.2
    requirement: The default configuration directory is `$(CWD)/.crumbs`
  - id: R1.3
    requirement: The configuration directory can be overridden with the `--config-dir`
      CLI flag
  - id: R1.4
    requirement: The CLI configuration directory must contain config.yaml for CLI
      settings (default backend, optional data directory path, backend-specific options)
  - id: R1.5
    requirement: config.yaml format must follow this structure
  - id: R1.6
    requirement: If the configuration directory does not exist, the CLI must create
      it on first run with a default config.yaml
  - id: R1.7
    requirement: The data_dir field is not set in config.yaml by default. The CLI
      writes it to config.yaml once it resolves the data directory location
- group: R2
  title: Backend Data Directory
  items:
  - id: R2.1
    requirement: The backend data directory holds all data managed by a Cupboard backend.
      It is separate from CLI configuration
  - id: R2.2
    requirement: The default data directory is `$(CWD)/.crumbs-db`
  - id: R2.3
    requirement: The data directory can be overridden via the following mechanisms
  - id: R2.4
    requirement: The data directory path is passed to Cupboard via Config.DataDir
      when calling Attach
  - id: R2.5
    requirement: If the data directory does not exist, the backend must create it
      during Attach
- group: R3
  title: JSONL File Format
  items:
  - id: R3.1
    requirement: The SQLite backend must use JSONL (JSON Lines) format for data files.
      Each table in the application has one JSONL file
  - id: R3.2
    requirement: 'JSONL format rules: each line is a complete, valid JSON object;
      lines are separated by newline (\n); no commas between lines; no enclosing array
      brackets; empty lines are ignored; UTF-8 encoding required'
  - id: R3.3
    requirement: Example crumbs.jsonl format
  - id: R3.4
    requirement: JSONL files must not be pretty-printed. Each record is a single line
      (no internal newlines in the JSON)
- group: R4
  title: Data Directory File Layout
  items:
  - id: R4.1
    requirement: The SQLite backend data directory must contain one JSONL file per
      table
  - id: R4.2
    requirement: 'File naming convention: `{table_name}.jsonl` (lowercase, underscores
      for multi-word names)'
  - id: R4.3
    requirement: If a JSONL file does not exist, the backend must create an empty
      file (zero bytes, not an empty array)
  - id: R4.4
    requirement: The SQLite database (cupboard.db) is an ephemeral runtime cache.
      It is not part of the persistent file layout and must not be committed to version
      control
- group: R5
  title: Startup Sequence
  items:
  - id: R5.1
    requirement: 'On Attach with SQLite backend: create data directory if it does
      not exist; create empty JSONL files if they do not exist; if cupboard.db exists,
      log a warning and delete it (indicates a previous unclean shutdown); create
      new cupboard.db with schema; load each JSONL file into corresponding SQLite
      table (line by line); skip empty lines and log warnings for malformed lines;
      validate foreign key relationships; return ready Cupboard instance'
  - id: R5.2
    requirement: If a line in a JSONL file is malformed, the backend must log a warning
      with the file name, line number, and error, then skip that line. The startup
      continues with remaining valid records
  - id: R5.3
    requirement: If foreign key validation fails, the backend must return an error
      listing the invalid references
- group: R6
  title: Write Operations
  items:
  - id: R6.1
    requirement: Write operations persist to JSONL according to the sync strategy
      defined in prd002-sqlite-backend R16 (immediate, on_close, or batch)
  - id: R6.2
    requirement: For updates and deletes, the backend must rewrite the entire JSONL
      file (read all, modify, write atomically). This is acceptable because JSONL
      files are small enough to fit in memory for typical workloads
  - id: R6.3
    requirement: For append-only tables (stash_history), the backend may append a
      new line instead of rewriting
  - id: R6.4
    requirement: 'Atomic write pattern: write to temporary file ({filename}.tmp);
      sync to disk (fsync); rename temporary file to target (atomic on POSIX)'
- group: R7
  title: Shutdown Sequence
  items:
  - id: R7.1
    requirement: 'On Detach: persist any pending JSONL writes per the sync strategy;
      delete cupboard.db; release all resources'
  - id: R7.2
    requirement: After orderly shutdown, only JSONL files remain in the data directory.
      No cupboard.db
  - id: R7.3
    requirement: If the process terminates without Detach, cupboard.db may remain.
      The next startup handles this per R5.1
- group: R8
  title: CLI Configuration Loading
  items:
  - id: R8.1
    requirement: 'On CLI startup: determine configuration directory (--config-dir
      flag or default); load config.yaml if it exists, use defaults otherwise; determine
      data directory (--data-dir flag > data_dir in config.yaml > default); pass data
      directory to Cupboard via Config.DataDir'
  - id: R8.2
    requirement: The CLI must not require config.yaml to exist. Missing config.yaml
      uses all defaults
  - id: R8.3
    requirement: The CLI must create config.yaml on first run with default settings
- group: R9
  title: Config Struct
  items:
  - id: R9.1
    requirement: The Config struct must include Backend and DataDir
  - id: R9.2
    requirement: DataDir holds the directory for the SQLite backend
  - id: R9.3
    requirement: CLI configuration (config.yaml) is outside the Cupboard interface.
      The CLI reads config.yaml and constructs a Config struct to pass to Attach
non_goals:
- This PRD does not define configuration file encryption or secrets management.
- This PRD does not define multi-workspace support (multiple data directories). One
  CLI instance operates on one data directory at a time.
- This PRD does not define network-based configuration (e.g., fetching config from
  a server).
- This PRD does not define Windows support.
acceptance_criteria:
- id: AC1
  criterion: CLI configuration directory default and override mechanism defined
- id: AC2
  criterion: Backend data directory default and override mechanism defined
- id: AC3
  criterion: JSONL format specified with examples
- id: AC4
  criterion: Data directory file layout specified with one JSONL file per table
- id: AC5
  criterion: Startup sequence defined for JSONL loading and stale database cleanup
- id: AC6
  criterion: Shutdown sequence defined for database deletion
- id: AC7
  criterion: Write operation pattern defers to sync strategy without conflict
- id: AC8
  criterion: CLI configuration loading sequence defined
- id: AC9
  criterion: Config struct relationship to config.yaml documented
- id: AC10
  criterion: All requirements numbered and specific
