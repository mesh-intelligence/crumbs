id: prd005-metadata-interface
title: Metadata Interface
problem: |
  Applications need to attach supplementary information to crumbs beyond structured properties. A developer might add comments during work, attach log files for debugging, or link to external resources. Properties handle typed, single-value attributes; metadata handles unstructured, multi-value content like comments, attachments, and activity logs.

  Hardcoding metadata types (comments table, attachments table) creates rigid schemas. Applications should be able to define new metadata types through schema registration without code changes. A plugin might add "reviews" or "time_entries" as new metadata types.

  prd001-cupboard-core defines the Cupboard interface with uniform Table access, but it does not specify the Metadata entity structure or how metadata interacts with the Table interface. This PRD defines the Metadata entity: the struct fields, schema registration for extensible metadata tables, and how metadata is stored and retrieved via the Table interface.
goals:
- id: G1
  goal: Define the Metadata struct with all required fields
- id: G2
  goal: Define the Schema struct for metadata table schema registration
- id: G3
  goal: Specify how metadata is created, stored, and queried via the Table interface
- id: G4
  goal: Define filter conventions for querying metadata
- id: G5
  goal: Document built-in metadata schemas (comments, attachments)
- id: G6
  goal: Specify schema registration for custom metadata types
- id: G7
  goal: Document error conditions for metadata operations
requirements:
- group: R1
  title: Metadata Struct
  items:
  - id: R1.1
    requirement: The Metadata struct must include the fields defined in the following
      table
  - id: R1.2
    requirement: MetadataID must be a UUID v7 (time-ordered) generated by the backend
      when Table.Set is called with an empty MetadataID
  - id: R1.3
    requirement: CrumbID links the metadata to a specific crumb. The crumb must exist;
      Table.Set validates this
  - id: R1.4
    requirement: TableName identifies which schema the entry belongs to. Only registered
      schema names are valid
  - id: R1.5
    requirement: PropertyID is optional. When set, the metadata is associated with
      a specific property on the crumb (e.g., a comment about the priority value).
      If provided, the property must exist
  - id: R1.6
    requirement: Content stores the actual metadata. For simple metadata like comments,
      this is plain text. For structured metadata, this may be JSON
- group: R2
  title: Schema Struct
  items:
  - id: R2.1
    requirement: The Schema struct defines a metadata schema
  - id: R2.2
    requirement: SchemaName must be unique across all registered schemas
  - id: R2.3
    requirement: SchemaName must be non-empty and contain only lowercase letters,
      numbers, and underscores
  - id: R2.4
    requirement: ContentType hints at how Content should be interpreted. "text" means
      plain text; "json" means JSON-formatted content. The backend does not validate
      content against this type; it is advisory
  - id: R2.5
    requirement: Schema is intentionally minimal. The metadata system stores flexible
      content; schema describes intent, not strict structure
- group: R3
  title: Built-in Schemas
  items:
  - id: R3.1
    requirement: The backend must pre-register the built-in metadata schemas on startup
  - id: R3.2
    requirement: Built-in schemas are always available; applications do not need to
      register them
  - id: R3.3
    requirement: Built-in schemas cannot be unregistered or modified
  - id: R3.4
    requirement: Comments schema stores plain text comments. Each new metadata entry
      creates a new comment
  - id: R3.5
    requirement: Attachments schema stores JSON objects describing file attachments
  - id: R3.6
    requirement: The attachments content format is advisory; the backend stores the
      JSON as-is without validation
- group: R4
  title: Creating Metadata
  items:
  - id: R4.1
    requirement: To create a new metadata entry, the caller constructs a Metadata
      struct and passes it to Table.Set
  - id: R4.2
    requirement: 'When Table.Set is called with an empty ID, the backend must: generate
      a UUID v7 for MetadataID; set CreatedAt to now; validate that TableName is a
      registered schema (return ErrSchemaNotFound if not); validate that CrumbID references
      an existing crumb (return ErrNotFound if not); validate that Content is non-empty
      (return ErrInvalidContent if empty); if PropertyID is set, validate that the
      property exists (return ErrPropertyNotFound if not)'
  - id: R4.3
    requirement: 'Validation in R4.2 is atomic: if any validation fails, the metadata
      is not created'
  - id: R4.4
    requirement: After successful creation, the Metadata struct is updated with the
      generated MetadataID and timestamp
  - id: R4.5
    requirement: Multiple metadata entries can be added to the same crumb for the
      same schema. Comments are additive, not replacements
- group: R5
  title: Retrieving Metadata
  items:
  - id: R5.1
    requirement: To retrieve a metadata entry by ID, use Table.Get
  - id: R5.2
    requirement: Table.Get returns the entity as any; the caller must type-assert
      to *Metadata
  - id: R5.3
    requirement: Table.Get returns ErrNotFound if no metadata exists with the given
      ID
  - id: R5.4
    requirement: Table.Get returns ErrInvalidID if id is empty
- group: R6
  title: Metadata Lifecycle
  items:
  - id: R6.1
    requirement: Metadata entries are append-only by convention. There is no intended
      Update operation; new entries add context rather than replace old entries
  - id: R6.2
    requirement: Table.Set with an existing MetadataID is technically permitted but
      discouraged. The backend updates the record if called
  - id: R6.3
    requirement: Table.Delete removes a metadata entry by ID. This is intended for
      cleanup scenarios, not normal use
  - id: R6.4
    requirement: Table.Delete returns ErrNotFound if no metadata exists with the given
      ID
  - id: R6.5
    requirement: When a crumb is deleted (via the crumbs table), all its metadata
      entries must also be deleted (cascading delete)
  - id: R6.6
    requirement: Metadata entries cannot be moved between crumbs; CrumbID is immutable
      after creation
- group: R7
  title: Filter Map
  items:
  - id: R7.1
    requirement: Filters are expressed as map[string]any where keys are filter names
      and values are filter criteria
  - id: R7.2
    requirement: Supported filter keys for metadata are defined in the following table
  - id: R7.3
    requirement: An empty or nil filter matches all metadata entries
  - id: R7.4
    requirement: 'Multiple filter keys are ANDed: a metadata entry must match all
      specified criteria'
  - id: R7.5
    requirement: Unknown filter keys must be ignored (forward compatibility)
  - id: R7.6
    requirement: Results are ordered by CreatedAt ascending (oldest first) by default
- group: R8
  title: Querying Metadata
  items:
  - id: R8.1
    requirement: To query metadata, use Table.Fetch with a filter map
  - id: R8.2
    requirement: Table.Fetch returns a slice of entities ([]any); the caller must
      type-assert each element to *Metadata
  - id: R8.3
    requirement: Table.Fetch returns an empty slice (not nil) if no metadata entries
      match
  - id: R8.4
    requirement: Table.Fetch applies limit and offset after filtering and ordering
  - id: R8.5
    requirement: Table.Fetch does not return an error for an empty result set
  - id: R8.6
    requirement: Table.Fetch returns ErrInvalidFilter if a filter value has the wrong
      type
- group: R9
  title: Schema Registration
  items:
  - id: R9.1
    requirement: Applications can register custom schemas beyond the built-in schemas.
      Schema registration is handled separately from the metadata Table interface
  - id: R9.2
    requirement: 'The Cupboard must provide a schema registration mechanism. Implementations
      may: expose a RegisterSchema method on the Cupboard; use a dedicated schemas
      table where schemas are persisted as entities; pre-load schemas from configuration'
  - id: R9.3
    requirement: 'Schema registration must validate: SchemaName is non-empty and valid
      format (lowercase, numbers, underscores only); SchemaName is unique (not already
      registered)'
  - id: R9.4
    requirement: Registration returns ErrDuplicateName if the schema name already
      exists
  - id: R9.5
    requirement: Registration returns ErrInvalidName if the schema name is empty or
      invalid format
  - id: R9.6
    requirement: Schemas cannot be unregistered once registered. This prevents orphaned
      metadata entries
- group: R10
  title: Error Types
  items:
  - id: R10.1
    requirement: Metadata operations and Table operations must return the sentinel
      errors defined in the following table
  - id: R10.2
    requirement: All errors must be checkable with errors.Is
non_goals:
- This PRD does not define the Table interface or Cupboard interface. See prd001-cupboard-core.
- This PRD does not define crumb operations. See prd003-crumbs-interface.
- This PRD does not define property definitions. See prd004-properties-interface.
- This PRD does not define file storage for attachments. The attachments schema stores
  references; actual file handling is outside this scope.
- This PRD does not define full-text search indexing. The content_contains filter
  is substring matching, not ranked search.
- This PRD does not define schema enforcement. ContentType is advisory; content is
  stored as-is.
- This PRD does not define batch operations for metadata (e.g., bulk add, bulk delete).
acceptance_criteria:
- id: AC1
  criterion: Metadata struct defined with MetadataID, CrumbID, TableName, Content,
    PropertyID, CreatedAt
- id: AC2
  criterion: Schema struct defined with SchemaName, Description, ContentType
- id: AC3
  criterion: Built-in schemas documented (comments, attachments)
- id: AC4
  criterion: Schema registration approach documented
- id: AC5
  criterion: Metadata creation via Table.Set specified (ID generation, validation)
- id: AC6
  criterion: Metadata retrieval via Table.Get specified (type assertion to *Metadata)
- id: AC7
  criterion: Metadata lifecycle documented (append-only convention, cascading delete)
- id: AC8
  criterion: Filter map defined with schema, crumb_id, property_id, content_contains,
    limit, offset
- id: AC9
  criterion: Query via Table.Fetch specified (filter map, type assertion, pagination)
- id: AC10
  criterion: Error types documented
- id: AC11
  criterion: All requirements numbered and specific
