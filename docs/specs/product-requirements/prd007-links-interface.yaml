id: prd007-links-interface
title: Links Interface
problem: |
  Links represent directed edges in the entity graph. They connect crumbs to trails (belongs_to), crumbs to crumbs (child_of), trails to crumbs (branches_from), and stashes to trails (scoped_to). Link requirements are currently scattered across four PRDs (prd002-sqlite-backend, prd006-trails-interface, prd008-stash-interface, prd003-crumbs-interface), making it difficult to understand the complete link behavior and constraints.

  This PRD consolidates all link requirements into one authoritative source. Other PRDs should reference prd007-links-interface for link behavior rather than duplicating these specifications. The Link entity is the only entity without a dedicated interface PRD; this document fills that gap.
goals:
- G1: Define the Link struct with all required fields
- G2: Define valid link types and their semantics
- G3: Document CRUD operations via the Table interface
- G4: Define filter keys and query semantics
- G5: Document uniqueness constraint and indexes
- G6: Consolidate cardinality rules from other PRDs
- G7: Document error handling
- G8: Define graph audit functions for integrity validation
requirements:
  R1:
    title: Link Struct
    items:
    - R1.1: The Link struct must include the following fields
    - R1.2: LinkID must be a UUID v7 (time-ordered) generated by the backend when Table.Set is called with an empty LinkID
    - R1.3: FromID and ToID are entity IDs; the entity type depends on LinkType (see R2)
    - R1.4: CreatedAt must be set to the current time on creation
    - R1.5: Links are immutable after creation. To change a relationship, delete the old link and create a new one
  R2:
    title: Link Types and Semantics
    items:
    - R2.1: LinkType must be one of the four valid types
    - R2.2: Link type constants must be defined in pkg/types/link.go
    - R2.3: Table.Set must reject unrecognized LinkType values with ErrInvalidData
    - R2.4: The graph formed by child_of links must be a DAG (no cycles). See R8 for validation
  R3:
    title: CRUD via Table Interface
    items:
    - R3.1: Links are accessed via the Table interface
    - R3.2: To create a link, construct a Link struct and pass it to Table.Set with an empty ID
    - R3.3: Table.Set must generate a UUID v7 for LinkID, set CreatedAt to now, and persist to both SQLite and links.jsonl
    - R3.4: Table.Get retrieves a link by LinkID. Returns ErrNotFound if not found. Returns ErrInvalidID if id is empty
    - R3.5: Table.Delete removes a link by LinkID. Returns ErrNotFound if not found. Returns ErrInvalidID if id is empty
    - R3.6: Table.Fetch queries links matching a filter map. Returns []any that must be type-asserted to *Link
  R4:
    title: Filter Keys
    items:
    - R4.1: Supported filter keys for links
    - R4.2: Multiple filter keys are ANDed. A link must match all specified criteria
    - R4.3: An empty or nil filter matches all links
    - R4.4: Unknown filter keys must be ignored (forward compatibility)
  R5:
    title: Uniqueness Constraint
    items:
    - R5.1: The combination (link_type, from_id, to_id) must be unique
    - R5.2: Table.Set must reject duplicate links with the same (link_type, from_id, to_id) combination
    - R5.3: A crumb can have at most one belongs_to link (because the combination crumb+belongs_to+trail is unique)
    - R5.4: A crumb can have multiple child_of links (different parent crumbs) and be the target of multiple child_of links
        (multiple children)
    - R5.5: Indexes for efficient queries
  R6:
    title: Cardinality Rules
    items:
    - R6.1: 'belongs_to cardinality: A crumb can belong to at most one trail at a time. Enforced by uniqueness constraint
        on (belongs_to, crumb_id, *)'
    - R6.2: 'child_of cardinality: Many-to-many. A crumb can have multiple parents and multiple children. The child_of graph
        must be a DAG (no cycles)'
    - R6.3: 'branches_from cardinality: A trail can have at most one branches_from link. Enforced by uniqueness constraint
        on (branches_from, trail_id, *)'
    - R6.4: 'scoped_to cardinality: A stash can have at most one scoped_to link. Enforced by uniqueness constraint on (scoped_to,
        stash_id, *)'
    - R6.5: Cardinality summary table
  R7:
    title: Error Handling
    items:
    - R7.1: Link operations must return the following sentinel errors
    - R7.2: All errors must be checkable with errors.Is
    - R7.3: Uniqueness constraint violations (duplicate link) must return an error from Table.Set. The specific error depends
        on the backend implementation
  R8:
    title: Graph Audit Functions
    items:
    - R8.1: The backend must provide audit functions to validate graph integrity
    - R8.2: ValidateDAG must detect cycles using depth-first search or topological sort. If a cycle is found, return an error
        listing the crumb_ids involved
    - R8.3: ValidateReferences must validate all link types
    - R8.4: Audit functions run on startup after loading JSONL. If validation fails, Attach returns an error
    - R8.5: Audit functions are also available as Cupboard methods for on-demand validation
non_goals:
- This PRD does not define cascade behavior on trail completion or abandonment. See prd006-trails-interface for cascade semantics
- This PRD does not define entity-specific query patterns (e.g., finding all crumbs in a trail). Those patterns are documented
  in the entity-specific PRDs
- This PRD does not define link update operations. Links are immutable; delete and recreate to modify
- This PRD does not change the existing Link implementation
acceptance_criteria:
- Link struct defined with LinkID, LinkType, FromID, ToID, CreatedAt
- Link types documented (belongs_to, child_of, branches_from, scoped_to)
- Link type constants defined in pkg/types/link.go
- CRUD operations specified via Table interface
- Filter keys documented (LinkID, LinkType, FromID, ToID, CreatedAt)
- AND semantics for multiple filter keys documented
- Uniqueness constraint documented (link_type + from_id + to_id)
- Cardinality rules consolidated from other PRDs
- Error types documented (ErrNotFound, ErrInvalidID, ErrInvalidData, ErrCupboardDetached)
- Graph audit functions documented (ValidateDAG, ValidateReferences, etc.)
- All requirements numbered and specific
