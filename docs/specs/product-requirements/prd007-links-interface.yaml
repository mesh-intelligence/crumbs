id: prd007-links-interface
title: Links Interface
problem: |
  Links represent directed edges in the entity graph. They connect crumbs to trails (belongs_to), crumbs to crumbs (child_of), trails to crumbs (branches_from), and stashes to trails (scoped_to). Link requirements are currently scattered across four PRDs (prd002-sqlite-backend, prd006-trails-interface, prd008-stash-interface, prd003-crumbs-interface), making it difficult to understand the complete link behavior and constraints.

  This PRD consolidates all link requirements into one authoritative source. Other PRDs should reference prd007-links-interface for link behavior rather than duplicating these specifications. The Link entity is the only entity without a dedicated interface PRD; this document fills that gap.
goals:
- id: G1
  goal: Define the Link struct with all required fields
- id: G2
  goal: Define valid link types and their semantics
- id: G3
  goal: Document CRUD operations via the Table interface
- id: G4
  goal: Define filter keys and query semantics
- id: G5
  goal: Document uniqueness constraint and indexes
- id: G6
  goal: Consolidate cardinality rules from other PRDs
- id: G7
  goal: Document error handling
- id: G8
  goal: Define graph audit functions for integrity validation
requirements:
- group: R1
  title: Link Struct
  items:
  - id: R1.1
    requirement: The Link struct must include the following fields
  - id: R1.2
    requirement: LinkID must be a UUID v7 (time-ordered) generated by the backend
      when Table.Set is called with an empty LinkID
  - id: R1.3
    requirement: FromID and ToID are entity IDs; the entity type depends on LinkType
      (see R2)
  - id: R1.4
    requirement: CreatedAt must be set to the current time on creation
  - id: R1.5
    requirement: Links are immutable after creation. To change a relationship, delete
      the old link and create a new one
- group: R2
  title: Link Types and Semantics
  items:
  - id: R2.1
    requirement: LinkType must be one of the four valid types
  - id: R2.2
    requirement: Link type constants must be defined in pkg/types/link.go
  - id: R2.3
    requirement: Table.Set must reject unrecognized LinkType values with ErrInvalidData
  - id: R2.4
    requirement: The graph formed by child_of links must be a DAG (no cycles). See
      R8 for validation
- group: R3
  title: CRUD via Table Interface
  items:
  - id: R3.1
    requirement: Links are accessed via the Table interface
  - id: R3.2
    requirement: To create a link, construct a Link struct and pass it to Table.Set
      with an empty ID
  - id: R3.3
    requirement: Table.Set must generate a UUID v7 for LinkID, set CreatedAt to now,
      and persist to both SQLite and links.jsonl
  - id: R3.4
    requirement: Table.Get retrieves a link by LinkID. Returns ErrNotFound if not
      found. Returns ErrInvalidID if id is empty
  - id: R3.5
    requirement: Table.Delete removes a link by LinkID. Returns ErrNotFound if not
      found. Returns ErrInvalidID if id is empty
  - id: R3.6
    requirement: Table.Fetch queries links matching a filter map. Returns []any that
      must be type-asserted to *Link
- group: R4
  title: Filter Keys
  items:
  - id: R4.1
    requirement: Supported filter keys for links
  - id: R4.2
    requirement: Multiple filter keys are ANDed. A link must match all specified criteria
  - id: R4.3
    requirement: An empty or nil filter matches all links
  - id: R4.4
    requirement: Unknown filter keys must be ignored (forward compatibility)
- group: R5
  title: Uniqueness Constraint
  items:
  - id: R5.1
    requirement: The combination (link_type, from_id, to_id) must be unique
  - id: R5.2
    requirement: Table.Set must reject duplicate links with the same (link_type, from_id,
      to_id) combination
  - id: R5.3
    requirement: A crumb can have at most one belongs_to link (because the combination
      crumb+belongs_to+trail is unique)
  - id: R5.4
    requirement: A crumb can have multiple child_of links (different parent crumbs)
      and be the target of multiple child_of links (multiple children)
  - id: R5.5
    requirement: Indexes for efficient queries
- group: R6
  title: Cardinality Rules
  items:
  - id: R6.1
    requirement: 'belongs_to cardinality: A crumb can belong to at most one trail
      at a time. Enforced by uniqueness constraint on (belongs_to, crumb_id, *)'
  - id: R6.2
    requirement: 'child_of cardinality: Many-to-many. A crumb can have multiple parents
      and multiple children. The child_of graph must be a DAG (no cycles)'
  - id: R6.3
    requirement: 'branches_from cardinality: A trail can have at most one branches_from
      link. Enforced by uniqueness constraint on (branches_from, trail_id, *)'
  - id: R6.4
    requirement: 'scoped_to cardinality: A stash can have at most one scoped_to link.
      Enforced by uniqueness constraint on (scoped_to, stash_id, *)'
  - id: R6.5
    requirement: Cardinality summary table
- group: R7
  title: Error Handling
  items:
  - id: R7.1
    requirement: Link operations must return the following sentinel errors
  - id: R7.2
    requirement: All errors must be checkable with errors.Is
  - id: R7.3
    requirement: Uniqueness constraint violations (duplicate link) must return an
      error from Table.Set. The specific error depends on the backend implementation
- group: R8
  title: Graph Audit Functions
  items:
  - id: R8.1
    requirement: The backend must provide audit functions to validate graph integrity
  - id: R8.2
    requirement: ValidateDAG must detect cycles using depth-first search or topological
      sort. If a cycle is found, return an error listing the crumb_ids involved
  - id: R8.3
    requirement: ValidateReferences must validate all link types
  - id: R8.4
    requirement: Audit functions run on startup after loading JSONL. If validation
      fails, Attach returns an error
  - id: R8.5
    requirement: Audit functions are also available as Cupboard methods for on-demand
      validation
non_goals:
- This PRD does not define cascade behavior on trail completion or abandonment. See
  prd006-trails-interface for cascade semantics
- This PRD does not define entity-specific query patterns (e.g., finding all crumbs
  in a trail). Those patterns are documented in the entity-specific PRDs
- This PRD does not define link update operations. Links are immutable; delete and
  recreate to modify
- This PRD does not change the existing Link implementation
acceptance_criteria:
- id: AC1
  criterion: Link struct defined with LinkID, LinkType, FromID, ToID, CreatedAt
- id: AC2
  criterion: Link types documented (belongs_to, child_of, branches_from, scoped_to)
- id: AC3
  criterion: Link type constants defined in pkg/types/link.go
- id: AC4
  criterion: CRUD operations specified via Table interface
- id: AC5
  criterion: Filter keys documented (LinkID, LinkType, FromID, ToID, CreatedAt)
- id: AC6
  criterion: AND semantics for multiple filter keys documented
- id: AC7
  criterion: Uniqueness constraint documented (link_type + from_id + to_id)
- id: AC8
  criterion: Cardinality rules consolidated from other PRDs
- id: AC9
  criterion: Error types documented (ErrNotFound, ErrInvalidID, ErrInvalidData, ErrCupboardDetached)
- id: AC10
  criterion: Graph audit functions documented (ValidateDAG, ValidateReferences, etc.)
- id: AC11
  criterion: All requirements numbered and specific
