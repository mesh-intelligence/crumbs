{"id":"generation-2026-02-26-07-10-53-33z","title":"Blaze template types, errors, discovery, and parsing (prd011 R1-R5, R9)","description":"deliverable_type: code\n\nrequired_reading:\n  - docs/specs/product-requirements/prd011-blazes-templates.yaml (full PRD -- schema, discovery, listing, parsing, errors)\n  - docs/ARCHITECTURE.yaml (package structure per Decisions 12 and 13)\n  - docs/specs/use-cases/rel99.0-uc001-blazes-templates.yaml (use case success criteria S1-S3)\n  - pkg/schema/ (existing struct definition patterns -- directory may be pkg/types/ in actual code; check go.mod module path and existing source)\n  - pkg/api/ (existing sentinel error patterns -- directory may be pkg/types/ in actual code)\n  - pkg/constants/ (existing domain string constants -- directory may be pkg/types/ in actual code)\n  - go.mod (module path and existing YAML dependency for template parsing)\n\nfiles:\n  - path: pkg/schema/blaze.go\n    action: create\n    note: \"BlazeTemplate, BlazeParameter, BlazeMetadata, TaskContext, SelectionResult, ExtractedParameter structs\"\n  - path: pkg/api/blaze.go\n    action: create\n    note: \"Sentinel errors for blaze operations (ErrTemplateDirNotFound, ErrTemplateDirNotReadable, ErrTemplateNotFound, ErrMalformedTemplate, ErrNoMatch)\"\n  - path: pkg/constants/blaze.go\n    action: create\n    note: \"Parameter type constants (text, integer, boolean, list) and default blazes directory path\"\n  - path: internal/blazes/discovery.go\n    action: create\n    note: \"DiscoverTemplateDir and ListTemplates functions\"\n  - path: internal/blazes/parser.go\n    action: create\n    note: \"ParseTemplates function with template and parameter schema validation\"\n\nrequirements:\n  - id: R1\n    text: \"Define BlazeTemplate struct with required fields (name string, description string, tags []string) and optional fields (parameters []BlazeParameter, trail_definition any, version string, priority int, author string) per prd011 R1.2-R1.11. All fields must have YAML struct tags matching the lowercase field names from prd011 R1.3 and R1.11. Optional fields use omitempty.\"\n  - id: R2\n    text: \"Define BlazeParameter struct with fields name (string), description (string), type (string), and default (any) per prd011 R2.1-R2.9. Include YAML struct tags. The type field accepts exactly four values: text, integer, boolean, list per prd011 R2.5-R2.6.\"\n  - id: R3\n    text: \"Define supporting structs used by later blazes features: BlazeMetadata per prd011 R5.7 with 8 fields (Name, Description, Tags, Parameters, Version, Priority, Author, FilePath), TaskContext per prd011 R6.2 with 3 fields (Description, Labels, Keywords), SelectionResult per prd011 R7.7 with 4 fields (Selected *BlazeMetadata, Tied []BlazeMetadata, Ambiguous bool, NoMatch bool), ExtractedParameter per prd011 R8.7 with 7 fields (Name, Description, Type, Default, Required, InferredValue, Inferred).\"\n  - id: R4\n    text: \"Define five sentinel errors per prd011 R9.1-R9.9: ErrTemplateDirNotFound (directory does not exist), ErrTemplateDirNotReadable (permissions prevent reading), ErrTemplateNotFound (specific template by name not found), ErrMalformedTemplate (valid YAML but violates schema), ErrNoMatch (no templates matched task context). All must be checkable with errors.Is. Use base sentinel with fmt.Errorf wrapping to include contextual information (path, underlying OS error) per R9.4-R9.5.\"\n  - id: R5\n    text: \"Implement DiscoverTemplateDir(explicitPath string, configBlazesDir string, dataDir string) (string, error) per prd011 R3.1-R3.6. Precedence: (1) explicitPath if non-empty, (2) configBlazesDir if non-empty, (3) well-known path .crumbs/blazes/ relative to dataDir. Verify directory exists with os.Stat -- return ErrTemplateDirNotFound wrapping the attempted path if not found, ErrTemplateDirNotReadable wrapping path and OS error if permission denied. Discovery is read-only and must not create directories or modify the filesystem per R3.6.\"\n  - id: R6\n    text: \"Implement ListTemplates(templateDir string) ([]string, error) per prd011 R4.1-R4.6. Read directory entries with os.ReadDir. Include files with .yaml or .yml extension (case-insensitive check). Skip subdirectories and non-regular files per R4.5. Do not recurse into subdirectories per R4.3. Return absolute file paths sorted alphabetically by filename per R4.6. Return empty slice without error for empty directories per R4.4.\"\n  - id: R7\n    text: \"Implement ParseTemplates(filePaths []string) ([]BlazeMetadata, []string) per prd011 R5.1-R5.8. The second return value is a list of warning messages for skipped files. For each file: read contents, parse YAML into BlazeTemplate struct, validate schema (non-empty name per R1.4, non-empty description per R1.5, non-empty tags list per R1.6, each tag lowercase letters/numbers/hyphens per R1.7, parameter names non-empty and valid format per R2.3, parameter descriptions non-empty per R2.4, parameter types recognized per R2.5, parameter names unique within template per R2.8, default value matches parameter type per R2.9). Convert valid templates to BlazeMetadata with FilePath set to the source file. Skip files with invalid YAML syntax or schema violations -- record a warning with filename and error per R5.3-R5.4 -- and continue processing remaining files. Unknown YAML fields are silently ignored per R1.10/R5.8.\"\n\ndesign_decisions:\n  - id: D1\n    text: \"Place struct definitions in the package where existing entity structs live. The ARCHITECTURE document says pkg/schema/ (Decision 12), but PRDs reference pkg/types/. Check the actual codebase and follow the existing pattern. Name the file blaze.go in that package.\"\n  - id: D2\n    text: \"Place sentinel errors in the package where existing Cupboard and Table errors are defined. Follow the pattern from prd001-cupboard-core R7. Define base sentinels with errors.New; implementation code wraps them with fmt.Errorf and %w to add context (path, OS error) while remaining checkable with errors.Is.\"\n  - id: D3\n    text: \"Place parameter type constants (BlazeParamTypeText, BlazeParamTypeInteger, BlazeParamTypeBoolean, BlazeParamTypeList) and default directory constant (BlazeDefaultDir = \\\".crumbs/blazes\\\") in the constants package per ARCHITECTURE Decision 13. No magic string literals in implementation code.\"\n  - id: D4\n    text: \"Discovery, listing, and parsing are standalone functions in internal/blazes/, not part of the Table interface, per prd011 non-goals. Functions accept explicit parameters (paths, config values) rather than requiring a Cupboard reference, keeping them testable in isolation.\"\n  - id: D5\n    text: \"Use the YAML library already in go.mod (gopkg.in/yaml.v3 from cobra/viper dependency chain). Parse with yaml.Unmarshal into BlazeTemplate struct. The default yaml.Unmarshal behavior silently ignores unknown fields, satisfying prd011 R1.10 without additional configuration.\"\n\nacceptance_criteria:\n  - id: AC1\n    text: \"BlazeTemplate struct compiles with fields Name, Description, Tags, Parameters, TrailDefinition, Version, Priority, Author and correct yaml struct tags.\"\n  - id: AC2\n    text: \"BlazeParameter struct compiles with fields Name, Description, Type, Default and correct yaml struct tags.\"\n  - id: AC3\n    text: \"BlazeMetadata, TaskContext, SelectionResult, and ExtractedParameter structs compile with all fields listed in prd011 R5.7, R6.2, R7.7, R8.7 respectively.\"\n  - id: AC4\n    text: \"Five sentinel errors (ErrTemplateDirNotFound, ErrTemplateDirNotReadable, ErrTemplateNotFound, ErrMalformedTemplate, ErrNoMatch) are defined and checkable with errors.Is.\"\n  - id: AC5\n    text: \"DiscoverTemplateDir selects the correct directory following the three-level precedence chain: explicit path takes priority over config value, which takes priority over well-known path relative to dataDir.\"\n  - id: AC6\n    text: \"DiscoverTemplateDir returns ErrTemplateDirNotFound (wrapping path) for missing directories and ErrTemplateDirNotReadable (wrapping path and OS error) for permission-denied directories.\"\n  - id: AC7\n    text: \"ListTemplates returns .yaml and .yml files (case-insensitive) sorted alphabetically by filename, skips subdirectories and non-regular files, and returns an empty slice for empty directories.\"\n  - id: AC8\n    text: \"ParseTemplates produces BlazeMetadata for each valid template, skips malformed templates collecting warning strings, and ignores unknown YAML fields. Validation rejects: empty name, empty description, empty tags, invalid tag format, unrecognized parameter type, duplicate parameter names, type-mismatched defaults.\"","status":"open","priority":2,"issue_type":"task","owner":"petar.djukic@gmail.com","created_at":"2026-02-26T12:14:48Z","created_by":"petardjukic","updated_at":"2026-02-26T12:24:58Z","comments":[{"id":1,"issue_id":"generation-2026-02-26-07-10-53-33z","author":"petardjukic","text":"{\"caller\":\"measure\",\"started_at\":\"2026-02-26T12:14:48Z\",\"duration_s\":0,\"tokens\":{\"input\":147417,\"output\":13702,\"cache_creation\":131821,\"cache_read\":15594,\"cost_usd\":1.1742382500000001},\"loc_before\":{\"production\":0,\"test\":0},\"loc_after\":{\"production\":0,\"test\":0},\"diff\":{\"files\":0,\"insertions\":0,\"deletions\":0}}","created_at":"2026-02-26T12:14:49Z"}]}
{"id":"generation-2026-02-26-07-10-53-9el","title":"measure: plan on generation-2026-02-26-07-10-53 at 0f2d432e","description":"Measure invocation.\n\nBranch: generation-2026-02-26-07-10-53\nCommit: 0f2d432e9e99c9e61281b7ffd604f1dff34596a7\nExisting issues: 0\nMax new issues: 1","status":"closed","priority":2,"issue_type":"task","owner":"petar.djukic@gmail.com","created_at":"2026-02-26T12:11:03Z","created_by":"petardjukic","updated_at":"2026-02-26T12:14:51Z","closed_at":"2026-02-26T12:14:51Z","close_reason":"Closed","comments":[{"id":2,"issue_id":"generation-2026-02-26-07-10-53-9el","author":"petardjukic","text":"{\"caller\":\"measure\",\"started_at\":\"2026-02-26T12:11:03Z\",\"duration_s\":227,\"tokens\":{\"input\":147417,\"output\":13702,\"cache_creation\":131821,\"cache_read\":15594,\"cost_usd\":1.1742382500000001},\"loc_before\":{\"production\":0,\"test\":0},\"loc_after\":{\"production\":0,\"test\":0},\"diff\":{\"files\":0,\"insertions\":0,\"deletions\":0}}","created_at":"2026-02-26T12:14:50Z"},{"id":3,"issue_id":"generation-2026-02-26-07-10-53-9el","author":"petardjukic","text":"issues_created: 1, status: success","created_at":"2026-02-26T12:14:51Z"}]}
