{"id":"generation-2026-02-11-21-11-57-3ih","title":"Implement SQLite backend Attach/Detach/GetTable (prd001-cupboard-core R4-R5, prd002-sqlite-backend R1-R6)","description":"## Required Reading\n- docs/specs/product-requirements/prd001-cupboard-core.yaml (R4: Attach, R5: Detach, R2: GetTable)\n- docs/specs/product-requirements/prd002-sqlite-backend.yaml (R1: schema, R4: startup/Attach, R5: JSONL loading, R6: Detach/shutdown)\n- docs/specs/product-requirements/prd010-configuration-directories.yaml (R1-R4: config and data directories, JSONL file layout)\n- docs/specs/use-cases/rel01.0-uc001-cupboard-lifecycle.yaml (flow F1-F10, success criteria S1-S9)\n- docs/specs/test-suites/test-rel01.0-uc001-cupboard-lifecycle.yaml (test cases for lifecycle)\n- docs/ARCHITECTURE.md (§ SQLite Backend, § Design Decision 6: JSONL as source of truth)\n- pkg/types/ (all types created in task 0)\n\n## Files to Create/Modify\n- internal/sqlite/backend.go (create) — Backend struct implementing types.Cupboard; Attach (validate config, create DataDir, create empty JSONL files, open SQLite, create schema, load JSONL into SQLite), Detach (flush JSONL, close SQLite, delete cupboard.db), GetTable (return table accessor by name)\n- internal/sqlite/schema.go (create) — SQLite schema DDL for all tables (crumbs, trails, properties, categories, crumb_properties, metadata, links, stashes, stash_history); createSchema function\n- internal/sqlite/jsonl.go (create) — JSONL read/write helpers: readJSONLFile (parse lines into entities), writeJSONLFile (atomic write: temp file, fsync, rename), appendJSONLLine\n- internal/sqlite/table.go (create) — Generic table accessor struct implementing types.Table; Get, Set, Delete, Fetch methods that delegate to entity-specific SQL queries; ErrCupboardDetached guard on each operation\n- internal/sqlite/backend_test.go (create) — Unit tests for Attach, Detach, GetTable lifecycle: valid config attaches, invalid config returns error, double attach returns ErrAlreadyAttached, detach releases resources, operations after detach return ErrCupboardDetached, GetTable returns tables for all standard names, GetTable returns ErrTableNotFound for unknown name\n\n## Requirements\n- Backend struct holds *sql.DB, attached bool, sync.Mutex for lifecycle\n- Attach: validate Config, create DataDir (os.MkdirAll), create empty JSONL files if missing, open SQLite in DataDir/cupboard.db, create schema, load each JSONL file into SQLite, mark attached\n- Detach: check attached, flush pending JSONL writes, close SQLite, delete cupboard.db, mark detached\n- GetTable: check attached, return table accessor for standard table names, return ErrTableNotFound otherwise\n- Table accessor stubs: Get/Set/Delete/Fetch can return ErrNotFound/nil for now — full CRUD is a later task\n- JSONL files: crumbs.jsonl, trails.jsonl, links.jsonl, properties.jsonl, categories.jsonl, crumb_properties.jsonl, metadata.jsonl, stashes.jsonl, stash_history.jsonl\n- Atomic write pattern for JSONL: write to temp file, fsync, rename\n- UUID v7 generation for Set with empty ID (use google/uuid)\n\n## Design Decisions\n- Backend is a concrete struct, not an interface; it implements types.Cupboard\n- Factory: sqlite.NewBackend() returns *Backend\n- Table accessor is an internal struct; callers get types.Table interface\n- Schema uses TEXT for IDs (UUID v7 strings), TEXT for JSON-encoded fields, timestamps as TEXT (RFC3339)\n- JSONL loading skips empty lines and logs warnings for malformed lines (does not fail startup)\n\n## Acceptance Criteria\n- [ ] sqlite.NewBackend() returns a *Backend that satisfies types.Cupboard\n- [ ] Attach with valid config creates DataDir, JSONL files, cupboard.db\n- [ ] Attach with invalid config returns descriptive error\n- [ ] Double Attach returns ErrAlreadyAttached\n- [ ] GetTable returns types.Table for all 6 standard table names\n- [ ] GetTable returns ErrTableNotFound for unknown names\n- [ ] Detach deletes cupboard.db and marks backend as detached\n- [ ] Operations after Detach return ErrCupboardDetached\n- [ ] Idempotent Detach does not error\n- [ ] go build ./internal/sqlite succeeds\n- [ ] go test ./internal/sqlite/... passes all lifecycle tests","status":"open","priority":2,"issue_type":"task","owner":"petar.djukic@gmail.com","created_at":"2026-02-11T21:15:32.99678-05:00","created_by":"petardjukic","updated_at":"2026-02-11T21:15:32.99678-05:00","dependencies":[{"issue_id":"generation-2026-02-11-21-11-57-3ih","depends_on_id":"generation-2026-02-11-21-11-57-rgz","type":"blocks","created_at":"2026-02-11T21:15:33.09785-05:00","created_by":"petardjukic"}]}
{"id":"generation-2026-02-11-21-11-57-rgz","title":"Define core types and interfaces in pkg/types (prd001-cupboard-core R1-R3, R6-R8)","description":"## Required Reading\n- docs/specs/product-requirements/prd001-cupboard-core.yaml (R1: Config, R2: Cupboard interface, R3: Table interface, R6-R7: errors, R8: UUID v7)\n- docs/specs/product-requirements/prd003-crumbs-interface.yaml (Crumb struct, states, entity methods)\n- docs/specs/product-requirements/prd006-trails-interface.yaml (Trail struct, states)\n- docs/specs/product-requirements/prd007-links-interface.yaml (Link struct, link types)\n- docs/specs/product-requirements/prd004-properties-interface.yaml (Property, Category structs)\n- docs/specs/product-requirements/prd005-metadata-interface.yaml (Metadata struct)\n- docs/specs/product-requirements/prd008-stash-interface.yaml (Stash struct, stash types)\n- docs/ARCHITECTURE.md (§ Main Interfaces, § System Components, § Design Decision 9: ORM-style Table)\n\n## Files to Create/Modify\n- pkg/types/config.go (create) — Config struct with Backend and DataDir fields, config validation errors (ErrBackendEmpty, ErrBackendUnknown, ErrSyncStrategyUnknown, ErrBatchSizeInvalid, ErrBatchIntervalInvalid), Validate method\n- pkg/types/cupboard.go (create) — Cupboard interface (GetTable, Attach, Detach), Table interface (Get, Set, Delete, Fetch), cupboard lifecycle errors (ErrCupboardDetached, ErrAlreadyAttached, ErrTableNotFound)\n- pkg/types/table.go (create) — Table operation errors (ErrNotFound, ErrInvalidID, ErrInvalidData, ErrInvalidState, ErrInvalidTransition, ErrInvalidName, ErrPropertyNotFound, ErrTypeMismatch, ErrInvalidCategory, ErrInvalidStashType, ErrLockHeld, ErrNotLockHolder, ErrInvalidHolder, ErrAlreadyInTrail, ErrNotInTrail, ErrSchemaNotFound, ErrInvalidContent, ErrInvalidFilter), standard table name constants\n- pkg/types/crumb.go (create) — Crumb struct (CrumbID, Name, State, CreatedAt, UpdatedAt, Properties map), CrumbState type, state constants (draft, pending, ready, taken, pebble, dust), entity methods (SetState, Pebble, Dust, SetProperty, GetProperty, GetProperties, ClearProperty), valid state transitions map\n- pkg/types/trail.go (create) — Trail struct (TrailID, State, CreatedAt, CompletedAt), TrailState type, state constants (draft, pending, active, completed, abandoned), entity methods (Complete, Abandon)\n- pkg/types/link.go (create) — Link struct (LinkID, LinkType, FromID, ToID, CreatedAt), LinkType constants (belongs_to, child_of, branches_from, scoped_to)\n- pkg/types/property.go (create) — Property struct (PropertyID, Name, Description, ValueType, CreatedAt), Category struct (CategoryID, PropertyID, Name, Ordinal), ValueType constants (categorical, text, integer, boolean, timestamp, list)\n- pkg/types/metadata.go (create) — Metadata struct (MetadataID, CrumbID, TableName, Content, PropertyID, CreatedAt)\n- pkg/types/stash.go (create) — Stash struct (StashID, Name, StashType, Value, Version, CreatedAt, LastOperation, ChangedBy), StashType constants (resource, artifact, context, counter, lock), StashHistoryEntry struct\n\n## Requirements\n- Define all entity structs per their respective PRDs with exported fields and JSON tags\n- Define Config struct with Backend and DataDir fields per prd001 R1\n- Define Cupboard interface with GetTable, Attach, Detach per prd001 R2\n- Define Table interface with Get, Set (returns string, error), Delete, Fetch per prd001 R3\n- Define all sentinel errors per prd001 R7 (cupboard lifecycle errors in cupboard.go, table operation errors in table.go)\n- Define standard table name constants per prd001 R2.5 (crumbs, trails, properties, metadata, links, stashes)\n- Crumb entity methods must validate state transitions per prd003 state machine\n- Trail entity methods (Complete, Abandon) must validate state transitions per prd006\n- All ID fields are string (UUID v7 generated by backend, not by entity structs)\n\n## Design Decisions\n- Entity structs live in pkg/types so they are importable by both internal/ packages and external consumers\n- Entity methods (SetState, Pebble, Complete, etc.) modify the struct in memory; the caller persists via Table.Set (ORM-style pattern per Architecture Decision 9)\n- No constructor functions needed for entity structs; callers create struct literals\n- Properties map on Crumb is map[string]any (property name to value)\n- Config.Validate() is a method on Config, not a standalone function\n\n## Acceptance Criteria\n- [ ] All entity structs compile with correct field types and JSON tags\n- [ ] Cupboard and Table interfaces compile\n- [ ] Config.Validate() returns appropriate errors for invalid configs\n- [ ] Crumb.SetState validates transitions and returns ErrInvalidTransition for disallowed ones\n- [ ] Crumb.Pebble() and Crumb.Dust() return ErrInvalidTransition unless State is taken\n- [ ] Trail.Complete() and Trail.Abandon() return ErrInvalidTransition unless State is active\n- [ ] All sentinel errors are defined and checkable with errors.Is\n- [ ] Standard table name constants are defined\n- [ ] go build ./pkg/types succeeds","status":"closed","priority":2,"issue_type":"task","owner":"petar.djukic@gmail.com","created_at":"2026-02-11T21:15:32.86033-05:00","created_by":"petardjukic","updated_at":"2026-02-11T21:18:38.704978-05:00","closed_at":"2026-02-11T21:18:38.704978-05:00","close_reason":"Closed"}
